<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Price Change | Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#37003c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Material 3 Tonal Palette */
            --md-sys-color-primary: #37003c;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-secondary: #00ff85; /* FPL Green */
            --md-sys-color-tertiary: #ff005a;  /* FPL Pink */
            --md-sys-color-surface: #fdfbff;
            --md-sys-color-surface-variant: #f3f0f5;
            --md-sys-color-on-surface: #1c1b1f;
            --md-sys-color-outline: #79747e;
            
            --fpl-yellow: #fff9c4;
            --radius-xl: 28px;
            --shadow-2: 0 4px 12px rgba(55, 0, 60, 0.08);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--md-sys-color-surface); 
            margin: 0; 
            color: var(--md-sys-color-on-surface);
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }

        /* Expressive Timer Banner */
        .timer-banner { 
            background: var(--md-sys-color-primary); 
            color: white; 
            padding: 16px; 
            text-align: center; 
            font-size: 0.8rem; 
            font-weight: 900; 
            letter-spacing: 1px;
            position: sticky; 
            top: 0; 
            z-index: 100;
            border-bottom: 3px solid var(--md-sys-color-secondary);
        }

        /* M3 Header Section */
        .filter-container { 
            background: white; 
            padding: 32px 20px; 
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            box-shadow: var(--shadow-2);
            margin-bottom: 24px;
        }

        .page-title { 
            font-size: 1.8rem; 
            font-weight: 900; 
            color: var(--md-sys-color-primary); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 12px;
            margin-bottom: 4px;
        }

        .page-subtitle { 
            font-size: 0.85rem; 
            color: var(--md-sys-color-outline); 
            text-align: center;
            margin-bottom: 28px;
            font-weight: 500;
        }

        /* M3 Input Chips */
        .filter-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            max-width: 500px; 
            margin: 0 auto 12px; 
        }

        .filter-box { 
            background: var(--md-sys-color-surface-variant); 
            border-radius: 16px; 
            padding: 10px 16px; 
            display: flex; 
            flex-direction: column;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-box:focus-within {
            background: white;
            box-shadow: 0 0 0 2px var(--md-sys-color-primary);
        }

        .filter-box label { 
            font-size: 0.65rem; 
            font-weight: 800; 
            color: var(--md-sys-color-primary);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .filter-box select, .filter-box input { 
            border: none; 
            outline: none; 
            font-size: 1rem; 
            font-weight: 700;
            background: transparent; 
            color: var(--md-sys-color-on-surface);
            font-family: inherit;
        }

        /* Table Card */
        .section-label { 
            margin: 32px 20px 12px; 
            font-size: 1rem; 
            font-weight: 900; 
            color: var(--md-sys-color-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-card { 
            margin: 0 16px 32px; 
            background: white; 
            border-radius: var(--radius-xl); 
            overflow: hidden; 
            box-shadow: var(--shadow-2);
            border: 1px solid rgba(0,0,0,0.05);
        }

        table { width: 100%; border-collapse: collapse; }
        thead { background: #f8f7f9; color: var(--md-sys-color-outline); font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        th { padding: 16px; text-align: left; }
        .center { text-align: center; }

        /* Rows */
        .player-row { border-bottom: 1px solid var(--md-sys-color-surface-variant); transition: background 0.2s; }
        .player-name { font-weight: 800; font-size: 0.95rem; color: var(--md-sys-color-on-surface); }
        .team-name { color: var(--md-sys-color-outline); font-size: 0.75rem; font-weight: 600; }
        
        .price-pill {
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 800;
            font-size: 0.85rem;
            background: var(--md-sys-color-surface-variant);
        }

        .date-header { background: var(--fpl-yellow); }
        .date-header td { padding: 14px 20px; font-weight: 900; color: var(--md-sys-color-primary); font-size: 0.85rem; }
        .latest-pill { background: var(--md-sys-color-primary); color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.6rem; margin-left: 8px; vertical-align: middle; }

        /* Shimmer Loading */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>
    <main>
        <div class="timer-banner">
            <span class="material-symbols-rounded" style="vertical-align: middle; font-size: 18px; margin-right: 4px;">history</span>
            NEXT UPDATE IN: <span id="price-timer">00:00:00</span>
        </div>

        <div class="filter-container">
            <div class="page-title">
                <span class="material-symbols-rounded" style="font-size: 32px; color: var(--md-sys-color-secondary); font-variation-settings: 'FILL' 1;">analytics</span>
                Market Data
            </div>
            <p class="page-subtitle">Real-time price changes & transfer predictions</p>
            
            <div class="filter-grid">
                <div class="filter-box">
                    <label>Trend</label>
                    <select id="dirFilter" onchange="renderAll()">
                        <option value="all">All Trends</option>
                        <option value="rise">Risers</option>
                        <option value="fall">Fallers</option>
                    </select>
                </div>
                <div class="filter-box">
                    <label>Club</label>
                    <select id="teamFilter" onchange="renderAll()">
                        <option value="all">All Clubs</option>
                    </select>
                </div>
            </div>
            <div class="filter-grid" style="grid-template-columns: 1fr;">
                <div class="filter-box">
                    <label>Search Scout</label>
                    <input type="text" id="mainSearch" placeholder="Filter by player or team..." onkeyup="renderAll()">
                </div>
            </div>
        </div>

        <div class="section-label">Price History</div>
        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50%;">Player</th>
                        <th class="center">Old</th>
                        <th class="center">New</th>
                        <th class="center">Var</th>
                    </tr>
                </thead>
                <tbody id="daily-changes-body">
                    <tr><td colspan="4" style="padding:20px;"><div class="shimmer" style="height:20px; width:100%;"></div></td></tr>
                    <tr><td colspan="4" style="padding:20px;"><div class="shimmer" style="height:20px; width:80%;"></div></td></tr>
                </tbody>
            </table>
        </div>

        <div class="section-label">Live Predictions</div>
        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th style="width: 55%;">Player</th>
                        <th class="center">Target %</th>
                        <th class="center">Cost</th>
                    </tr>
                </thead>
                <tbody id="predictions-body"></tbody>
            </table>
        </div>
    </main>

    <script>
        const PROXY = "/.netlify/functions/fpl-proxy?endpoint=bootstrap-static/";
        const HISTORY_KEY = 'kopala_price_history_v3';
        let playerData = [], teamMap = {};

        async function init() {
            try {
                const res = await fetch(PROXY);
                const data = await res.json();
                
                const teamSelect = document.getElementById('teamFilter');
                data.teams.forEach(t => { 
                    teamMap[t.id] = t.short_name;
                    let opt = document.createElement('option');
                    opt.value = t.id; opt.innerText = t.name;
                    teamSelect.appendChild(opt);
                });

                playerData = data.elements.map(p => {
                    let net = (p.transfers_in_event - p.transfers_out_event) * 0.8;
                    let thresh = (7200 + (parseFloat(p.selected_by_percent) * 1500)) * 0.8;
                    if (p.status !== 'a') thresh *= 3.5;
                    let target = (net / thresh) * 100;

                    return {
                        id: p.id,
                        name: p.web_name,
                        team: p.team,
                        teamCode: p.team_code,
                        price: (p.now_cost/10).toFixed(1),
                        target: target.toFixed(1),
                        rawChange: p.cost_change_event 
                    };
                });

                saveDailyHistory();
                renderAll();
                setInterval(updateTimer, 1000);
            } catch (e) { 
                console.error("Error:", e); 
                document.getElementById('daily-changes-body').innerHTML = '<tr><td colspan="4" class="center" style="padding:40px;">Failed to load data.</td></tr>';
            }
        }

        function saveDailyHistory() {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}');
            const today = new Date().toISOString().split('T')[0];
            const todaysMovers = playerData.filter(p => p.rawChange !== 0).map(p => ({
                name: p.name,
                team: teamMap[p.team],
                teamId: p.team,
                teamCode: p.teamCode,
                old: (parseFloat(p.price) - (p.rawChange/10)).toFixed(1),
                new: p.price,
                dir: p.rawChange > 0 ? 'rise' : 'fall'
            }));
            if (todaysMovers.length > 0) { history[today] = todaysMovers; }
            const dates = Object.keys(history).sort().reverse().slice(0, 5);
            const trimmed = {};
            dates.forEach(d => trimmed[d] = history[d]);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmed));
        }

        function renderAll() {
            renderDailyChanges();
            renderPredictions();
        }

        function renderDailyChanges() {
            const container = document.getElementById('daily-changes-body');
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}');
            const sortedDates = Object.keys(history).sort().reverse();
            const search = document.getElementById('mainSearch').value.toLowerCase();
            const teamF = document.getElementById('teamFilter').value;
            const dirF = document.getElementById('dirFilter').value;
            
            let html = '';
            sortedDates.forEach((date, index) => {
                let entries = history[date].filter(p => {
                    return p.name.toLowerCase().includes(search) && (teamF === 'all' || String(p.teamId) === teamF) && (dirF === 'all' || p.dir === dirF);
                });

                if (entries.length > 0) {
                    html += `<tr class="date-header"><td colspan="4">${date} ${index === 0 ? '<span class="latest-pill">LATEST</span>' : ''}</td></tr>`;
                    entries.forEach(p => {
                        const icon = p.dir === 'rise' ? 'trending_up' : 'trending_down';
                        const color = p.dir === 'rise' ? 'var(--md-sys-color-secondary)' : 'var(--md-sys-color-tertiary)';
                        html += `
                        <tr class="player-row">
                            <td style="padding:16px; display:flex; align-items:center; gap:12px;">
                                <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.teamCode}-66.webp" style="width:30px;">
                                <div><div class="player-name">${p.name}</div><div class="team-name">${p.team}</div></div>
                            </td>
                            <td class="center" style="color:var(--md-sys-color-outline); font-weight:700;">£${p.old}</td>
                            <td class="center"><span class="price-pill">£${p.new}</span></td>
                            <td class="center"><span class="material-symbols-rounded" style="color:${color}; font-weight:900;">${icon}</span></td>
                        </tr>`;
                    });
                }
            });
            container.innerHTML = html || '<tr><td colspan="4" class="center" style="padding:30px;">No matches found.</td></tr>';
        }

        function renderPredictions() {
            const container = document.getElementById('predictions-body');
            const search = document.getElementById('mainSearch').value.toLowerCase();
            const teamF = document.getElementById('teamFilter').value;
            
            let filtered = playerData.filter(p => {
                return p.name.toLowerCase().includes(search) && (teamF === 'all' || String(p.team) === teamF);
            }).sort((a,b) => b.target - a.target).slice(0, 20);

            container.innerHTML = filtered.map(p => {
                let color = p.target >= 90 ? 'var(--md-sys-color-secondary)' : (p.target <= -90 ? 'var(--md-sys-color-tertiary)' : 'inherit');
                return `
                <tr class="player-row">
                    <td style="padding:16px; display:flex; align-items:center; gap:12px;">
                        <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.teamCode}-66.webp" style="width:30px;">
                        <div><div class="player-name">${p.name}</div><div class="team-name">${teamMap[p.team]}</div></div>
                    </td>
                    <td class="center" style="font-weight:900; color:${color}">${p.target}%</td>
                    <td class="center"><span class="price-pill" style="background:var(--md-sys-color-primary); color:white;">£${p.price}</span></td>
                </tr>`;
            }).join('');
        }

        function updateTimer() {
            const now = new Date();
            let t = new Date();
            t.setUTCHours(1, 30, 0, 0);
            if (now > t) t.setUTCDate(t.getUTCDate() + 1);
            const d = t - now;
            const h = String(Math.floor(d / 3600000)).padStart(2,'0'), 
                  m = String(Math.floor((d%3600000)/60000)).padStart(2,'0'), 
                  s = String(Math.floor((d%60000)/1000)).padStart(2,'0');
            document.getElementById('price-timer').innerText = `${h}:${m}:${s}`;
        }

        init();
    </script>



    <script src="nav.js"></script>
    <div id="footer-placeholder"></div>
<script src="footer.js"></script>
</body>
</html>
