<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Price Change | Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#37003c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --fpl-purple: #37003c;
            --fpl-green: #00ff85;
            --fpl-pink: #ff005a;
            --fpl-dark: #111827;
            --fpl-yellow: #fff9c4;
            --bg-light: #f0f2f5;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); margin: 0; padding: 0; color: #1a1a1a; }
        
        .timer-banner { background: var(--fpl-purple); color: white; padding: 12px; text-align: center; font-size: 0.7rem; font-weight: 700; position: sticky; top: 0; z-index: 100; }

        /* Filter Section (Matching Photo) */
        .filter-container { background: white; padding: 25px 20px; text-align: center; border-bottom: 1px solid #eee; }
        .page-title { font-size: 1.4rem; font-weight: 800; color: var(--fpl-purple); display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .page-subtitle { font-size: 0.75rem; color: #666; margin-bottom: 20px; line-height: 1.5; max-width: 400px; margin-left: auto; margin-right: auto; }
        
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-width: 500px; margin: 0 auto 12px; }
        .filter-box { background: white; border: 1.5px solid #e5e7eb; border-radius: 12px; padding: 10px 15px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .filter-box label { font-size: 0.75rem; font-weight: 800; margin-right: 10px; color: #4b5563; }
        .filter-box select, .filter-box input { border: none; outline: none; font-size: 0.85rem; width: 100%; font-family: inherit; background: transparent; cursor: pointer; }

        /* Table Styling */
        .section-label { margin: 20px 15px 10px; font-size: 0.8rem; font-weight: 900; color: var(--fpl-purple); text-transform: uppercase; letter-spacing: 1px; }
        .table-card { margin: 0 15px 30px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--fpl-dark); color: white; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.8px; }
        th { padding: 16px 12px; text-align: left; }
        .center { text-align: center; }

        /* Date Header Rows */
        .date-header { background: var(--fpl-yellow); border-bottom: 1px solid #e5e7eb; }
        .date-header td { padding: 12px 15px; font-weight: 800; color: var(--fpl-purple); font-size: 0.85rem; }
        .latest-pill { background: #ffcc00; color: black; padding: 2px 8px; border-radius: 8px; font-size: 0.65rem; margin-left: 10px; font-weight: 900; }

        .player-row { border-bottom: 1px solid #f3f4f6; }
        .player-name { font-weight: 700; font-size: 0.9rem; color: #111827; }
        .team-name { color: #6b7280; font-size: 0.8rem; font-weight: 500; }
        .price-old { color: #9ca3af; font-size: 0.85rem; }
        .price-new { font-weight: 800; color: var(--fpl-dark); font-size: 0.9rem; }
        
        .prediction-target { font-weight: 800; font-size: 0.85rem; }
    </style>
</head>
<body>
<div id="nav-placeholder"></div>
<main>
    <div class="timer-banner">NEXT FPL PRICE UPDATE IN: <span id="price-timer">00:00:00</span></div>

    <div class="filter-container">
        <div class="page-title">
            <div style="width:5px; height:24px; background:var(--fpl-green); border-radius: 2px;"></div>
            Price Changes
        </div>
        <p class="page-subtitle">Page updates instantly after any price changes occur<br>(usually at 1:30 am GMT)</p>
        
        <div class="filter-grid">
            <div class="filter-box"><label>Direction</label><select id="dirFilter" onchange="renderAll()"><option value="all">...</option><option value="rise">Rise</option><option value="fall">Fall</option></select></div>
            <div class="filter-box"><label>Team</label><select id="teamFilter" onchange="renderAll()"><option value="all">...</option></select></div>
        </div>
        <div class="filter-grid" style="grid-template-columns: 1fr;">
            <div class="filter-box"><label>Search</label><input type="text" id="mainSearch" placeholder="Player / team / price..." onkeyup="renderAll()"></div>
        </div>
    </div>

    <div class="section-label">Market History (Last 5 Days)</div>
    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th style="width: 40%;">Player</th>
                    <th style="width: 25%;">Team</th>
                    <th class="center">Old</th>
                    <th class="center">New</th>
                    <th class="center">Dir</th>
                </tr>
            </thead>
            <tbody id="daily-changes-body"></tbody>
        </table>
    </div>

    
</main>

<script>
    const PROXY = "/.netlify/functions/fpl-proxy?endpoint=bootstrap-static/";
    const HISTORY_KEY = 'kopala_price_history_v3';
    let playerData = [], teamMap = {};

    async function init() {
        try {
            const res = await fetch(PROXY);
            const data = await res.json();
            
            // Map Teams
            const teamSelect = document.getElementById('teamFilter');
            data.teams.forEach(t => { 
                teamMap[t.id] = t.short_name;
                let opt = document.createElement('option');
                opt.value = t.id; opt.innerText = t.name;
                teamSelect.appendChild(opt);
            });

            // Process Players
            playerData = data.elements.map(p => {
                let net = (p.transfers_in_event - p.transfers_out_event) * 0.8;
                let thresh = (7200 + (parseFloat(p.selected_by_percent) * 1500)) * 0.8;
                if (p.status !== 'a') thresh *= 3.5;
                let target = (net / thresh) * 100;

                return {
                    id: p.id,
                    name: p.web_name,
                    team: p.team,
                    teamCode: p.team_code,
                    price: (p.now_cost/10).toFixed(1),
                    target: target.toFixed(1),
                    rawChange: p.cost_change_event 
                };
            });

            saveDailyHistory();
            renderAll();
            setInterval(updateTimer, 1000);
        } catch (e) { console.error("Error loading FPL data:", e); }
    }

    function saveDailyHistory() {
        let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}');
        const today = new Date().toISOString().split('T')[0];

        const todaysMovers = playerData.filter(p => p.rawChange !== 0).map(p => ({
            name: p.name,
            team: teamMap[p.team],
            teamId: p.team,
            teamCode: p.teamCode,
            old: (parseFloat(p.price) - (p.rawChange/10)).toFixed(1),
            new: p.price,
            dir: p.rawChange > 0 ? 'rise' : 'fall'
        }));

        if (todaysMovers.length > 0) { history[today] = todaysMovers; }

        const dates = Object.keys(history).sort().reverse().slice(0, 5);
        const trimmedHistory = {};
        dates.forEach(d => trimmedHistory[d] = history[d]);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmedHistory));
    }

    function renderAll() {
        renderDailyChanges();
        renderPredictions();
    }

    function saveDailyHistory() {
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}');
    // We'll use a secondary key to track which specific changes we've already logged
    const LOGGED_CHANGES_KEY = 'kopala_logged_changes';
    let loggedChanges = JSON.parse(localStorage.getItem(LOGGED_CHANGES_KEY) || '[]');
    
    const today = new Date().toISOString().split('T')[0];

    // 1. Identify players with changes in the current API response
    const todaysMovers = playerData.filter(p => p.rawChange !== 0).map(p => ({
        id: p.id,
        name: p.name,
        team: teamMap[p.team],
        teamId: p.team,
        teamCode: p.teamCode,
        old: (parseFloat(p.price) - (p.rawChange/10)).toFixed(1),
        new: p.price,
        dir: p.rawChange > 0 ? 'rise' : 'fall'
    }));

    // 2. Filter out movers we have already recorded in the past
    // A change is unique if the "Player ID" + "New Price" combo is new
    const newMoversForToday = todaysMovers.filter(mover => {
        const changeId = `${mover.id}_${mover.new}`;
        if (loggedChanges.includes(changeId)) {
            return false; // Already recorded this price change previously
        }
        loggedChanges.push(changeId);
        return true;
    });

    // 3. Only update the history object if there are actually NEW changes today
    if (newMoversForToday.length > 0) {
        // If we already have entries for today, merge them; otherwise create new array
        history[today] = [...(history[today] || []), ...newMoversForToday];
        
        // Keep loggedChanges list from growing infinitely (keep last 200 changes)
        if (loggedChanges.length > 200) loggedChanges = loggedChanges.slice(-200);
        
        // Save back to localStorage
        localStorage.setItem(LOGGED_CHANGES_KEY, JSON.stringify(loggedChanges));
    }

    // 4. Standard cleanup: keep only last 5 days and save
    const dates = Object.keys(history).sort().reverse().slice(0, 5);
    const trimmedHistory = {};
    dates.forEach(d => trimmedHistory[d] = history[d]);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmedHistory));
}
    function renderPredictions() {
        const container = document.getElementById('predictions-body');
        const search = document.getElementById('mainSearch').value.toLowerCase();
        const teamF = document.getElementById('teamFilter').value;
        
        let filtered = playerData.filter(p => {
            return p.name.toLowerCase().includes(search) && (teamF === 'all' || String(p.team) === teamF);
        }).sort((a,b) => b.target - a.target).slice(0, 20);

        container.innerHTML = filtered.map(p => `
            <tr class="player-row">
                <td style="padding:15px; display:flex; align-items:center; gap:10px;">
                    <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.teamCode}-66.webp" style="width:25px;">
                    <div>
                        <div class="player-name">${p.name}</div>
                        <div class="team-name">${teamMap[p.team]}</div>
                    </div>
                </td>
                <td class="center prediction-target" style="color:${p.target >= 90 ? 'var(--fpl-green)' : (p.target <= -90 ? 'var(--fpl-pink)' : '#111')}">
                    ${p.target}%
                </td>
                <td class="center price-new">Â£${p.price}</td>
            </tr>
        `).join('');
    }

    function updateTimer() {
        const now = new Date();
        let t = new Date();
        t.setUTCHours(1, 30, 0, 0);
        if (now > t) t.setUTCDate(t.getUTCDate() + 1);
        const d = t - now;
        const h = String(Math.floor(d / 3600000)).padStart(2,'0'), 
              m = String(Math.floor((d%3600000)/60000)).padStart(2,'0'), 
              s = String(Math.floor((d%60000)/1000)).padStart(2,'0');
        document.getElementById('price-timer').innerText = `${h}:${m}:${s}`;
    }

    init();
</script>


    <script src="nav.js"></script>
    <div id="footer-placeholder"></div>
<script src="footer.js"></script>
</body>
</html>
