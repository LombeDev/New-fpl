<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Price Change | Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#37003c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">


    <style>
        :root {
            --dark-navy: #1a1e36;
            --fpl-green: #00ff85;
            --fpl-purple: #37003c;
            --up-green: #2ecc71;
            --down-red: #e74c3c;
            --bg-gray: #f4f7f6;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: var(--fpl-purple);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .up-arrow { color: var(--up-green); }

        /* Filters Section */
        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }

        select, input {
            padding: 12px 15px;
            border-radius: 25px;
            border: 1px solid #ddd;
            background: #fff;
            font-size: 14px;
            outline: none;
            transition: border 0.2s;
        }

        select:focus, input:focus {
            border-color: var(--fpl-purple);
        }

        .search-container {
            margin-top: 15px;
            width: 100%;
        }

        .search-container input {
            width: 100%;
            box-sizing: border-box;
        }

        .count-text {
            text-align: center;
            color: #888;
            font-size: 13px;
            margin: 15px 0;
        }

        /* Table Styling */
        .table-wrapper {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            background-color: var(--dark-navy);
            color: white;
            padding: 15px;
            text-align: left;
            font-size: 14px;
        }

        .date-header {
            background-color: #fff9db;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 14px;
            color: #444;
        }

        .latest-badge {
            background: #ffcc00;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 10px;
            margin-left: 10px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .dir-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }

        .up { background-color: var(--up-green); }
        .down { background-color: var(--down-red); }

        .loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>

<div class="container">
    <header>
        <h1><span class="up-arrow">▲</span> Price Changes</h1>
        <p style="font-size: 12px; color: #666;">Page updates instantly after changes (approx. 1:30 AM GMT)</p>
    </header>

    <div class="filters">
        <div class="filter-group">
            <label>Direction</label>
            <select id="directionFilter">
                <option value="any">Any</option>
                <option value="up">Rise</option>
                <option value="down">Fall</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Team</label>
            <select id="teamFilter">
                <option value="any">Any Team</option>
            </select>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search Player / team / price...">
    </div>

    <p class="count-text" id="countLabel">0 shown</p>

    <div class="table-wrapper">
        <div id="tableContent">
            <div class="loading">Fetching live data...</div>
        </div>
    </div>
</div>

<script>
    let allPlayers = [];
    // This points to your Netlify Function
    const API_URL = "/.netlify/functions/fpl-proxy";

    async function init() {
        try {
            // 1. Check Browser Cache (Session Storage)
            const cached = sessionStorage.getItem('fpl_cache');
            if (cached) {
                processData(JSON.parse(cached));
            }

            // 2. Fetch from Netlify Function (which has Edge Caching)
            const response = await fetch(API_URL);
            const data = await response.json();
            
            // Update cache and UI
            sessionStorage.setItem('fpl_cache', JSON.stringify(data));
            processData(data);

        } catch (error) {
            console.error("Fetch failed:", error);
            document.getElementById('tableContent').innerHTML = "<div class='loading'>Error loading data. Make sure Netlify Functions are deployed.</div>";
        }
    }

    function processData(data) {
        // Map FPL raw data to a clean format
        allPlayers = data.elements
            .filter(p => p.cost_change_event !== 0) // Only get players with recent changes
            .map(p => ({
                name: p.web_name,
                team: data.teams.find(t => t.id === p.team).name,
                old: (p.now_cost - p.cost_change_event) / 10,
                new: p.now_cost / 10,
                dir: p.cost_change_event > 0 ? 'up' : 'down'
            }));

        // Populate Teams dropdown dynamically
        const teamSelect = document.getElementById('teamFilter');
        const teams = [...new Set(allPlayers.map(p => p.team))].sort();
        
        // Clear previous except first
        teamSelect.innerHTML = '<option value="any">Any Team</option>';
        teams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.innerText = t;
            teamSelect.appendChild(opt);
        });

        renderTable(allPlayers);
    }

    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const dir = document.getElementById('directionFilter').value;
        const team = document.getElementById('teamFilter').value;

        const filtered = allPlayers.filter(p => {
            const matchSearch = p.name.toLowerCase().includes(search) || p.team.toLowerCase().includes(search);
            const matchDir = dir === 'any' || p.dir === dir;
            const matchTeam = team === 'any' || p.team === team;
            return matchSearch && matchDir && matchTeam;
        });

        renderTable(filtered);
    }

    function renderTable(data) {
        const container = document.getElementById('tableContent');
        const countLabel = document.getElementById('countLabel');
        countLabel.innerText = `${data.length} shown`;

        if (data.length === 0) {
            container.innerHTML = "<div class='loading'>No changes found.</div>";
            return;
        }

        let html = `
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Old</th>
                        <th>New</th>
                        <th>Dir</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="date-header">Price Changes Today <span class="latest-badge">LATEST</span></td></tr>
        `;

        data.forEach(p => {
            html += `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.team}</td>
                    <td>£${p.old.toFixed(1)}</td>
                    <td>£${p.new.toFixed(1)}</td>
                    <td><div class="dir-icon ${p.dir}">${p.dir === 'up' ? '▲' : '▼'}</div></td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // Event Listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('directionFilter').addEventListener('change', applyFilters);
    document.getElementById('teamFilter').addEventListener('change', applyFilters);

    init();
</script>


<script src="nav.js"></script>
<div id="footer-placeholder"></div>
<script src="footer.js"></script>
</body>
</html>
