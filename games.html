<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Games - Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5323/5323982.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="nav.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Games - Kopala FPL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #2563eb;
            --fpl-green: #00ff85;
            --border-color: #e2e8f0;
            --done-badge: #1e3a8a;
            --live-badge: #e90052; 
            --expand-mint: #f1f5f9;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --expand-mint: #2d3748;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            transition: background 0.3s ease;
        }

        /* --- TOP NAV --- */
        .top-nav {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: var(--card-bg); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 3000;
        }
        .logo-container { font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; }
        .logo-container span { color: var(--fpl-green); }
        .nav-right { display: flex; gap: 15px; }
        .nav-icon-btn { font-size: 1.2rem; color: var(--text-main); cursor: pointer; }

        /* --- CONTENT --- */
        .page-content { padding-top: 70px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; padding-left: 10px; padding-right: 10px; }
        
        .gw-tabs { display: flex; gap: 10px; margin: 15px 0; }
        .gw-tab {
            flex: 1; padding: 12px; text-align: center; border-radius: 8px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            font-size: 0.8rem; font-weight: 800; cursor: pointer; color: var(--text-muted);
        }
        .gw-tab.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }

        .gw-header { border-left: 4px solid var(--fpl-green); padding-left: 10px; margin-bottom: 15px; font-size: 1.1rem; font-weight: 800; }

        /* MATCH CARD */
        .m-card { background: var(--card-bg); border-radius: 15px; margin-bottom: 15px; overflow: hidden; border: 1px solid var(--border-color); }
        .m-main { display: flex; align-items: center; justify-content: space-between; padding: 15px 10px; }
        .team-box { flex: 1; text-align: center; }
        .kit-img { width: 40px; height: auto; margin-bottom: 5px; }
        .team-name { font-weight: 800; font-size: 0.75rem; display: block; text-transform: uppercase; }
        .score-center { flex: 1.2; text-align: center; }
        .status-badge { color: #fff; padding: 3px 10px; border-radius: 4px; font-size: 0.6rem; font-weight: 900; display: inline-block; margin-bottom: 8px; text-transform: uppercase; }
        .badge-done { background: var(--done-badge); }
        .badge-live { background: var(--live-badge); animation: pulse 2s infinite; }
        .badge-sched { background: var(--text-muted); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .score-val { font-size: 1.8rem; font-weight: 900; letter-spacing: 4px; }
        
        .m-footer { background: var(--bg-color); padding: 10px; font-size: 0.65rem; text-align: center; border-top: 1px solid var(--border-color); color: var(--text-muted); }
        .bonus-player { margin: 0 4px; font-weight: 700; color: var(--text-main); }
        .pts-pill { background: var(--primary-blue); color: #fff; padding: 1px 4px; border-radius: 3px; margin-left: 3px; }

        .expand-btn { background: var(--expand-mint); border: none; width: 100%; padding: 12px; font-size: 0.7rem; font-weight: 700; color: var(--text-main); cursor: pointer; border-top: 1px solid var(--border-color); }
        .drawer { display: none; padding: 5px 15px; background: var(--card-bg); }
        .drawer.active { display: block; }
        .own-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; }
        .live-pts-badge { background: var(--fpl-green); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 900; }
    </style>
</head>
<body>

    <div id="nav-placeholder"></div>

    <main class="page-content">
        <div class="gw-tabs">
            <div id="tab-curr" class="gw-tab active" onclick="switchGW('curr')">Current GW</div>
            <div id="tab-next" class="gw-tab" onclick="switchGW('next')">Next GW</div>
        </div>
        <div id="gw-display-header" class="gw-header">Loading Gameweek...</div>
        <div id="games-list"></div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        let players = [];
        let teams = [];
        let currentFixtures = [];
        let nextFixtures = [];
        let currentGWId = 1;
        const PROXY = "/.netlify/functions/fpl-proxy?endpoint=";

        async function init() {
            const icon = document.getElementById('refresh-icon');
            if(icon) icon.classList.add('fa-spin');
            
            try {
                const bootRes = await fetch(`${PROXY}bootstrap-static/`);
                const bootData = await bootRes.json();
                players = bootData.elements;
                teams = bootData.teams;
                currentGWId = bootData.events.find(e => e.is_current)?.id || 1;

                const [currRes, nextRes] = await Promise.all([
                    fetch(`${PROXY}fixtures/?event=${currentGWId}`),
                    fetch(`${PROXY}fixtures/?event=${currentGWId + 1}`)
                ]);

                currentFixtures = await currRes.json();
                nextFixtures = await nextRes.json();

                switchGW('curr'); 
            } catch (err) {
                console.error(err);
                document.getElementById('gw-display-header').innerText = "Failed to load fixtures";
            } finally {
                if(icon) icon.classList.remove('fa-spin');
            }
        }

        function switchGW(type) {
            const isCurr = type === 'curr';
            document.getElementById('tab-curr').classList.toggle('active', isCurr);
            document.getElementById('tab-next').classList.toggle('active', !isCurr);
            
            const targetGW = isCurr ? currentGWId : currentGWId + 1;
            document.getElementById('gw-display-header').innerText = `Gameweek ${targetGW}`;
            renderGames(isCurr ? currentFixtures : nextFixtures);
        }

        function renderGames(fixtures) {
            const list = document.getElementById('games-list');
            if (!fixtures || fixtures.length === 0) {
                list.innerHTML = "<p style='text-align:center'>No fixtures found.</p>";
                return;
            }

            list.innerHTML = fixtures.map(f => {
                const hTeam = teams.find(t => t.id === f.team_h) || {short_name: '???', code: 0};
                const aTeam = teams.find(t => t.id === f.team_a) || {short_name: '???', code: 0};
                const isLive = f.started && !f.finished;

                // Bonus/BPS logic
                let bonusMarkup = "";
                const bonusStat = f.stats.find(s => s.identifier === (f.finished ? "bonus" : "bps"));
                if (bonusStat) {
                    const top3 = [...bonusStat.h, ...bonusStat.a].sort((a,b) => b.value - a.value).slice(0,3);
                    bonusMarkup = top3.map((p, i) => {
                        const name = players.find(x => x.id === p.element)?.web_name || "Unknown";
                        return `<span class="bonus-player">${name}<span class="pts-pill">${f.finished ? p.value : (3-i)}</span></span>`;
                    }).join('');
                }

                return `
                    <div class="m-card">
                        <div class="m-main">
                            <div class="team-box">
                                <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${hTeam.code}-66.png" class="kit-img">
                                <span class="team-name">${hTeam.short_name}</span>
                            </div>
                            <div class="score-center">
                                <div class="status-badge ${f.finished ? 'badge-done' : (isLive ? 'badge-live' : 'badge-sched')}">
                                    ${f.finished ? 'Finished' : (isLive ? 'Live' : 'Scheduled')}
                                </div>
                                <div class="score-val">${f.team_h_score ?? 0} : ${f.team_a_score ?? 0}</div>
                            </div>
                            <div class="team-box">
                                <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${aTeam.code}-66.png" class="kit-img">
                                <span class="team-name">${aTeam.short_name}</span>
                            </div>
                        </div>
                        <div class="m-footer">
                            <span style="opacity:0.7">${f.finished ? 'BONUS' : 'BPS TOP 3'}</span><br>${bonusMarkup || '---'}
                        </div>
                        <button class="expand-btn" onclick="toggleDrawer(${f.id})">Expand Stats <i class="fa-solid fa-chevron-down"></i></button>
                        <div class="drawer" id="drawer-${f.id}">
                            <div style="padding:10px; text-align:center; font-size:0.7rem; color:var(--text-muted)">Top Owned Players Live Pts</div>
                            ${players.filter(p => p.team === f.team_h || p.team === f.team_a)
                                .sort((a,b) => b.selected_by_percent - a.selected_by_percent)
                                .slice(0,5).map(p => `
                                <div class="own-row">
                                    <span>${p.web_name} <small>(${p.selected_by_percent}%)</small></span>
                                    <span class="live-pts-badge">${f.started ? calculateLivePoints(p.id, f) : 0}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }).join('');
        }

        function calculateLivePoints(pid, fixture) {
            let pts = 0;
            const p = players.find(x => x.id === pid);
            if (!p || !fixture.started) return 0;
            pts += 2; // Appearance
            fixture.stats.forEach(s => {
                const entry = s.h.find(item => item.element === pid) || s.a.find(item => item.element === pid);
                if (entry) {
                    if (s.identifier === 'goals_scored') pts += (p.element_type <= 2 ? 6 : p.element_type === 3 ? 5 : 4) * entry.value;
                    if (s.identifier === 'assists') pts += 3 * entry.value;
                    if (s.identifier === 'yellow_cards') pts -= 1 * entry.value;
                    if (s.identifier === 'red_cards') pts -= 3 * entry.value;
                }
            });
            return pts;
        }

        function toggleDrawer(id) {
            const drawer = document.getElementById(`drawer-${id}`);
            drawer.classList.toggle('active');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }

        init();
    </script>
    <script src="footer.js"></script>
    <script src="nav.js"></script>
</body>
</html>

