<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Games - Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5323/5323982.png">
    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
</head>
<body class="dark-mode">

    <header class="top-nav">
        <div class="nav-icon-btn"><i class="fa-solid fa-circle-user"></i></div>
        <div class="logo-container">Kopala<span>â–²</span>FPL</div>
        <div style="display:flex; gap:5px;">
            <div class="nav-icon-btn" onclick="init()"><i class="fa-solid fa-rotate" id="refresh-icon"></i></div>
            <div class="nav-icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-sun" id="theme-icon"></i></div>
        </div>
    </header>

    <main class="page-content">
        <div class="gw-tabs">
            <div id="tab-curr" class="gw-tab active" onclick="switchGW('curr')">Current GW</div>
            <div id="tab-next" class="gw-tab" onclick="switchGW('next')">Next GW</div>
        </div>
        <div id="gw-display-header" class="gw-header">Loading...</div>
        <div id="games-list"></div>
    </main>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="leagues.html" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item"><i class="fa-solid fa-tags"></i><span>Prices</span></a>
        <a href="games.html" class="nav-item active"><i class="fa-solid fa-futbol"></i><span>Games</span></a>
        <a href="10k.html" class="nav-item"><i class="fa fa-bar-chart"></i><span>You vs 10k</span></a>
        <a href="#" class="nav-item"><i class="fa fa-question-circle"></i><span>About</span></a>
        <a href="https://wa.me/260964836842" class="nav-item"><i class="fa fa-comments"></i><span>Support</span></a>
        <a href="#" class="nav-item"><i class="fa fa-ellipsis-h"></i><span>More</span></a>
    </nav>

    <script>
        let players = [];
        let teams = [];
        let currentFixtures = [];
        let nextFixtures = [];
        let currentGWId = 1;
        const PROXY = "/.netlify/functions/fpl-proxy?endpoint=";

        async function init() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            try {
                const bootRes = await fetch(`${PROXY}bootstrap-static/`);
                const bootData = await bootRes.json();
                players = bootData.elements;
                teams = bootData.teams;
                currentGWId = bootData.events.find(e => e.is_current)?.id || 1;

                const [currRes, nextRes] = await Promise.all([
                    fetch(`${PROXY}fixtures/?event=${currentGWId}`),
                    fetch(`${PROXY}fixtures/?event=${currentGWId + 1}`)
                ]);

                currentFixtures = await currRes.json();
                nextFixtures = await nextRes.json();

                switchGW('curr'); // Default to current
            } catch (err) {
                document.getElementById('gw-display-header').innerText = "Update Failed";
            } finally {
                icon.classList.remove('fa-spin');
            }
        }

        function switchGW(type) {
            const isCurr = type === 'curr';
            document.getElementById('tab-curr').classList.toggle('active', isCurr);
            document.getElementById('tab-next').classList.toggle('active', !isCurr);
            
            const targetGW = isCurr ? currentGWId : currentGWId + 1;
            document.getElementById('gw-display-header').innerText = `Gameweek ${targetGW}`;
            renderGames(isCurr ? currentFixtures : nextFixtures);
        }

        function toggleDrawer(id) {
            const drawer = document.getElementById(`drawer-${id}`);
            const btn = drawer.previousElementSibling;
            const isActive = drawer.classList.toggle('active');
            btn.innerHTML = isActive ? `Hide Stats <i class="fa-solid fa-chevron-up"></i>` : `Expand Stats <i class="fa-solid fa-chevron-down"></i>`;
        }

        function calculateLivePoints(pid, fixture) {
            let pts = 0;
            const p = players.find(x => x.id === pid);
            if (!p) return 0;
            fixture.stats.forEach(s => {
                const entry = s.h.find(item => item.element === pid) || s.a.find(item => item.element === pid);
                if (entry) {
                    if (s.identifier === 'goals_scored') pts += (p.element_type <= 2 ? 6 : p.element_type === 3 ? 5 : 4) * entry.value;
                    if (s.identifier === 'assists') pts += 3 * entry.value;
                    if (s.identifier === 'yellow_cards') pts -= 1 * entry.value;
                    if (s.identifier === 'red_cards') pts -= 3 * entry.value;
                    if (s.identifier === 'own_goals') pts -= 2 * entry.value;
                }
            });
            if (fixture.started) pts += 2; 
            return pts;
        }

        function renderGames(fixtures) {
    const list = document.getElementById('games-list');
    let lastDate = "";
    
    list.innerHTML = fixtures.map(f => {
        const isLive = f.started && !f.finished;
        const hTeam = teams.find(t => t.id === f.team_h);
        const aTeam = teams.find(t => t.id === f.team_a);
        
        // --- Date Separator Logic ---
        const kickoff = new Date(f.kickoff_time);
        const dateStr = kickoff.toLocaleDateString([], { weekday: 'long', day: 'numeric', month: 'long' });
        let dateHeader = "";
        
        if (dateStr !== lastDate) {
            dateHeader = `<div class="date-separator">${dateStr}</div>`;
            lastDate = dateStr;
        }

        let bonusMarkup = "";
        const bonusStat = f.stats.find(s => s.identifier === (f.finished ? "bonus" : "bps"));
        if (bonusStat) {
            const top3 = [...bonusStat.h, ...bonusStat.a].sort((a,b) => b.value - a.value).slice(0,3);
            bonusMarkup = top3.map((p, i) => {
                const name = players.find(x => x.id === p.element)?.web_name;
                return `<span class="bonus-player">${name}<span class="pts-pill">${f.finished ? p.value : (3-i)}</span></span>`;
            }).join('');
        }

        const matchPlayers = players
            .filter(p => p.team === f.team_h || p.team === f.team_a)
            .sort((a,b) => b.selected_by_percent - a.selected_by_percent)
            .slice(0, 5);

        return `
            ${dateHeader}
            <div class="m-card">
                <div class="m-main">
                    <div class="team-box">
                        <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${hTeam.code}-66.png" class="kit-img">
                        <span class="team-name">${hTeam.short_name}</span>
                    </div>
                    <div class="score-center">
                        <div class="status-badge ${f.finished ? 'badge-done' : (isLive ? 'badge-live' : 'badge-sched')}">
                            ${f.finished ? 'Finished' : (isLive ? 'Live' : kickoff.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}))}
                        </div>
                        <div class="score-val">${f.team_h_score ?? 0} : ${f.team_a_score ?? 0}</div>
                    </div>
                    <div class="team-box">
                        <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${aTeam.code}-66.png" class="kit-img">
                        <span class="team-name">${aTeam.short_name}</span>
                    </div>
                </div>
                <div class="m-footer">
                    <span style="opacity:0.7">${f.finished ? 'BONUS' : 'BPS TOP 3'}</span><br>${bonusMarkup || '---'}
                </div>
                <button class="expand-btn" onclick="toggleDrawer(${f.id})">Expand Stats <i class="fa-solid fa-chevron-down"></i></button>
                <div class="drawer" id="drawer-${f.id}">
                    ${matchPlayers.map(p => `
                        <div class="own-row">
                            <span>${p.web_name} <small style="color:var(--text-muted)">(${p.selected_by_percent}%)</small></span>
                            <span class="live-pts-badge">${f.started ? calculateLivePoints(p.id, f) : 0}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }).join('');
}
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        init();
    </script>
</body>
</html>
