<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOPALA FPL - Live Games</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #2563eb;
            --fpl-green: #00ff85;
            --fpl-pink: #e90052;
            --border-color: #e2e8f0;
            --done-badge: #1e3a8a;
            --live-badge: #334155; 
            --expand-mint: #a7ffd6;
        }

        body.dark-mode {
            --bg-color: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc;
            --text-muted: #94a3b8; --border-color: #334155;
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: -apple-system, system-ui, sans-serif; transition: background 0.3s; }

        .top-brand-bar {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-color); position: sticky; top: 0; z-index: 110;
        }
        .live-logo {
            background: #000; color: #fff; padding: 6px 18px;
            border-radius: 50px; font-weight: 900; font-size: 1.2rem;
            display: flex; align-items: center; gap: 4px;
        }
        .live-logo span { color: var(--fpl-green); }
        .nav-btn { background:#eee; border:none; border-radius:50%; width:35px; height:35px; cursor:pointer; color: #000; display: flex; align-items: center; justify-content: center; }

        .content { padding: 0 12px 100px; }
        .gw-header { border-left: 4px solid var(--fpl-green); padding-left: 10px; margin: 15px 4px; font-size: 1.1rem; font-weight: 600; }

        /* MATCH CARD */
        .m-card { 
            background: var(--card-bg); border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            margin-bottom: 20px; overflow: hidden; border: 1px solid var(--border-color);
        }
        .m-main { display: flex; align-items: flex-start; justify-content: space-between; padding: 20px 10px; }
        .team-box { flex: 1.2; text-align: center; }
        .kit-img { width: 65px; height: auto; margin-bottom: 8px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .team-name { font-weight: 800; font-size: 0.8rem; display: block; }

        .score-center { flex: 1; text-align: center; }
        .status-badge { color: #fff; padding: 4px 12px; border-radius: 4px; font-size: 0.65rem; font-weight: 900; display: inline-block; margin-bottom: 12px; text-transform: uppercase; }
        .badge-done { background: var(--done-badge); }
        .badge-live { background: var(--live-badge); }
        
        .score-val { font-size: 1.6rem; font-weight: 500; letter-spacing: 6px; color: var(--text-main); }
        .score-divider { height: 1px; background: #cbd5e1; margin: 10px auto; width: 70%; }

        .m-footer { background: #fdfdfd; border-top: 1px solid var(--border-color); padding: 10px; font-size: 0.7rem; text-align: center; }
        .dark-mode .m-footer { background: #1e293b; }
        .bonus-player { margin: 0 5px; font-weight: 600; }
        .pts-pill { background: var(--primary-blue); color: #fff; padding: 1px 4px; border-radius: 3px; font-weight: 800; margin-left: 2px; }

        /* DRAWER */
        .expand-btn { background: var(--expand-mint); border: none; width: 100%; padding: 12px; font-size: 0.7rem; font-weight: 700; color: #004d2c; cursor: pointer; border-top: 1px solid var(--border-color); }
        .drawer { display: none; padding: 12px; background: var(--bg-color); border-top: 1px solid var(--border-color); }
        .drawer.active { display: block; }
        .drawer-header { display: flex; justify-content: space-between; font-size: 0.65rem; font-weight: 900; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        .own-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; align-items: center; }
        .live-pts-badge { background: var(--fpl-green); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 900; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; }
        .nav-item { color: var(--text-muted); text-decoration: none; font-size: 0.65rem; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--primary-blue); font-weight: 800; }
    </style>
</head>
<body>

    <div class="top-brand-bar">
        <button class="nav-btn" onclick="init()"><i class="fa-solid fa-arrows-rotate" id="refresh-icon"></i></button>
        <div class="live-logo">KOPALA<span>â–²</span>FPL</div>
        <button class="nav-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon" id="theme-icon"></i></button>
    </div>

    <div class="content" id="main-view">
        <div id="gw-title" class="gw-header">Loading Matchday...</div>
        <div id="games-list"></div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="games.html" class="nav-item active"><i class="fa-solid fa-soccer-ball"></i><span>Games</span></a>
        <a href="leagues.html" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item"><i class="fa-solid fa-money-bill-trend-up"></i><span>Prices</span></a>
    </nav>

    <script>
        let players = [];
        let teams = [];

        async function init() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            
            try {
                const bootRes = await fetch('/.netlify/functions/fpl-proxy?endpoint=bootstrap-static/');
                const bootData = await bootRes.json();
                players = bootData.elements;
                teams = bootData.teams;

                const currentGW = bootData.events.find(e => e.is_current)?.id || 1;
                document.getElementById('gw-title').innerText = `Gameweek ${currentGW} Games`;

                const fixRes = await fetch(`/.netlify/functions/fpl-proxy?endpoint=fixtures/?event=${currentGW}`);
                const fixData = await fixRes.json();
                
                renderGames(fixData);
            } catch (err) {
                document.getElementById('gw-title').innerText = "Update Failed";
            } finally {
                icon.classList.remove('fa-spin');
            }
        }

        function toggleDrawer(id) {
            document.getElementById(`drawer-${id}`).classList.toggle('active');
        }

        function calculateLivePoints(pid, fixture) {
            let pts = 0;
            const p = players.find(x => x.id === pid);
            if (!p) return 0;

            fixture.stats.forEach(s => {
                const entry = s.h.find(item => item.element === pid) || s.a.find(item => item.element === pid);
                if (entry) {
                    if (s.identifier === 'goals_scored') pts += (p.element_type === 1 ? 6 : p.element_type === 2 ? 6 : p.element_type === 3 ? 5 : 4) * entry.value;
                    if (s.identifier === 'assists') pts += 3 * entry.value;
                    if (s.identifier === 'yellow_cards') pts -= 1 * entry.value;
                    if (s.identifier === 'red_cards') pts -= 3 * entry.value;
                    if (s.identifier === 'own_goals') pts -= 2 * entry.value;
                }
            });
            if (fixture.started) pts += 2; 
            return pts;
        }

        function renderGames(fixtures) {
            const list = document.getElementById('games-list');
            list.innerHTML = fixtures.map(f => {
                const isLive = f.started && !f.finished;
                const homeTeam = teams.find(t => t.id === f.team_h);
                const awayTeam = teams.find(t => t.id === f.team_a);

                // Use team.code for correct jersey mapping
                const hKit = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${homeTeam.code}-66.webp`;
                const aKit = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${awayTeam.code}-66.webp`;

                let bonusMarkup = "";
                const bonusStat = f.stats.find(s => s.identifier === (f.finished ? "bonus" : "bps"));
                if (bonusStat) {
                    const top3 = [...bonusStat.h, ...bonusStat.a].sort((a,b) => b.value - a.value).slice(0,3);
                    bonusMarkup = top3.map((p, i) => {
                        const name = players.find(x => x.id === p.element)?.web_name;
                        const pts = f.finished ? p.value : (3-i);
                        return `<span class="bonus-player">${name} <span class="pts-pill">${pts}</span></span>`;
                    }).join('');
                }

                const matchPlayers = players
                    .filter(p => p.team === f.team_h || p.team === f.team_a)
                    .sort((a,b) => b.selected_by_percent - a.selected_by_percent)
                    .slice(0, 5);

                return `
                    <div class="m-card">
                        <div class="m-main">
                            <div class="team-box">
                                <img src="${hKit}" class="kit-img" onerror="this.src='https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_0-66.webp'">
                                <span class="team-name">${homeTeam.short_name}</span>
                            </div>
                            <div class="score-center">
                                <div class="status-badge ${isLive ? 'badge-live' : 'badge-done'}">${f.finished ? 'Done' : (isLive ? 'Live' : 'Scheduled')}</div>
                                <div class="score-val">${f.team_h_score ?? 0} : ${f.team_a_score ?? 0}</div>
                                <div class="score-divider"></div>
                            </div>
                            <div class="team-box">
                                <img src="${aKit}" class="kit-img" onerror="this.src='https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_0-66.webp'">
                                <span class="team-name">${awayTeam.short_name}</span>
                            </div>
                        </div>
                        <div class="m-footer">
                            <span style="font-weight:400">${f.finished ? 'Bonus (Official)' : 'Live Bonus'} /</span> ${bonusMarkup || 'Waiting...'}
                        </div>
                        <button class="expand-btn" onclick="toggleDrawer(${f.id})">Expand Ownership & Points</button>
                        <div class="drawer" id="drawer-${f.id}">
                            <div class="drawer-header"><span>Player (% Own)</span><span>Live Pts</span></div>
                            ${matchPlayers.map(p => `
                                <div class="own-row">
                                    <span>${p.web_name} (${p.selected_by_percent}%)</span>
                                    <span class="live-pts-badge">${f.started ? calculateLivePoints(p.id, f) : 0}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        init();
    </script>
</body>
</html>