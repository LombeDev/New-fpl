<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOPALA FPL - Live Games & Tables</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* 1. THEME & CORE STYLES */
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #2563eb;
            --fpl-green: #00ff85;
            --fpl-pink: #e90052;
            --border-color: #e2e8f0;
            --toggle-bg: #e2e8f0;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --toggle-bg: #334155;
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: -apple-system, system-ui, sans-serif; transition: 0.3s; }

        /* 2. TOP BRANDING BAR */
        .top-brand-bar {
            padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-color); position: sticky; top: 0; z-index: 110;
        }
        .live-logo {
            background: #000; color: #fff; padding: 6px 18px;
            border-radius: 50px; font-weight: 900; font-size: 1.2rem;
            display: flex; align-items: center; gap: 4px; cursor: pointer;
        }
        .live-logo span { color: var(--fpl-green); }
        .nav-btn { background:#eee; border:none; border-radius:50%; width:35px; height:35px; cursor:pointer; color: #000; display: flex; align-items: center; justify-content: center; }

        /* 3. SUB NAV / TABS */
        .sub-nav { padding: 0 15px 15px; background: var(--bg-color); }
        .toggle-box { display: flex; background: var(--toggle-bg); border-radius: 10px; padding: 3px; gap: 4px; }
        .toggle-btn { flex: 1; border: none; background: none; padding: 10px; font-size: 0.75rem; font-weight: 800; color: var(--text-muted); cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .toggle-btn.active { background: var(--primary-blue); color: #fff; }

        /* 4. CONTENT CONTAINERS */
        .content { padding: 0 15px 100px; }
        .section-title { font-size: 0.7rem; font-weight: 900; text-transform: uppercase; margin: 20px 0 10px; color: var(--text-muted); letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: var(--border-color); }

        /* 5. MATCH CARDS */
        .m-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: transform 0.2s; }
        .m-meta { display: flex; justify-content: space-between; font-size: 0.65rem; font-weight: 800; margin-bottom: 10px; }
        .status-live { color: var(--fpl-pink); animation: blink 1.2s infinite; }
        
        .score-row { display: flex; align-items: center; justify-content: space-between; text-align: center; }
        .team-name { flex: 1; font-weight: 800; font-size: 0.85rem; }
        .score-val { font-size: 1.5rem; font-weight: 900; width: 70px; color: var(--text-main); }
        .vs-val { font-size: 0.8rem; color: var(--text-muted); }

        /* 6. STANDINGS TABLE */
        .table-wrap { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; margin-top: 10px; }
        .std-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .std-table th { background: var(--bg-color); padding: 12px 10px; text-align: left; color: var(--text-muted); font-size: 0.6rem; text-transform: uppercase; }
        .std-table td { padding: 12px 10px; border-bottom: 1px solid var(--border-color); font-weight: 700; }
        .pos-col { width: 25px; color: var(--text-muted); font-size: 0.7rem; }
        .pts-col { color: var(--primary-blue); text-align: right; }

        /* 7. BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; }
        .nav-item { color: var(--text-muted); text-decoration: none; font-size: 0.65rem; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--primary-blue); font-weight: 800; }

        @keyframes blink { 50% { opacity: 0.4; } }
        #loader { text-align: center; padding: 50px; color: var(--text-muted); font-weight: 800; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="top-brand-bar">
        <button class="nav-btn" onclick="forceRefresh()"><i class="fa-solid fa-arrows-rotate" id="refresh-icon"></i></button>
        <div class="live-logo" onclick="window.location.href='index.html'">Kopala<span>▲</span>FPL</div>
        <button class="nav-btn" onclick="toggleTheme()"><i class="fa-solid fa-sun" id="theme-icon"></i></button>
    </div>

    <div class="sub-nav">
        <div class="toggle-box">
            <button class="toggle-btn active" id="tab-matches" onclick="switchTab('matches')">Matches</button>
            <button class="toggle-btn" id="tab-table" onclick="switchTab('table')">Standings</button>
            <button class="toggle-btn" id="tab-feed" onclick="switchTab('feed')">Live Feed</button>
        </div>
    </div>

    <div class="content" id="main-view">
        <div id="loader"><i class="fas fa-spinner fa-spin"></i> Analyzing Pitch Data...</div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="games.html" class="nav-item active"><i class="fa-solid fa-soccer-ball"></i><span>Games</span></a>
        <a href="leagues.html" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item"><i class="fa-solid fa-money-bill-trend-up"></i><span>Prices</span></a>
        <button class="nav-item"><i class="fa-solid fa-ellipsis"></i><span>More</span></button>
    </nav>

    <script>
        // API CONFIGURATION
        const MATCHES_URL = '/.netlify/functions/fpl-proxy?endpoint=competitions/PL/matches';
        const TABLE_URL = '/.netlify/functions/fpl-proxy?endpoint=competitions/PL/standings';
        
        const CACHE_TIMES = {
            matches: 60 * 1000,    // 1 Minute for scores
            table: 60 * 60 * 1000  // 1 Hour for standings
        };

        let currentView = 'matches';

        // 1. DATA FETCHING WITH CACHE LOGIC
        async function fetchWithCache(key, url, ttl) {
            const cached = localStorage.getItem(key);
            const now = Date.now();

            if (cached) {
                const { data, timestamp } = JSON.parse(cached);
                if (now - timestamp < ttl) {
                    console.log(`Using cached data for: ${key}`);
                    return data;
                }
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Rate Limit');
            const data = await response.json();
            
            localStorage.setItem(key, JSON.stringify({ data, timestamp: now }));
            return data;
        }

        // 2. TAB SWITCHING LOGIC
        async function switchTab(tab) {
            currentView = tab;
            
            // Update UI Buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Show Loader
            const container = document.getElementById('main-view');
            container.innerHTML = '<div id="loader"><i class="fas fa-spinner fa-spin"></i> Refreshing...</div>';

            try {
                if (tab === 'matches') {
                    const data = await fetchWithCache('pl-matches', MATCHES_URL, CACHE_TIMES.matches);
                    renderMatches(data.matches);
                } else if (tab === 'table') {
                    const data = await fetchWithCache('pl-table', TABLE_URL, CACHE_TIMES.table);
                    renderTable(data.standings[0].table);
                } else {
                    renderFeed();
                }
            } catch (err) {
                container.innerHTML = '<p style="text-align:center; padding:40px; color:var(--fpl-pink); font-weight:800;">API Limit Reached. Please wait 1 minute.</p>';
            }
        }

        // 3. RENDERING FUNCTIONS
        function renderMatches(matches) {
            const container = document.getElementById('main-view');
            
            const live = matches.filter(m => ['IN_PLAY', 'PAUSED'].includes(m.status));
            const finished = matches.filter(m => m.status === 'FINISHED').slice(-5).reverse();
            const upcoming = matches.filter(m => ['SCHEDULED', 'TIMED'].includes(m.status)).slice(0, 5);

            let html = '';

            if (live.length > 0) {
                html += '<div class="section-title">Live Scores</div>';
                html += live.map(m => matchCard(m)).join('');
            }

            html += '<div class="section-title">Recent Results</div>';
            html += finished.map(m => matchCard(m)).join('');

            html += '<div class="section-title">Upcoming Fixtures</div>';
            html += upcoming.map(m => matchCard(m)).join('');

            container.innerHTML = html;
        }

        function matchCard(m) {
            const isLive = ['IN_PLAY', 'PAUSED'].includes(m.status);
            const homeScore = m.score.fullTime.home;
            const awayScore = m.score.fullTime.away;
            const date = new Date(m.utcDate).toLocaleDateString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            return `
                <div class="m-card">
                    <div class="m-meta">
                        <span class="${isLive ? 'status-live' : ''}">${isLive ? '● LIVE' : m.status}</span>
                        <span>${date}</span>
                    </div>
                    <div class="score-row">
                        <div class="team-name">${m.homeTeam.shortName || m.homeTeam.name}</div>
                        <div class="score-val">${homeScore ?? ''} <span class="vs-val">${homeScore !== null ? ':' : 'vs'}</span> ${awayScore ?? ''}</div>
                        <div class="team-name">${m.awayTeam.shortName || m.awayTeam.name}</div>
                    </div>
                </div>
            `;
        }

        function renderTable(table) {
            const container = document.getElementById('main-view');
            container.innerHTML = `
                <div class="section-title">League Standing</div>
                <div class="table-wrap">
                    <table class="std-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Team</th>
                                <th>PL</th>
                                <th>GD</th>
                                <th style="text-align:right">PTS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${table.map(t => `
                                <tr>
                                    <td class="pos-col">${t.position}</td>
                                    <td>${t.team.shortName || t.team.name}</td>
                                    <td>${t.playedGames}</td>
                                    <td>${t.goalDifference}</td>
                                    <td class="pts-col">${t.points}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderFeed() {
            document.getElementById('main-view').innerHTML = `
                <div class="section-title">Kopala Live Feed</div>
                <div class="m-card" style="border-left: 4px solid var(--fpl-green)">
                    <div style="font-size:0.6rem; font-weight:800; color:var(--text-muted)">SYSTEM CHECK</div>
                    <div style="font-size:0.8rem; font-weight:800; margin-top:5px;">Data Pipeline: Healthy</div>
                    <div style="font-size:0.7rem; color:var(--text-muted); margin-top:4px;">Football-Data.org API is currently providing matchday updates.</div>
                </div>
            `;
        }

        // 4. UTILITY FUNCTIONS
        function forceRefresh() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            
            localStorage.removeItem('pl-matches');
            localStorage.removeItem('pl-table');
            
            switchTab(currentView);
            setTimeout(() => icon.classList.remove('fa-spin'), 1000);
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('theme-icon');
            icon.className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // 5. INITIALIZATION
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').className = 'fa-solid fa-moon';
        }

        switchTab('matches');
    </script>
</body>
</html>
