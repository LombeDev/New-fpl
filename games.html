<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Games - Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#37003c">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #37003c; /* Changed to match your branding */
            --fpl-green: #00ff85;
            --border-color: #e2e8f0;
            --done-badge: #1e3a8a;
            --live-badge: #e90052; 
            --expand-mint: #f8fafc;
            --shadow-md: 0 4px 12px -2px rgba(0, 0, 0, 0.08);
            --shimmer-base: #f0f4f9;
            --shimmer-shine: rgba(255, 255, 255, 0.7);
        }

        body { margin: 0; background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; }
        .page-content { padding-top: 20px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; padding-left: 10px; padding-right: 10px; }

        /* --- SCROLL REVEAL ANIMATION --- */
        .reveal-item {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .reveal-item.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- SKELETON LOADER --- */
        .skeleton {
            background-color: var(--shimmer-base) !important;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }
        .skeleton::after {
            content: "";
            position: absolute;
            top: 0; left: -150%; width: 100%; height: 100%;
            background: linear-gradient(110deg, rgba(255, 255, 255, 0) 20%, var(--shimmer-shine) 50%, rgba(255, 255, 255, 0) 80%);
            animation: glass-shine 1.6s infinite ease-in-out;
        }
        @keyframes glass-shine { 0% { left: -150%; } 100% { left: 150%; } }

        /* --- TABS --- */
        .gw-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .gw-tab { flex: 1; padding: 12px; text-align: center; border-radius: 20px; background: var(--card-bg); border: 1px solid var(--border-color); font-size: 0.75rem; font-weight: 800; cursor: pointer; color: var(--text-muted); transition: 0.3s; }
        .gw-tab.active { background: var(--primary-blue); color: #00ff85; border-color: var(--primary-blue); }

        /* MATCH CARD */
        .m-card { background: var(--card-bg); border-radius: 20px; margin-bottom: 16px; overflow: hidden; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        .m-time-bar { font-size: 0.65rem; font-weight: 700; text-align: center; padding: 8px; opacity: 0.6; border-bottom: 1px solid var(--border-color); background: #fafafa; }
        .m-main { display: flex; align-items: center; justify-content: space-between; padding: 20px 10px; }
        .team-box { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .kit-img { width: 42px; height: auto; margin-bottom: 6px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); }
        .team-name { font-weight: 900; font-size: 0.75rem; color: var(--text-main); }
        
        .score-center { flex: 1.2; text-align: center; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.6rem; font-weight: 900; display: inline-block; margin-bottom: 8px; text-transform: uppercase; }
        .badge-done { background: #e2e8f0; color: var(--text-muted); }
        .badge-live { background: #ffe4e6; color: var(--live-badge); animation: pulse 2s infinite; }
        .badge-sched { background: #f1f5f9; color: var(--text-muted); }
        .score-val { font-size: 1.8rem; font-weight: 900; letter-spacing: 2px; color: var(--primary-blue); }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .m-events { background: var(--expand-mint); padding: 12px; font-size: 0.65rem; border-top: 1px solid var(--border-color); }
        .event-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .event-side { display: flex; flex-direction: column; gap: 4px; }
        .event-item { display: flex; align-items: center; gap: 4px; font-weight: 600; color: #333; }
        
        .m-footer { background: var(--card-bg); padding: 10px; font-size: 0.6rem; text-align: center; border-top: 1px dashed var(--border-color); color: var(--text-muted); }
        .bonus-player { margin: 0 4px; font-weight: 700; color: var(--text-main); display: inline-block; }
        .pts-pill { background: var(--primary-blue); color: #00ff85; padding: 2px 6px; border-radius: 4px; margin-left: 3px; font-size: 0.6rem; }

        .expand-btn { background: var(--card-bg); border: none; width: 100%; padding: 12px; font-size: 0.7rem; font-weight: 800; color: var(--primary-blue); cursor: pointer; border-top: 1px solid var(--border-color); transition: background 0.2s; }
        .expand-btn:active { background: #f1f5f9; }
        .drawer { display: none; padding: 10px; background: var(--expand-mint); border-top: 1px solid var(--border-color); }
        .drawer.active { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .own-row { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.75rem; }
        .own-row:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>

    <main class="page-content">
        <div class="gw-tabs">
            <div id="tab-curr" class="gw-tab active" onclick="switchGW('curr')">Current GW</div>
            <div id="tab-next" class="gw-tab" onclick="switchGW('next')">Next GW</div>
        </div>
        <div id="gw-display-header" style="font-weight: 900; margin-bottom: 15px; font-size: 1.2rem; padding-left: 5px;">Gameweek --</div>
        
        <div id="games-list"></div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        let players = [], teams = [], currentFixtures = [], nextFixtures = [], currentGWId = 1;
        const PROXY = "/.netlify/functions/fpl-proxy?endpoint=";

        function showSkeletons() {
            const list = document.getElementById('games-list');
            let html = '';
            for (let i = 0; i < 5; i++) {
                html += `
                <div class="m-card reveal-item">
                    <div class="m-time-bar"><div class="skeleton" style="width:100px; height:8px; margin:0 auto;"></div></div>
                    <div class="m-main">
                        <div class="team-box">
                            <div class="skeleton" style="width:36px; height:36px; border-radius:50%; margin:0 auto 6px;"></div>
                            <div class="skeleton" style="width:60%; height:10px; margin:0 auto;"></div>
                        </div>
                        <div class="score-center">
                            <div class="skeleton" style="width:40px; height:14px; border-radius:10px; margin:0 auto 8px;"></div>
                            <div class="skeleton" style="width:60px; height:30px; margin:0 auto;"></div>
                        </div>
                        <div class="team-box">
                            <div class="skeleton" style="width:36px; height:36px; border-radius:50%; margin:0 auto 6px;"></div>
                            <div class="skeleton" style="width:60%; height:10px; margin:0 auto;"></div>
                        </div>
                    </div>
                </div>`;
            }
            list.innerHTML = html;
        }

        async function init() {
            showSkeletons();
            try {
                const bootRes = await fetch(`${PROXY}bootstrap-static/`);
                const bootData = await bootRes.json();
                players = bootData.elements;
                teams = bootData.teams;
                currentGWId = bootData.events.find(e => e.is_current)?.id || 1;

                const [currRes, nextRes] = await Promise.all([
                    fetch(`${PROXY}fixtures/?event=${currentGWId}`),
                    fetch(`${PROXY}fixtures/?event=${currentGWId + 1}`)
                ]);

                currentFixtures = await currRes.json();
                nextFixtures = await nextRes.json();

                switchGW('curr'); 
            } catch (err) { console.error(err); }
        }

        function formatMatchTime(kickoff) {
            const date = new Date(kickoff);
            return date.toLocaleDateString([], { weekday: 'short', day: 'numeric', month: 'short' }) + ' ' + 
                   date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function getMatchMinute(f) {
            if (f.finished) return 'FT';
            if (!f.started) return 'v';
            const start = new Date(f.kickoff_time);
            const now = new Date();
            // Simple estimation. For real precision, use 'minutes' from live data if available
            let diff = Math.floor((now - start) / 60000);
            if (diff > 45 && diff < 60) return "HT";
            if (diff >= 60) diff -= 15;
            if (diff > 90) return "90+";
            return diff + "'";
        }

        function getEvents(f, type) {
            const stat = f.stats.find(s => s.identifier === type);
            if (!stat) return { h: [], a: [] };
            const getPlayerName = (id) => players.find(p => p.id === id)?.web_name || "??";
            return {
                h: stat.h.map(e => ({ name: getPlayerName(e.element), val: e.value })),
                a: stat.a.map(e => ({ name: getPlayerName(e.element), val: e.value }))
            };
        }

        function switchGW(type) {
            const isCurr = type === 'curr';
            document.getElementById('tab-curr').classList.toggle('active', isCurr);
            document.getElementById('tab-next').classList.toggle('active', !isCurr);
            const targetGW = isCurr ? currentGWId : currentGWId + 1;
            document.getElementById('gw-display-header').innerText = `Gameweek ${targetGW}`;
            
            const fixtures = isCurr ? currentFixtures : nextFixtures;
            renderGames(fixtures);
        }

        function renderGames(fixtures) {
            const list = document.getElementById('games-list');
            
            if(!fixtures || fixtures.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; opacity:0.6;">No games found.</div>`;
                return;
            }

            list.innerHTML = fixtures.map(f => {
                const hTeam = teams.find(t => t.id === f.team_h);
                const aTeam = teams.find(t => t.id === f.team_a);
                
                // Safety check in case teams aren't loaded yet
                if(!hTeam || !aTeam) return '';

                const goals = getEvents(f, 'goals_scored');
                const assists = getEvents(f, 'assists');
                
                let bonusMarkup = "";
                const bpsStat = f.stats.find(s => s.identifier === (f.finished ? "bonus" : "bps"));
                
                if (bpsStat && (bpsStat.h.length > 0 || bpsStat.a.length > 0)) {
                    // Combine and sort by value (BPS or Bonus)
                    const allBps = [
                        ...bpsStat.h.map(x => ({...x, team: 'h'})), 
                        ...bpsStat.a.map(x => ({...x, team: 'a'}))
                    ].sort((a,b) => b.value - a.value).slice(0, 3);

                    bonusMarkup = allBps.map((p, i) => {
                        const name = players.find(x => x.id === p.element)?.web_name || "Unknown";
                        // If finished, show actual bonus (3,2,1). If live, show projected rank (1st, 2nd, 3rd)
                        const displayVal = f.finished ? p.value : (3 - i); 
                        return `<span class="bonus-player">${name}<span class="pts-pill">${displayVal}</span></span>`;
                    }).join('');
                }

                // Add 'reveal-item' class for animation
                return `
                    <div class="m-card reveal-item">
                        <div class="m-time-bar">${formatMatchTime(f.kickoff_time)}</div>
                        <div class="m-main">
                            <div class="team-box">
                                <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${hTeam.code}-66.png" class="kit-img">
                                <span class="team-name">${hTeam.name}</span>
                            </div>
                            <div class="score-center">
                                <div class="status-badge ${f.finished ? 'badge-done' : (f.started ? 'badge-live' : 'badge-sched')}">
                                    ${getMatchMinute(f)}
                                </div>
                                <div class="score-val">
                                    ${f.started ? `${f.team_h_score} : ${f.team_a_score}` : 'vs'}
                                </div>
                            </div>
                            <div class="team-box">
                                <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${aTeam.code}-66.png" class="kit-img">
                                <span class="team-name">${aTeam.name}</span>
                            </div>
                        </div>

                        ${f.started && (goals.h.length > 0 || goals.a.length > 0) ? `
                        <div class="m-events">
                            <div class="event-grid">
                                <div class="event-side home" style="text-align:right;">
                                    ${goals.h.map(g => `<div class="event-item" style="justify-content: flex-end;">${g.name} ‚öΩ</div>`).join('')}
                                    ${assists.h.map(a => `<div class="event-item" style="justify-content: flex-end; opacity:0.7;">${a.name} üÖ∞Ô∏è</div>`).join('')}
                                </div>
                                <div class="event-side away">
                                    ${goals.a.map(g => `<div class="event-item">‚öΩ ${g.name}</div>`).join('')}
                                    ${assists.a.map(a => `<div class="event-item" style="opacity:0.7;">üÖ∞Ô∏è ${a.name}</div>`).join('')}
                                </div>
                            </div>
                        </div>` : ''}

                        ${bonusMarkup ? `
                        <div class="m-footer">
                            <div style="font-weight:800; opacity:0.6; margin-bottom:4px; font-size:0.55rem; letter-spacing:1px">${f.finished ? 'BONUS POINTS' : 'PROJECTED BONUS'}</div>
                            ${bonusMarkup}
                        </div>` : ''}
                        
                        <button class="expand-btn" onclick="toggleDrawer(${f.id})">
                            PLAYER OWNERSHIP <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        <div class="drawer" id="drawer-${f.id}">
                             ${getTopOwnedMarkup(f.team_h, f.team_a)}
                        </div>
                    </div>`;
            }).join('');

            // Trigger animations
            applyScrollReveal();
        }

        function getTopOwnedMarkup(teamHId, teamAId) {
            // Filter players from these two teams, sort by ownership
            const relevantPlayers = players.filter(p => p.team === teamHId || p.team === teamAId)
                                           .sort((a,b) => parseFloat(b.selected_by_percent) - parseFloat(a.selected_by_percent))
                                           .slice(0, 5);
            
            return relevantPlayers.map(p => `
                <div class="own-row">
                    <span>${p.web_name} <small style="opacity:0.6">${p.selected_by_percent}%</small></span>
                    <span style="font-weight:900; color:var(--primary-blue)">${p.element_type === 1 ? 'GK' : (p.element_type === 2 ? 'DEF' : (p.element_type===3 ? 'MID' : 'FWD'))}</span>
                </div>
            `).join('');
        }

        function toggleDrawer(id) {
            const el = document.getElementById(`drawer-${id}`);
            if(el) el.classList.toggle('active');
        }

        function applyScrollReveal() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.reveal-item').forEach(item => {
                observer.observe(item);
            });
        }

        // Initialize
        init();
    </script>
    
    <script src="footer.js"></script>
    <script src="nav.js"></script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(() => console.log('SW Registered'))
            .catch((err) => console.log('SW Failed', err));
        });
      }
    </script>
</body>
</html>