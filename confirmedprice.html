<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Predictor | LiveFPL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --nav-bg: #0b1120;
            --body-bg: #f8fafc;
            --fpl-primary: #00ff85;
            --fpl-danger: #ff005a;
            --border-color: #e2e8f0;
            --text-muted: #64748b;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--body-bg); color: #1e293b; }

        .top-nav { background: var(--nav-bg); display: flex; justify-content: center; padding: 10px 0; gap: 35px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: white; text-decoration: none; font-size: 10px; font-weight: 600; opacity: 0.7; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; color: #475569; }
        .nav-item.active { opacity: 1; }
        .nav-item.active i { color: var(--fpl-primary); }

        .main-container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }

        /* Confirmed Tables Section */
        .confirmed-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .conf-table-container { background: #fff; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .conf-header { padding: 10px 15px; font-weight: 800; font-size: 12px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .conf-rise { background: #f0fff4; color: #166534; border-bottom: 2px solid var(--fpl-primary); }
        .conf-fall { background: #fff5f5; color: #991b1b; border-bottom: 2px solid var(--fpl-danger); }
        
        .mini-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .mini-table td { padding: 8px 15px; border-bottom: 1px solid #f1f5f9; }
        .mini-table tr:last-child td { border: none; }
        .price-change { font-weight: bold; font-family: monospace; font-size: 12px; }

        /* Main Predictor Table */
        .controls-row { background: #fff; border: 1px solid var(--border-color); border-radius: 8px 8px 0 0; padding: 15px; display: flex; gap: 15px; align-items: center; }
        .search-box { flex: 2; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; }
        .toggle-container { display: flex; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; }
        .toggle-btn { padding: 10px 20px; font-weight: bold; cursor: pointer; border: none; background: #fff; font-size: 12px; }
        .toggle-btn.active.rise { background: #f0fff4; color: #166534; border-bottom: 3px solid var(--fpl-primary); }
        .toggle-btn.active.fall { background: #fff5f5; color: #991b1b; border-bottom: 3px solid var(--fpl-danger); }

        .table-wrap { background: #fff; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead th { background: #0f172a; color: #fff; text-align: left; padding: 12px; font-size: 11px; }
        tbody td { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 14px; }

        #loader { padding: 40px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-trophy"></i>Home</a>
        <a href="prices.html" class="nav-item active"><i class="fa-solid fa-dollar-sign"></i>Price Predictor</a>
        <a href="#" class="nav-item"><i class="fa-solid fa-soccer-ball"></i>Games</a>
    </nav>

    <div class="main-container">
        <div class="confirmed-section">
            <div class="conf-table-container">
                <div class="conf-header conf-rise"><i class="fas fa-chevron-up"></i> Top 5 Risers Tonight</div>
                <table class="mini-table">
                    <tbody id="conf-risers-body"></tbody>
                </table>
            </div>
            <div class="conf-table-container">
                <div class="conf-header conf-fall"><i class="fas fa-chevron-down"></i> Top 5 Fallers Tonight</div>
                <table class="mini-table">
                    <tbody id="conf-fallers-body"></tbody>
                </table>
            </div>
        </div>

        <div class="controls-row">
            <input type="text" id="playerSearch" class="search-box" placeholder="Search All Players...">
            <div class="toggle-container">
                <button id="btnRise" class="toggle-btn active rise">Risers List</button>
                <button id="btnFall" class="toggle-btn fall">Fallers List</button>
            </div>
        </div>

        <div id="loader">Syncing Data...</div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Progress</th>
                        <th>Prediction</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody id="predictor-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = "https://fantasy.premierleague.com/api/bootstrap-static/";
        const PROXIES = ["https://api.allorigins.win/get?url=", "https://corsproxy.io/?url="];
        const CACHE_KEY = "fpl_price_data";
        const CACHE_TIME = "fpl_price_timestamp";
        const AGGRESSIVE_LIMIT = 5 * 60 * 60 * 1000; 

        let allPlayers = [];
        let viewMode = 'rise';

        async function init(force = false) {
            const lastFetched = localStorage.getItem(CACHE_TIME);
            const now = Date.now();

            if (!force && lastFetched && (now - lastFetched < AGGRESSIVE_LIMIT)) {
                processData(JSON.parse(localStorage.getItem(CACHE_KEY)));
                return;
            }

            let data = null;
            for (let proxy of PROXIES) {
                try {
                    const response = await fetch(`${proxy}${encodeURIComponent(API_URL)}`);
                    const result = await response.json();
                    data = result.contents ? JSON.parse(result.contents) : result;
                    if (data) break; 
                } catch (e) { console.error("Proxy error", e); }
            }

            if (data) {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIME, now.toString());
                processData(data);
            }
        }

        function processData(data) {
            const teams = Object.fromEntries(data.teams.map(t => [t.id, t.short_name]));
            allPlayers = data.elements.map(p => {
                const net = p.transfers_in_event - p.transfers_out_event;
                const prog = (net / 480);
                const currentPrice = p.now_cost / 10;
                return {
                    name: p.web_name,
                    team: teams[p.team],
                    price: currentPrice.toFixed(1),
                    newPriceRise: (currentPrice + 0.1).toFixed(1),
                    newPriceFall: (currentPrice - 0.1).toFixed(1),
                    prog: parseFloat(prog.toFixed(1)),
                    pred: parseFloat((prog * 1.05).toFixed(1)),
                    pos: ["", "GKP", "DEF", "MID", "FWD"][p.element_type]
                };
            });
            document.getElementById('loader').style.display = 'none';
            renderConfirmed();
            render();
        }

        function renderConfirmed() {
            const risersBody = document.getElementById('conf-risers-body');
            const fallersBody = document.getElementById('conf-fallers-body');

            const top5Risers = [...allPlayers].sort((a,b) => b.pred - a.pred).slice(0, 5);
            const top5Fallers = [...allPlayers].sort((a,b) => a.pred - b.pred).slice(0, 5);

            risersBody.innerHTML = top5Risers.map(p => `
                <tr>
                    <td><strong>${p.name}</strong> <small>(${p.team})</small></td>
                    <td class="price-change">£${p.price} → <span style="color:#10b981">£${p.newPriceRise}</span></td>
                    <td style="color:#10b981; font-weight:bold; text-align:right;">${p.pred}%</td>
                </tr>
            `).join('');

            fallersBody.innerHTML = top5Fallers.map(p => `
                <tr>
                    <td><strong>${p.name}</strong> <small>(${p.team})</small></td>
                    <td class="price-change">£${p.price} → <span style="color:#ef4444">£${p.newPriceFall}</span></td>
                    <td style="color:#ef4444; font-weight:bold; text-align:right;">${p.pred}%</td>
                </tr>
            `).join('');
        }

        function render() {
            const body = document.getElementById('predictor-body');
            const searchVal = document.getElementById('playerSearch').value.toLowerCase();
            
            const filtered = allPlayers.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchVal);
                const matchesView = (viewMode === 'rise' ? p.prog >= -5 : p.prog < 0);
                return matchesSearch && matchesView;
            }).sort((a,b) => viewMode === 'rise' ? b.prog - a.prog : a.prog - b.prog);

            body.innerHTML = filtered.slice(0, 50).map(p => `
                <tr>
                    <td><strong>${p.name}</strong> <small style="color:var(--text-muted)">${p.pos}</small></td>
                    <td>${p.team}</td>
                    <td>${p.prog}%</td>
                    <td style="font-weight:bold; color:${Math.abs(p.pred) >= 90 ? '#ef4444' : 'inherit'}">${p.pred}%</td>
                    <td><i class="fa-solid fa-arrow-${viewMode === 'rise' ? 'up' : 'down'}" style="color:${viewMode === 'rise' ? '#00ff85' : '#ff005a'}"></i></td>
                </tr>
            `).join('');
        }

        document.getElementById('btnRise').onclick = () => { viewMode = 'rise'; document.getElementById('btnRise').classList.add('active'); document.getElementById('btnFall').classList.remove('active'); render(); };
        document.getElementById('btnFall').onclick = () => { viewMode = 'fall'; document.getElementById('btnFall').classList.add('active'); document.getElementById('btnRise').classList.remove('active'); render(); };
        document.getElementById('playerSearch').oninput = render;

        init();
    </script>
</body>
</html>
