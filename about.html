<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kopala FPL - Live API Nano</title>
    <style>
        :root { --primary-blue: #2563eb; --pitch-green: #27ae60; --dark-header: #1e293b; --bg-gray: #f1f5f9; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { background: #fff; margin: 0; padding: 0; overflow-x: hidden; }

        /* --- HEADER --- */
        .app-header { padding: 4px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; gap: 4px; position: sticky; top: 0; z-index: 1000; }
        .minimal-input { flex: 1; padding: 4px; border-radius: 4px; border: 1px solid #ddd; font-size: 0.7rem; height: 26px; }
        .btn { padding: 0 10px; border-radius: 4px; border: none; font-weight: 700; height: 26px; font-size: 0.65rem; color: #fff; cursor: pointer; }

        /* --- COMPARISON --- */
        .comp-section { width: 100vw; padding: 4px; border-bottom: 3px solid var(--bg-gray); }
        .comp-table { width: 100%; border-collapse: collapse; font-size: 0.52rem; text-align: center; }
        .comp-table th { background: var(--dark-header); color: #fff; padding: 3px; }
        .comp-table td { padding: 4px 2px; border-bottom: 0.5px solid #eee; font-weight: 700; }

        /* --- PITCH --- */
        .section-wrapper { width: 100vw; border-bottom: 3px solid var(--bg-gray); }
        .p-title { padding: 4px; text-align: center; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
        .pitch-main { background: var(--pitch-green); padding: 8px 0; display: flex; flex-direction: column; gap: 4px; min-height: 240px; }
        .pitch-row { display: flex; justify-content: center; gap: 2px; }

        /* --- CARDS --- */
        .mini-card { width: 18%; max-width: 45px; display: flex; flex-direction: column; align-items: center; position: relative; }
        .match-status { font-size: 4px; background: rgba(0,0,0,0.7); color: #fff; padding: 1px 2px; border-radius: 2px; position: absolute; top: -4px; z-index: 10; }
        .mini-jersey { width: 16px; margin-bottom: 1px; }
        .card-body { width: 100%; background: #fff; border: 0.5px solid #333; border-radius: 2px; overflow: hidden; }
        .card-name-strip { background: var(--dark-header); color: #fff; font-size: 0.35rem; height: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; }
        .card-data { padding: 1px; text-align: center; font-weight: 900; font-size: 0.5rem; line-height: 1.1; }
        .p-bonus { color: #fbbf24; font-size: 0.4rem; }
        .price-bar { height: 1.5px; background: #ddd; margin-top: 1px; position: relative; }
        .price-fill { height: 100%; position: absolute; }
        
        .hidden { display: none; }
        #status-msg { font-size: 0.6rem; text-align: center; color: var(--primary-blue); padding: 5px; }
    </style>
</head>
<body>

    <header class="app-header">
        <input type="number" id="fpl-id" placeholder="Enter Team ID" class="minimal-input">
        <button onclick="fetchLiveFPL()" class="btn" style="background:var(--primary-blue)">SYNC LIVE</button>
    </header>

    <div id="status-msg">Enter ID to load live 2026 data...</div>

    <main id="dashboard" class="hidden">
        <section class="comp-section">
            <table class="comp-table">
                <thead><tr><th>Stat</th><th>Your Team</th><th>Top 10k Avg</th><th>Overall Avg</th></tr></thead>
                <tbody id="comp-body"></tbody>
            </table>
        </section>

        <section class="section-wrapper">
            <div class="p-title">Live Squad Performance</div>
            <div class="pitch-main" id="live-pitch">
                <div id="row-1" class="pitch-row"></div><div id="row-2" class="pitch-row"></div>
                <div id="row-3" class="pitch-row"></div><div id="row-4" class="pitch-row"></div>
            </div>
        </section>

        <section class="section-wrapper">
            <div class="p-title">Threats Around Rank</div>
            <div class="pitch-main" id="threat-pitch">
                <div id="thr-1" class="pitch-row"></div><div id="thr-2" class="pitch-row"></div>
            </div>
        </section>
    </main>

    <script>
        const PROXY = "https://api.allorigins.win/get?url=";

        async function fetchLiveFPL() {
            const teamId = document.getElementById('fpl-id').value;
            if (!teamId) return alert("Please enter a Team ID");
            
            document.getElementById('status-msg').innerText = "Connecting to FPL Servers...";
            
            try {
                // 1. Get Static Data (Players/Teams)
                const bootRes = await fetch(`${PROXY}${encodeURIComponent('https://fantasy.premierleague.com/api/bootstrap-static/')}`);
                const boot = JSON.parse((await bootRes.json()).contents);
                const currentGW = boot.events.find(e => e.is_current).id;

                // 2. Get Live Points & Fixtures
                const liveRes = await fetch(`${PROXY}${encodeURIComponent(`https://fantasy.premierleague.com/api/event/${currentGW}/live/`)}`);
                const liveData = JSON.parse((await liveRes.json()).contents);
                
                // 3. Get User Picks
                const pickRes = await fetch(`${PROXY}${encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${teamId}/event/${currentGW}/picks/`)}`);
                const picks = JSON.parse((await pickRes.json()).contents);

                renderAll(boot, liveData, picks);
                document.getElementById('status-msg').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
            } catch (e) {
                document.getElementById('status-msg').innerText = "Sync Failed. Check ID or Proxy.";
                console.error(e);
            }
        }

        function renderAll(boot, live, picks) {
            const playerMap = {};
            boot.elements.forEach(p => playerMap[p.id] = p);
            
            const liveStats = {};
            live.elements.forEach(l => liveStats[l.id] = l.stats);

            // Render Comparison
            const totalScore = picks.entry_history.points;
            document.getElementById('comp-body').innerHTML = `
                <tr><td>Live Score</td><td>${totalScore}</td><td>${boot.events[picks.active_chip?0:picks.event-1].average_entry_score + 4}</td><td>${boot.events[picks.event-1].average_entry_score}</td></tr>
                <tr><td>Active Pick</td><td>${playerMap[picks.picks.find(p=>p.is_captain).element].web_name}</td><td>Mixed</td><td>Mixed</td></tr>
            `;

            // Render Live Pitch
            const rows = ['row-1', 'row-2', 'row-3', 'row-4'];
            rows.forEach(r => document.getElementById(r).innerHTML = '');
            picks.picks.slice(0, 11).forEach(p => {
                const meta = playerMap[p.element];
                const stats = liveStats[p.element];
                const target = rows[meta.element_type - 1];
                document.getElementById(target).innerHTML += createCard(meta, stats, p.is_captain);
            });

            // Render Threats (Top scorers not in your team)
            const ownedIds = picks.picks.map(p => p.element);
            const threats = boot.elements
                .filter(p => !ownedIds.includes(p.id))
                .sort((a,b) => (liveStats[b.id]?.total_points || 0) - (liveStats[a.id]?.total_points || 0))
                .slice(0, 10);

            const thrRows = ['thr-1', 'thr-2'];
            thrRows.forEach(r => document.getElementById(r).innerHTML = '');
            threats.forEach((p, i) => {
                const target = i < 5 ? 'thr-1' : 'thr-2';
                document.getElementById(target).innerHTML += createCard(p, liveStats[p.id], false);
            });
        }

        function createCard(p, s, isCap) {
            const bonus = s.bps > 25 ? (s.bps > 35 ? 3 : 2) : (s.bps > 20 ? 1 : 0);
            const color = p.cost_change_event >= 0 ? '#27ae60' : '#f43f5e';
            const progress = Math.abs(p.cost_change_event_fall || p.cost_change_event_rise || 0);

            return `
                <div class="mini-card">
                    <div class="match-status">${s.minutes > 0 ? (s.minutes < 90 ? s.minutes+"'" : 'FT') : 'WAIT'}</div>
                    <img class="mini-jersey" src="https://draft.premierleague.com/img/shirts/standard/shirt_${p.team_code}${p.element_type===1?'_1':''}-66.png">
                    <div class="card-body">
                        <div class="card-name-strip">${p.web_name}${isCap?'(C)':''}</div>
                        <div class="card-data">
                            ${s.total_points} ${bonus > 0 ? `<span class="p-bonus">â˜…${bonus}</span>` : ''}
                        </div>
                        <div class="price-bar"><div class="price-fill" style="width:${progress}%; background:${color}"></div></div>
                    </div>
                </div>`;
        }
    </script>
</body>
</html>
