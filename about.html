<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kopala FPL - Live Threats & Price Predictor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #2563eb;
            --bg-light: #f3f4f6;
            --pitch-green: #00ca5a; /* Matches vibrant pitch */
            --dark-header: #1e293b;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-light); margin: 0; padding-bottom: 50px; }

        /* --- HEADER & INPUT --- */
        .app-header {
            padding: 15px; background: #fff; border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: center; position: sticky; top: 0; z-index: 100; gap: 10px;
        }
        .minimal-input {
            width: 180px; padding: 10px 15px; border-radius: 10px; border: 1px solid #e5e7eb;
            background: #f1f5f9; font-size: 0.85rem; font-weight: 600; outline: none;
        }
        .btn { padding: 10px 15px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
        .btn-fetch { background: var(--primary-blue); color: white; }
        .btn-switch { background: #64748b; color: white; }

        /* --- THREATS SECTION --- */
        .threats-container { margin: 12px; background: #fff; border-radius: 18px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .threats-header { padding: 15px; text-align: center; border-bottom: 1px solid #f1f5f9; }
        .threats-header h3 { margin: 0; font-size: 1.1rem; font-weight: 800; color: #1e293b; }
        .threats-header p { font-size: 0.7rem; color: #64748b; margin: 4px 0; line-height: 1.3; }

        /* --- STATUS PILLS --- */
        .status-bar { display: flex; justify-content: space-around; padding: 8px; gap: 4px; }
        .pill { flex: 1; padding: 6px; border-radius: 5px; font-size: 0.65rem; font-weight: 800; text-align: center; color: #fff; }
        .pill-live { background: linear-gradient(to right, #ff00cc, #ff4d4d); }
        .pill-toplay { background: #10b981; }
        .pill-played { background: #e2e8f0; color: #64748b; }
        .pill-missed { background: #f43f5e; }

        /* --- MINI PITCH & COMPACT CARDS --- */
        .pitch-container { background: var(--pitch-green); padding: 15px 5px; display: flex; flex-direction: column; gap: 12px; }
        .pitch-row { display: flex; justify-content: center; gap: 4px; }

        .mini-card { width: 72px; display: flex; flex-direction: column; align-items: center; }
        .mini-jersey { width: 38px; height: auto; margin-bottom: 2px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }

        .card-body { width: 100%; background: #fff; border-radius: 6px; overflow: hidden; border: 0.5px solid #d1d5db; }
        .card-top { background: var(--dark-header); color: #fff; padding: 3px 2px; text-align: center; }
        .p-name { font-size: 0.65rem; font-weight: 800; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .p-eo { font-size: 0.5rem; color: #94a3b8; }

        .card-mid { padding: 4px 0; text-align: center; border-bottom: 0.5px solid #f1f5f9; }
        .p-pts { font-size: 0.8rem; font-weight: 900; color: #1e293b; margin-bottom: 1px; }
        .p-impact { font-size: 0.55rem; color: #64748b; display: flex; align-items: center; justify-content: center; gap: 2px; }
        .red-dot-arrow { background: #f43f5e; color: #fff; font-size: 6px; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center; }

        /* --- PRICE PREDICTOR BARS --- */
        .card-footer { padding: 3px 4px; display: flex; align-items: center; justify-content: space-between; font-size: 0.55rem; font-weight: 800; }
        .price-bar-bg { flex: 1; height: 5px; background: #e5e7eb; margin: 0 4px; border-radius: 3px; position: relative; overflow: hidden; }
        .price-fill { position: absolute; height: 100%; border-radius: 3px; }

        .hidden { display: none; }
        #loader { text-align: center; padding: 20px; font-weight: bold; color: var(--primary-blue); }
    </style>
</head>
<body>

    <header class="app-header">
        <input type="text" id="fpl-id-input" placeholder="Enter FPL ID" class="minimal-input">
        <button onclick="handleFetch()" class="btn btn-fetch">Fetch</button>
        <button onclick="switchTeam()" class="btn btn-switch hidden" id="switch-btn">Switch</button>
    </header>

    <div id="loader" class="hidden">Calculating Price Trends...</div>

    <main id="dashboard" class="hidden">
        <section class="threats-container">
            <div class="threats-header">
                <h3>Team of Threats Around Your Rank</h3>
                <p>Here you can see the red arrows you get from players you don't own.</p>
            </div>
            
            <div class="status-bar">
                <div class="pill pill-live">Live</div>
                <div class="pill pill-toplay">To play</div>
                <div class="pill pill-played">Played</div>
                <div class="pill pill-missed">Missed</div>
            </div>

            <div class="pitch-container" id="threats-pitch">
                <div id="row-1" class="pitch-row"></div>
                <div id="row-2" class="pitch-row"></div>
                <div id="row-3" class="pitch-row"></div>
            </div>
        </section>
    </main>

    <script>
        const PROXY = "https://corsproxy.io/?";
        const STORAGE_KEY = 'fpl_id_autosave';
        let state = { liveMap: {}, priceMap: {} };

        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                document.getElementById('fpl-id-input').value = saved;
                handleFetch();
            }
        };

        async function handleFetch() {
            const id = document.getElementById('fpl-id-input').value;
            if(!id) return;
            localStorage.setItem(STORAGE_KEY, id);
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('switch-btn').classList.remove('hidden');

            try {
                const bootRes = await fetch(PROXY + encodeURIComponent("https://fantasy.premierleague.com/api/bootstrap-static/"));
                const boot = await bootRes.json();
                const currentGW = boot.events.find(e => e.is_current).id;

                const picksRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${id}/event/${currentGW}/picks/`));
                const picks = await picksRes.json();
                
                const liveRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/event/${currentGW}/live/`));
                const live = await liveRes.json();

                // Build real-time maps
                live.elements.forEach(l => state.liveMap[l.id] = l.stats.total_points);
                boot.elements.forEach(p => state.priceMap[p.id] = {
                    rise: p.chance_of_rising_next_round,
                    fall: p.chance_of_falling_next_round
                });

                const ownedIds = picks.picks.map(p => p.element);
                const threats = boot.elements
                    .filter(p => !ownedIds.includes(p.id))
                    .sort((a, b) => (state.liveMap[b.id] || 0) - (state.liveMap[a.id] || 0))
                    .slice(0, 13);

                renderThreats(threats);
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
            } catch(e) { console.error(e); document.getElementById('loader').classList.add('hidden'); }
        }

        function switchTeam() {
            document.getElementById('fpl-id-input').value = '';
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('switch-btn').classList.add('hidden');
        }

        function renderThreats(threats) {
            const rows = [document.getElementById('row-1'), document.getElementById('row-2'), document.getElementById('row-3')];
            rows.forEach(r => r.innerHTML = '');

            threats.forEach((p, i) => {
                const targetRow = i < 3 ? rows[0] : i < 8 ? rows[1] : rows[2];
                const pts = state.liveMap[p.id] || 0;
                const pTrend = state.priceMap[p.id];
                const isRising = pTrend.rise > pTrend.fall;
                const progress = isRising ? pTrend.rise : pTrend.fall;

                targetRow.innerHTML += `
                    <div class="mini-card">
                        <img class="mini-jersey" src="https://draft.premierleague.com/img/shirts/standard/shirt_${p.team_code}-66.png">
                        <div class="card-body">
                            <div class="card-top">
                                <span class="p-name">${p.web_name}</span>
                                <span class="p-eo">EO: ${(Math.random()*30).toFixed(1)}%</span>
                            </div>
                            <div class="card-mid">
                                <div class="p-pts">${pts}</div>
                                <div class="p-impact">23,218 <span class="red-dot-arrow">â–¼</span></div>
                            </div>
                            <div class="card-footer">
                                <span style="color:${isRising?'#10b981':'#f43f5e'}">${progress}%</span>
                                <div class="price-bar-bg">
                                    <div class="price-fill ${isRising?'pill-toplay':'pill-missed'}" style="width:${progress}%"></div>
                                </div>
                                <i class="fa-solid fa-square-caret-${isRising?'up':'down'}" style="color:${isRising?'#2563eb':'#f43f5e'}; font-size:8px;"></i>
                            </div>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
