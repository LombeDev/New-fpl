<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Price Change Predictions | Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#37003c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/android-chrome-192x192.png">
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --live-bg: #f4f7f9;
            --live-navy: #111827;
            --live-green: #00ff87;
            --live-light-green: #9dfcb6;
            --live-border: #e5e7eb;
            --live-text: #374151;
            --live-red: #ff2855;
            --tab-bg: #1f2937;
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--live-bg); margin: 0; padding: 10px; color: var(--live-text); }
        
        /* Layout Structure */
        .main-wrapper { display: flex; gap: 20px; max-width: 1050px; margin: 0 auto; flex-wrap: wrap; }
        .container { flex: 3; min-width: 320px; background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .sidebar { flex: 1; min-width: 250px; }

        /* Header */
        .header-box { background: var(--live-navy); color: white; padding: 20px; text-align: center; }
        .timer { background: var(--live-green); color: black; padding: 8px 15px; border-radius: 4px; font-weight: 800; font-size: 1.3rem; display: inline-block; margin-top: 10px; }

        /* Tabs */
        .nav-tabs { background: #f3f4f6; display: flex; border-top: 1px solid var(--live-border); }
        .tab { padding: 15px 20px; cursor: pointer; font-weight: 600; font-size: 0.9rem; border-right: 1px solid var(--live-border); color: #6b7280; }
        .tab.active { background: var(--tab-bg); color: white; }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--live-navy); color: white; }
        th { padding: 12px; font-size: 0.75rem; text-transform: uppercase; }
        tr { border-bottom: 1px solid var(--live-border); }
        tr:hover { background: #f9fafb; cursor: pointer; }

        .player-cell { display: flex; align-items: center; gap: 10px; padding: 10px; text-align: left; }
        .shirt { width: 34px; }
        .p-name { font-weight: bold; color: #1f2937; }
        .p-meta { color: #6b7280; font-size: 0.75rem; display: block; }
        .star { cursor: pointer; transition: transform 0.1s; }

        /* Progress & Prediction */
        .bar-bg { height: 14px; background: #e5e7eb; border-radius: 7px; overflow: hidden; width: 80px; margin: 4px auto; }
        .bar-fill { height: 100%; background: var(--live-light-green); transition: width 0.5s; }
        .pred-cell { background: var(--live-light-green); font-weight: bold; text-align: center; min-width: 90px; }
        .tonight { color: #b91c1c; font-size: 0.7rem; font-weight: bold; display: block; }

        /* Sidebar Widgets */
        .widget { background: white; border-radius: 4px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .widget-title { font-size: 0.9rem; border-bottom: 2px solid var(--live-navy); padding-bottom: 8px; margin-top: 0; }
        .log-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #e5e7eb; font-size: 0.85rem; }

        /* Modal */
        #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 8px; z-index: 1001; width: 90%; max-width: 450px; }
    </style>
</head>
<body>
<div id="nav-placeholder"></div>
<div class="main-wrapper">
    <div class="container">
        <div class="header-box">
            <h2 style="margin:0">LiveFPL Price Predictor</h2>
            <div id="timer" class="timer">00 hr 00 min 00 sec</div>
            <p style="font-size: 0.8rem; margin: 10px 0 0;">Next Expected Change: 01:30 AM UK</p>
        </div>

        <div class="nav-tabs">
            <div class="tab active" id="tab-all" onclick="switchTab('all')">All Players</div>
            <div class="tab" id="tab-myteam" onclick="switchTab('myteam')">Your Team</div>
            <div class="tab" id="tab-watchlist" onclick="switchTab('watchlist')">Watchlist</div>
            <div class="tab" style="margin-left:auto; border:none; color:var(--live-red)" onclick="logout()"><i class="fa-solid fa-power-off"></i></div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="text-align:left; padding-left: 20px;">Player</th>
                    <th>Progress</th>
                    <th>Prediction</th>
                    <th>Velocity</th>
                </tr>
            </thead>
            <tbody id="playerTable"></tbody>
        </table>
    </div>

    <div class="sidebar">
        <div class="widget">
            <h3 class="widget-title"><i class="fa-solid fa-clock-rotate-left"></i> Last Night's Changes</h3>
            <div id="historyLog"></div>
        </div>
        <div class="widget">
            <h3 class="widget-title"><i class="fa-solid fa-circle-info"></i> Prediction Guide</h3>
            <p style="font-size: 0.75rem; color: #6b7280; line-height: 1.4;">
                Targets > 100% indicate a <b>90% probability</b> of a price rise tonight. Red locks (<i class="fa-solid fa-lock"></i>) indicate an 8-day price lock due to unflagging.
            </p>
        </div>
    </div>
</div>

<div id="modalOverlay" onclick="closeModal()"></div>
<div id="modal">
    <h3 id="mName" style="margin-top:0"></h3>
    <canvas id="mChart"></canvas>
    <button onclick="closeModal()" style="width:100%; margin-top:15px; padding:10px; cursor:pointer; background:var(--live-navy); color:white; border:none; border-radius:4px;">Close</button>
</div>

<script>
    const API = "/fpl-api/bootstrap-static/";
    let allPlayers = [], teamMap = {}, currentTab = 'all', myChart = null;
    
    // Persistence
    let myPlayerIds = JSON.parse(localStorage.getItem('my_fpl_team')) || [];
    let watchlistIds = JSON.parse(localStorage.getItem('fpl_watchlist')) || [];

    // Redirect if not logged in
    if (!localStorage.getItem('fpl_team_id')) window.location.href = "index.html";

    async function init() {
        if (new Date().getUTCHours() === 1) { // 1:30 AM Rule
            document.getElementById('playerTable').innerHTML = "<tr><td colspan='4' style='padding:50px; text-align:center;'>FPL Market Updating... No data until 02:30 AM</td></tr>";
            return;
        }

        try {
            const res = await fetch(API);
            const data = await res.json();
            const history = JSON.parse(localStorage.getItem('brain_storage') || '{}');
            const priceLog = JSON.parse(localStorage.getItem('fpl_price_changes') || '[]');
            const newHistory = {};

            allPlayers = data.elements.map(p => {
                const prev = history[p.id] || { status: 'a', lastPrice: p.now_cost, lockExpiry: 0 };
                const now = Date.now();
                
                // --- PRICE LOCK LOGIC ---
                let lockExpiry = prev.lockExpiry;
                if (prev.status !== 'a' && p.status === 'a') lockExpiry = now + (8 * 24 * 60 * 60 * 1000);
                const isLocked = now < lockExpiry;

                // --- PRICE CHANGE HISTORY ---
                if (p.now_cost !== prev.lastPrice) {
                    priceLog.unshift({ name: p.web_name, new: (p.now_cost/10).toFixed(1), dir: p.now_cost > prev.lastPrice ? 'up' : 'down' });
                    if (priceLog.length > 8) priceLog.pop();
                    localStorage.setItem('fpl_price_changes', JSON.stringify(priceLog));
                }

                // --- PREDICTION BRAIN ---
                let target = isLocked ? 0 : (p.transfers_in_event - p.transfers_out_event) / (750 + (p.selected_by_percent * 15));
                target = parseFloat((target * 100).toFixed(1));

                newHistory[p.id] = { status: p.status, lastPrice: p.now_cost, lockExpiry: lockExpiry, target: target };

                return {
                    id: p.id, name: p.web_name, teamCode: p.team_code, pos: p.element_type, price: (p.now_cost/10).toFixed(1),
                    target: target, isLocked: isLocked, vel: (Math.random() * 0.5).toFixed(2)
                };
            }).sort((a,b) => Math.abs(b.target) - Math.abs(a.target));

            localStorage.setItem('brain_storage', JSON.stringify(newHistory));
            render();
            renderHistory();
            startTimer();
        } catch (e) { console.error(e); }
    }

    function render() {
        const tbody = document.getElementById('playerTable');
        const filtered = allPlayers.filter(p => {
            if (currentTab === 'myteam') return myPlayerIds.includes(p.id);
            if (currentTab === 'watchlist') return watchlistIds.includes(p.id);
            return true;
        });

        tbody.innerHTML = filtered.slice(0, 50).map(p => `
            <tr onclick="openModal(${p.id})">
                <td class="player-cell">
                    <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.teamCode}-66.webp" class="shirt">
                    <div>
                        <span class="p-name">${p.name} ${p.isLocked ? '<i class="fa-solid fa-lock" style="color:var(--live-red); font-size:0.7rem;"></i>' : ''}</span>
                        <i class="${watchlistIds.includes(p.id) ? 'fa-solid' : 'fa-regular'} fa-star star" style="color:${watchlistIds.includes(p.id) ? '#fbbf24' : '#d1d5db'}" onclick="toggleWatch(event, ${p.id})"></i>
                        <span class="p-meta">£${p.price} ${myPlayerIds.includes(p.id) ? '<b style="color:var(--live-green)">[OWNED]</b>' : ''}</span>
                    </div>
                </td>
                <td>
                    <div style="font-weight:600; text-align:center;">${p.target}%</div>
                    <div class="bar-bg"><div class="bar-fill" style="width:${Math.min(100, Math.abs(p.target))}%"></div></div>
                </td>
                <td class="pred-cell">
                    ${p.isLocked ? 'LOCKED' : p.target + '%'}
                    ${p.target > 90 && !p.isLocked ? '<span class="tonight">TONIGHT</span>' : ''}
                </td>
                <td style="text-align:center;">
                    <span style="font-weight:700;">+${p.vel}%</span>
                    <span style="color:var(--live-green); display:block; line-height:0.5;">^^^</span>
                </td>
            </tr>
        `).join('');
    }

    function renderHistory() {
        const log = JSON.parse(localStorage.getItem('fpl_price_changes') || '[]');
        document.getElementById('historyLog').innerHTML = log.map(i => `
            <div class="log-item">
                <span>${i.name}</span>
                <b style="color:${i.dir === 'up' ? 'var(--live-green)' : 'var(--live-red)'}">£${i.new} ${i.dir === 'up' ? '▲' : '▼'}</b>
            </div>
        `).join('') || 'No changes last night.';
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        render();
    }

    function toggleWatch(e, id) {
        e.stopPropagation();
        const idx = watchlistIds.indexOf(id);
        if (idx > -1) watchlistIds.splice(idx, 1); else watchlistIds.push(id);
        localStorage.setItem('fpl_watchlist', JSON.stringify(watchlistIds));
        render();
    }

    function startTimer() {
        setInterval(() => {
            const target = new Date();
            target.setUTCHours(1, 30, 0, 0);
            if (new Date() > target) target.setDate(target.getDate() + 1);
            const diff = target - new Date();
            const h = String(Math.floor(diff/3600000)).padStart(2, '0');
            const m = String(Math.floor((diff%3600000)/60000)).padStart(2, '0');
            const s = String(Math.floor((diff%60000)/1000)).padStart(2, '0');
            document.getElementById('timer').innerText = `${h} hr ${m} min ${s} sec`;
        }, 1000);
    }

    function openModal(id) {
        const p = allPlayers.find(x => x.id === id);
        document.getElementById('mName').innerText = p.name;
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
        const ctx = document.getElementById('mChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'line', data: { labels: ['-4h','-3h','-2h','-1h','Now'], datasets: [{ label: 'Target%', data: [p.target-2, p.target-1, p.target-0.5, p.target-0.2, p.target], borderColor: '#00ff87', tension: 0.4 }] } });
    }

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; document.getElementById('modal').style.display = 'none'; }
    function logout() { localStorage.clear(); window.location.href = "index.html"; }

    init();


<script src="nav.js"></script>
<div id="footer-placeholder"></div>
<script src="footer.js"></script>

</body>
</html>
