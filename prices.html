<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Predictor | LiveFPL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --nav-bg: #0b1120;
            --body-bg: #f8fafc;
            --fpl-primary: #00ff85;
            --fpl-danger: #ff005a;
            --border-color: #e2e8f0;
            --text-muted: #64748b;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--body-bg); color: #1e293b; }

        /* Navigation */
        .top-nav { background: var(--nav-bg); display: flex; justify-content: center; padding: 10px 0; gap: 35px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: white; text-decoration: none; font-size: 10px; font-weight: 600; opacity: 0.7; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; color: #475569; }
        .nav-item.active { opacity: 1; }
        .nav-item.active i { color: var(--fpl-primary); }

        /* Header */
        .header { text-align: center; padding: 25px 0; background: #fff; border-bottom: 1px solid var(--border-color); }
        .header h1 { font-size: 24px; margin: 0 0 15px 0; font-weight: 800; }
        .timer-banner { background: #f1f5f9; padding: 10px 20px; border-radius: 4px; display: inline-flex; align-items: center; font-weight: bold; font-size: 13px; }
        .timer-box { background: var(--fpl-primary); color: #000; padding: 5px 12px; border-radius: 3px; margin-left: 10px; font-family: monospace; }

        .main-container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }

        /* Search & Toggle Row */
        .controls-row { background: #fff; border: 1px solid var(--border-color); border-radius: 8px 8px 0 0; padding: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .search-box { flex: 2; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; min-width: 200px; }
        
        .toggle-container { display: flex; flex: 1; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; min-width: 250px; }
        .toggle-btn { flex: 1; padding: 10px; text-align: center; font-weight: bold; cursor: pointer; color: var(--text-muted); font-size: 13px; border: none; background: #fff; }
        .toggle-btn.active.rise { background: #f0fff4; color: #166534; border-bottom: 3px solid var(--fpl-primary); }
        .toggle-btn.active.fall { background: #fff5f5; color: #991b1b; border-bottom: 3px solid var(--fpl-danger); }

        /* Table */
        .table-wrap { background: #fff; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        thead th { background: #0f172a; color: #fff; text-align: left; padding: 12px; font-size: 11px; text-transform: uppercase; }
        tbody td { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 14px; }

        .bar-bg { width: 100px; height: 6px; background: #e2e8f0; border-radius: 10px; margin-top: 5px; }
        .bar-fill { height: 100%; border-radius: 10px; }
        
        .urgent { background: #dcfce7 !important; font-weight: bold; color: #166534; }
        .urgent-fall { background: #fee2e2 !important; font-weight: bold; color: #991b1b; }
        .tonight { color: #ef4444; font-size: 10px; display: block; font-weight: 800; }
        .price-val { font-family: monospace; font-weight: bold; }

        #loader { padding: 40px; text-align: center; font-weight: bold; background: white; border: 1px solid var(--border-color); }
        .cache-controls { text-align: center; font-size: 11px; color: var(--text-muted); margin-top: 15px; }
        .refresh-btn { cursor: pointer; color: #3b82f6; border: none; background: none; text-decoration: underline; font-size: 11px; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-trophy"></i>Home</a>
        <a href="prices.html" class="nav-item active"><i class="fa-solid fa-dollar-sign"></i>Price Predictor</a>
        <a href="#" class="nav-item"><i class="fa-solid fa-soccer-ball"></i>Games</a>
    </nav>

    <div class="header">
        <h1>Live Price Change Predictor</h1>
        <div class="timer-banner">
            Next price change: <span id="timer" class="timer-box">--:--:--</span>
        </div>
    </div>

    <div class="main-container">
        <div class="controls-row">
            <input type="text" id="playerSearch" class="search-box" placeholder="Search for a player...">
            <div class="toggle-container">
                <button id="btnRise" class="toggle-btn active rise">Price Rises</button>
                <button id="btnFall" class="toggle-btn fall">Price Falls</button>
            </div>
        </div>

        <div id="loader"><i class="fas fa-sync fa-spin"></i> Checking FPL Servers...</div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Progress</th>
                        <th>Price Change</th>
                        <th>Prediction</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody id="predictor-body"></tbody>
            </table>
        </div>

        <div class="cache-controls">
            <span id="cacheStatus">Syncing...</span> | 
            <button class="refresh-btn" onclick="forceRefresh()">Force Update</button>
        </div>
    </div>

<div class="ticker-container">
    <div class="ticker-header">FPL Fixture Ticker (Upcoming)</div>
    <div id="ticker-loader" style="padding: 20px; text-align: center;">
        <i class="fas fa-sync fa-spin"></i> Loading Fixtures...
    </div>
    <div class="ticker-table-wrap">
        <table class="ticker-table" id="ticker-table" style="display:none;">
            <thead>
                <tr id="ticker-gw-headers">
                    <th style="text-align: left; padding-left:15px;">Team</th>
                </tr>
            </thead>
            <tbody id="ticker-body"></tbody>
        </table>
    </div>
</div>


    
    <script>
        const API_URL = "https://fantasy.premierleague.com/api/bootstrap-static/";
        const PROXIES = [
            "https://api.allorigins.win/get?url=",
            "https://corsproxy.io/?url="
        ];
        const CACHE_KEY = "fpl_price_data";
        const CACHE_TIME = "fpl_price_timestamp";
        const AGGRESSIVE_LIMIT = 5 * 60 * 60 * 1000; 

        let allPlayers = [];
        let viewMode = 'rise';

        async function init(force = false) {
            const lastFetched = localStorage.getItem(CACHE_TIME);
            const now = Date.now();

            if (!force && lastFetched && (now - lastFetched < AGGRESSIVE_LIMIT)) {
                processData(JSON.parse(localStorage.getItem(CACHE_KEY)));
                updateCacheUI(lastFetched, true);
                return;
            }

            let data = null;
            for (let proxy of PROXIES) {
                try {
                    const response = await fetch(`${proxy}${encodeURIComponent(API_URL)}`);
                    if (!response.ok) throw new Error("Network error");
                    const result = await response.json();
                    data = result.contents ? JSON.parse(result.contents) : result;
                    if (data) break; 
                } catch (e) { console.warn(`Proxy failed: ${proxy}`); }
            }

            if (data) {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIME, now.toString());
                processData(data);
                updateCacheUI(now, false);
            } else if (localStorage.getItem(CACHE_KEY)) {
                processData(JSON.parse(localStorage.getItem(CACHE_KEY)));
                document.getElementById('cacheStatus').innerText = "⚠️ Failed to sync. Using offline data.";
                document.getElementById('loader').style.display = 'none';
            }
        }

        function updateCacheUI(time, isCached) {
            const date = new Date(parseInt(time));
            document.getElementById('cacheStatus').innerHTML = 
                `5hr Safe Mode Active (Last Sync: <b>${date.toLocaleTimeString()}</b>)`;
        }

        function processData(data) {
            const teams = Object.fromEntries(data.teams.map(t => [t.id, t.short_name]));
            allPlayers = data.elements.map(p => {
                const net = p.transfers_in_event - p.transfers_out_event;
                const prog = (net / 480);
                const currentPrice = p.now_cost / 10;
                return {
                    name: p.web_name,
                    team: teams[p.team],
                    price: currentPrice.toFixed(1),
                    newPrice: (viewMode === 'rise' ? currentPrice + 0.1 : currentPrice - 0.1).toFixed(1),
                    prog: parseFloat(prog.toFixed(1)),
                    pred: parseFloat((prog * 1.05).toFixed(1)),
                    pos: ["", "GKP", "DEF", "MID", "FWD"][p.element_type]
                };
            });
            document.getElementById('loader').style.display = 'none';
            render();
        }

        function render() {
            const body = document.getElementById('predictor-body');
            const searchVal = document.getElementById('playerSearch').value.toLowerCase();
            
            const filtered = allPlayers.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchVal);
                const matchesView = (viewMode === 'rise' ? p.prog >= -5 : p.prog < 0);
                return matchesSearch && matchesView;
            }).sort((a,b) => viewMode === 'rise' ? b.prog - a.prog : a.prog - b.prog);

            body.innerHTML = filtered.slice(0, 50).map(p => {
                const isUrgent = Math.abs(p.pred) >= 100;
                const highlight = isUrgent ? (viewMode === 'rise' ? 'urgent' : 'urgent-fall') : '';
                const barColor = viewMode === 'rise' ? '#00ff85' : '#ff005a';
                const nextPrice = (parseFloat(p.price) + (viewMode === 'rise' ? 0.1 : -0.1)).toFixed(1);

                return `
                    <tr>
                        <td>
                            <strong>${p.name}</strong><br>
                            <small style="color:var(--text-muted)">${p.pos}</small>
                        </td>
                        <td>${p.team}</td>
                        <td>
                            ${p.prog}%
                            <div class="bar-bg"><div class="bar-fill" style="width:${Math.min(Math.max(Math.abs(p.prog), 5), 100)}%; background:${barColor}"></div></div>
                        </td>
                        <td class="price-val">
                            £${p.price} <i class="fas fa-long-arrow-alt-right"></i> <span style="color:${barColor}">£${nextPrice}</span>
                        </td>
                        <td class="${highlight}">
                            ${p.pred}%
                            ${isUrgent ? '<span class="tonight">⚠️ TONIGHT</span>' : ''}
                        </td>
                        <td><i class="fa-solid fa-arrow-${viewMode === 'rise' ? 'up' : 'down'}" style="color:${barColor}"></i></td>
                    </tr>
                `;
            }).join('');
        }

        function forceRefresh() { init(true); }

        document.getElementById('btnRise').onclick = () => { viewMode = 'rise'; document.getElementById('btnRise').classList.add('active'); document.getElementById('btnFall').classList.remove('active'); render(); };
        document.getElementById('btnFall').onclick = () => { viewMode = 'fall'; document.getElementById('btnFall').classList.add('active'); document.getElementById('btnRise').classList.remove('active'); render(); };
        document.getElementById('playerSearch').oninput = render;

        setInterval(() => {
            const now = new Date();
            const h = 25 - now.getUTCHours();
            document.getElementById('timer').innerText = `${h % 24}h ${60-now.getUTCMinutes()}m ${60-now.getUTCSeconds()}s`;
        }, 1000);

        init();
    </script>
</body>
</html>
