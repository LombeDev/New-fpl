<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Market Tracker | Kopala FPL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --live-green: #00ff87;
            --live-red: #ff2e63;
            --dark-surface: #1a202c;
            --card-border: #e2e8f0;
        }

        body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 0; color: #1a202c; }

        /* Accurate LiveFPL Header */
        .market-status-bar {
            background: var(--dark-surface);
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 0.7rem;
            border-bottom: 4px solid var(--live-green);
        }
        .time-highlight { color: var(--live-green); font-weight: 900; font-size: 0.9rem; margin-left: 5px; }

        /* Layout Grid */
        .summary-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
        }

        .summary-box {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            padding: 10px;
        }

        .summary-header {
            font-size: 0.75rem;
            font-weight: 900;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1.5px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
        }

        /* Player Item Design */
        .mini-player-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #f8fafc;
        }
        .mini-shirt { width: 22px; height: auto; }
        .mini-info { flex: 1; overflow: hidden; }
        .mini-name { font-size: 0.75rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .mini-price { font-size: 0.65rem; color: #64748b; font-weight: 600; }
        
        .change-indicator {
            font-size: 0.65rem;
            font-weight: 900;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .up-bg { color: var(--live-green); }
        .down-bg { color: var(--live-red); }

        /* Filter Controls */
        .nav-pills {
            display: flex;
            background: white;
            padding: 10px 15px;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid var(--card-border);
        }
        .pill {
            padding: 6px 15px;
            border-radius: 20px;
            background: #f1f5f9;
            font-size: 0.7rem;
            font-weight: 800;
            white-space: nowrap;
            border: none;
            color: #64748b;
        }
        .pill.active { background: #2563eb; color: white; }

        .urgent-tag {
            background: #eff6ff;
            color: #2563eb;
            font-size: 0.55rem;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 900;
        }
    </style>
</head>
<body>
<div id="nav-placeholder"></div>

<div class="market-status-bar">
    Prices tend to move at 01:30 UTC. Next window:
    <span id="countdown" class="time-highlight">--:--:--</span>
</div>

<div class="nav-pills">
    <button class="pill active">Predictions</button>
    <button class="pill">Actual Changes</button>
    <button class="pill">Watchlist</button>
</div>

<div class="summary-container">
    <div class="summary-box">
        <div class="summary-header">
            <span>RISE TONIGHT</span>
            <span style="color:var(--live-green)" id="rise-count">(0)</span>
        </div>
        <div id="rise-list"></div>
    </div>

    <div class="summary-box">
        <div class="summary-header">
            <span>FALL TONIGHT</span>
            <span style="color:var(--live-red)" id="fall-count">(0)</span>
        </div>
        <div id="fall-list"></div>
    </div>
</div>

<script>
    const PROXY = "/.netlify/functions/fpl-proxy?endpoint=bootstrap-static/";
    let players = [];

    async function fetchData() {
        try {
            const res = await fetch(PROXY);
            const data = await res.json();
            
            // Reverse Engineering High-Precision Logic
            players = data.elements.map(p => {
                const net = p.transfers_in_event - p.transfers_out_event;
                const ownership = parseFloat(p.selected_by_percent);
                
                // LiveFPL Constant: Base 5000 + (Ownership * Variable Scaling)
                // This accounts for why popular players need more transfers to move
                let threshold = 6500 + (ownership * 1650); 
                
                // If player is flagged (Injured/Suspended), threshold is 3x harder to reach
                if (p.status !== 'a') threshold *= 3.0;

                // Locked Status Check: If they changed price yesterday, they are often protected
                const isLocked = (p.cost_change_event !== 0);
                
                const target = (net / threshold) * 100;

                return {
                    name: p.web_name,
                    team: p.team_code,
                    price: (p.now_cost / 10).toFixed(1),
                    target: isLocked ? (target * 0.5) : target, // Dampen prediction if they just moved
                    net: net,
                    status: p.status
                };
            });

            renderSections();
        } catch (e) { console.error("Market Sync Error"); }
    }

    function renderSections() {
        const riseList = document.getElementById('rise-list');
        const fallList = document.getElementById('fall-list');

        const risers = players.filter(p => p.target >= 90).sort((a,b) => b.target - a.target);
        const fallers = players.filter(p => p.target <= -90).sort((a,b) => a.target - b.target);

        document.getElementById('rise-count').innerText = `(${risers.length})`;
        document.getElementById('fall-count').innerText = `(${fallers.length})`;

        riseList.innerHTML = risers.length ? risers.map(p => miniCard(p, 'up')).join('') : '<p style="font-size:0.6rem; color:#94a3b8">None predicted</p>';
        fallList.innerHTML = fallers.length ? fallers.map(p => miniCard(p, 'down')).join('') : '<p style="font-size:0.6rem; color:#94a3b8">None predicted</p>';
    }

    function miniCard(p, dir) {
        return `
            <div class="mini-player-row">
                <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.team}-66.webp" class="mini-shirt">
                <div class="mini-info">
                    <span class="mini-name">${p.name} ${p.target >= 100 ? '<span class="urgent-tag">100%</span>' : ''}</span>
                    <span class="mini-price">Â£${p.price}</span>
                </div>
                <div class="change-indicator ${dir === 'up' ? 'up-bg' : 'down-bg'}">
                    <i class="fa-solid fa-circle-${dir === 'up' ? 'chevron-up' : 'chevron-down'}"></i>
                </div>
            </div>
        `;
    }

    function updateTimer() {
        const now = new Date();
        const target = new Date();
        target.setUTCHours(1, 30, 0, 0);
        if (now > target) target.setUTCDate(target.getUTCDate() + 1);
        const diff = target - now;
        const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
        const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
        const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
        document.getElementById('countdown').innerText = `${h}:${m}:${s}`;
    }

    fetchData();
    setInterval(updateTimer, 1000);
</script>

<div id="footer-placeholder"></div>
</body>
</html>