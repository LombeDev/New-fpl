<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Predictor | LiveFPL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --nav-bg: #0b1120;
            --body-bg: #f8fafc;
            --fpl-primary: #00ff85;
            --fpl-danger: #ff005a;
            --border-color: #e2e8f0;
            --text-muted: #64748b;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--body-bg); color: #1e293b; }

        /* Navigation */
        .top-nav { background: var(--nav-bg); display: flex; justify-content: center; padding: 10px 0; gap: 35px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: white; text-decoration: none; font-size: 10px; font-weight: 600; opacity: 0.7; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; color: #475569; }
        .nav-item.active { opacity: 1; }
        .nav-item.active i { color: var(--fpl-primary); }

        /* Header */
        .header { text-align: center; padding: 30px 0; background: #fff; border-bottom: 1px solid var(--border-color); }
        .header h1 { font-size: 24px; margin: 0 0 15px 0; font-weight: 800; }
        .timer-banner { background: #f1f5f9; padding: 10px 20px; border-radius: 4px; display: inline-flex; align-items: center; font-weight: bold; font-size: 13px; }
        .timer-box { background: var(--fpl-primary); color: #000; padding: 5px 12px; border-radius: 3px; margin-left: 10px; font-family: monospace; }

        .main-container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }

        /* Rise/Fall Toggle */
        .toggle-container { display: flex; background: #fff; border: 1px solid var(--border-color); border-bottom: none; border-radius: 8px 8px 0 0; overflow: hidden; }
        .toggle-btn { flex: 1; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; color: var(--text-muted); border-bottom: 3px solid transparent; transition: 0.2s; }
        .toggle-btn.active.rise { border-bottom-color: var(--fpl-primary); color: #000; background: #fafffb; }
        .toggle-btn.active.fall { border-bottom-color: var(--fpl-danger); color: #000; background: #fffafb; }

        /* Table */
        .table-wrap { background: #fff; border: 1px solid var(--border-color); border-radius: 0 0 8px 8px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        thead th { background: #0f172a; color: #fff; text-align: left; padding: 12px; font-size: 12px; text-transform: uppercase; }
        tbody td { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 14px; }

        .bar-bg { width: 100px; height: 6px; background: #e2e8f0; border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; }
        
        .urgent { background: #dcfce7 !important; font-weight: bold; color: #166534; text-align: center; }
        .urgent-fall { background: #fee2e2 !important; font-weight: bold; color: #991b1b; text-align: center; }
        .tonight { color: #ef4444; font-size: 10px; display: block; font-weight: 800; }

        #loader { padding: 40px; text-align: center; font-weight: bold; background: white; border: 1px solid var(--border-color); }
        
        .cache-controls { text-align: center; font-size: 11px; color: var(--text-muted); margin-top: 15px; padding: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .refresh-btn { cursor: pointer; color: #3b82f6; text-decoration: underline; border: none; background: none; font-size: 11px; }
        .refresh-btn:hover { color: #2563eb; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-trophy"></i>Home</a>
        <a href="prices.html" class="nav-item active"><i class="fa-solid fa-dollar-sign"></i>Prices change predictor</a>
        <a href="#" class="nav-item"><i class="fa-solid fa-soccer-ball"></i>Games</a>
    </nav>

    <div class="header">
        <h1>Live Price Change Predictor</h1>
        <div class="timer-banner">
            Next price change countdown: <span id="timer" class="timer-box">--:--:--</span>
        </div>
    </div>

    <div class="main-container">
        <div class="toggle-container">
            <div id="btnRise" class="toggle-btn active rise">Price Rises</div>
            <div id="btnFall" class="toggle-btn fall">Price Falls</div>
        </div>

        <div id="loader"><i class="fas fa-sync fa-spin"></i> Loading Data...</div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Progress</th>
                        <th>Prediction</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody id="predictor-body"></tbody>
            </table>
        </div>

        <div class="cache-controls">
            <span id="cacheStatus">Checking cache...</span>
            <button class="refresh-btn" onclick="forceRefresh()"><i class="fas fa-redo"></i> Force Update</button>
        </div>
    </div>

    <script>
        const API_URL = "https://fantasy.premierleague.com/api/bootstrap-static/";
        const PROXY_URL = "https://api.allorigins.win/get?url=";
        const CACHE_KEY = "fpl_price_data";
        const CACHE_TIME = "fpl_price_timestamp";
        const AGGRESSIVE_LIMIT = 5 * 60 * 60 * 1000; // 5 HOURS CACHE

        let allPlayers = [];
        let viewMode = 'rise';

        async function init(force = false) {
            const lastFetched = localStorage.getItem(CACHE_TIME);
            const now = Date.now();

            // STEP 1: Aggressive Cache Check (5-hour limit)
            if (!force && lastFetched && (now - lastFetched < AGGRESSIVE_LIMIT)) {
                const data = JSON.parse(localStorage.getItem(CACHE_KEY));
                processData(data);
                updateCacheUI(lastFetched, true);
                return;
            }

            // STEP 2: Fetch if expired or forced
            try {
                document.getElementById('loader').style.display = 'block';
                const response = await fetch(`${PROXY_URL}${encodeURIComponent(API_URL)}`);
                if (!response.ok) throw new Error("403 Forbidden");
                
                const wrapper = await response.json();
                const data = JSON.parse(wrapper.contents);

                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIME, now.toString());
                
                processData(data);
                updateCacheUI(now, false);
            } catch (err) {
                console.error("API Error:", err);
                if (localStorage.getItem(CACHE_KEY)) {
                    processData(JSON.parse(localStorage.getItem(CACHE_KEY)));
                    document.getElementById('cacheStatus').innerText = "⚠️ API Error. Using stored data.";
                } else {
                    document.getElementById('loader').innerHTML = "Access Denied (403). Try again later.";
                }
            }
        }

        function forceRefresh() {
            init(true);
        }

        function updateCacheUI(time, isCached) {
            const date = new Date(parseInt(time));
            document.getElementById('cacheStatus').innerHTML = 
                `Data valid for 5 hrs (Updated: <b>${date.toLocaleTimeString()}</b>).`;
        }

        function processData(data) {
            const teams = Object.fromEntries(data.teams.map(t => [t.id, t.short_name]));
            allPlayers = data.elements.map(p => {
                const net = p.transfers_in_event - p.transfers_out_event;
                const prog = (net / 480);
                return {
                    name: p.web_name,
                    team: teams[p.team],
                    price: (p.now_cost / 10).toFixed(1),
                    prog: parseFloat(prog.toFixed(1)),
                    pred: parseFloat((prog * 1.05).toFixed(1)),
                    pos: ["", "GKP", "DEF", "MID", "FWD"][p.element_type]
                };
            });
            document.getElementById('loader').style.display = 'none';
            render();
        }

        function render() {
            const body = document.getElementById('predictor-body');
            const filtered = allPlayers.filter(p => 
                (viewMode === 'rise' ? p.prog >= -5 : p.prog < 0)
            ).sort((a,b) => viewMode === 'rise' ? b.prog - a.prog : a.prog - b.prog);

            body.innerHTML = filtered.slice(0, 50).map(p => {
                const isUrgent = Math.abs(p.pred) >= 100;
                const highlight = isUrgent ? (viewMode === 'rise' ? 'urgent' : 'urgent-fall') : '';
                const barColor = viewMode === 'rise' ? '#00ff85' : '#ff005a';

                return `
                    <tr>
                        <td>
                            <strong>${p.name}</strong><br>
                            <small style="color:var(--text-muted)">${p.pos} £${p.price}</small>
                        </td>
                        <td>${p.team}</td>
                        <td>
                            ${p.prog}%
                            <div class="bar-bg"><div class="bar-fill" style="width:${Math.min(Math.max(Math.abs(p.prog), 5), 100)}%; background:${barColor}"></div></div>
                        </td>
                        <td class="${highlight}">
                            ${p.pred}%
                            ${isUrgent ? '<span class="tonight">⚠️ TONIGHT</span>' : ''}
                        </td>
                        <td><i class="fa-solid fa-arrow-${viewMode === 'rise' ? 'up' : 'down'}" style="color:${barColor}"></i></td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('btnRise').onclick = () => { viewMode = 'rise'; document.getElementById('btnRise').classList.add('active'); document.getElementById('btnFall').classList.remove('active'); render(); };
        document.getElementById('btnFall').onclick = () => { viewMode = 'fall'; document.getElementById('btnFall').classList.add('active'); document.getElementById('btnRise').classList.remove('active'); render(); };

        setInterval(() => {
            const now = new Date();
            const h = 25 - now.getUTCHours();
            document.getElementById('timer').innerText = `${h % 24}h ${60-now.getUTCMinutes()}m ${60-now.getUTCSeconds()}s`;
        }, 1000);

        init();
    </script>
</body>
</html>
