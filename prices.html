<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prices - Kopala FPL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #2563eb;
            --fpl-green: #00ff85;
            --fpl-pink: #e90052;
            --border-color: #e2e8f0;
            --header-dark: #0f172a;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, system-ui, sans-serif;
            padding-top: 70px;
            padding-bottom: 90px;
            transition: background 0.3s ease;
        }

        /* Top Navigation */
        .top-nav {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: var(--card-bg); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 3000;
        }
        .logo-container { font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; }
        .logo-container span { color: var(--fpl-green); }
        .nav-icon-btn { font-size: 1.2rem; cursor: pointer; color: var(--text-main); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; }

        /* Timer Banner */
        .timer-banner { background: var(--header-dark); color: white; margin: 8px; padding: 15px; border-radius: 12px; text-align: center; }
        .countdown-display { background: var(--fpl-green); color: #000; font-weight: 900; padding: 5px 12px; border-radius: 4px; font-family: monospace; }

        /* Sections */
        .summary-section, .watchlist-section, .history-section, .transfers-section { margin: 8px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; margin-bottom: 15px; }
        .section-title { padding: 12px; text-align: center; font-weight: 700; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; gap: 8px; }
        
        .filter-bar { background: var(--bg-color); padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; font-size: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .filter-bar select, .filter-bar input { padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); }

        .summary-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .summary-table th { background: var(--header-dark); color: white; padding: 10px; font-size: 0.7rem; }
        .summary-table td { border: 1px solid var(--border-color); padding: 10px; text-align: center; min-height: 120px; vertical-align: top; }
        .label-row { background: var(--bg-color); color: var(--text-muted); font-size: 0.65rem; font-weight: 700; padding: 5px !important; }

        /* Watchlist UI */
        .watchlist-controls { background: var(--bg-color); padding: 10px; display: flex; flex-direction: column; gap: 8px; font-size: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .search-container { position: relative; }
        .search-input { width: 100%; padding: 8px 30px 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); z-index: 100; max-height: 200px; overflow-y: auto; display: none; border-radius: 0 0 6px 6px; }
        .search-item { padding: 8px 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; }
        .watchlist-container { display: flex; flex-wrap: wrap; justify-content: center; padding: 10px; gap: 5px; min-height: 50px; }
        .empty-msg { font-size: 0.75rem; color: var(--text-muted); padding: 20px; text-align: center; width: 100%; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .data-table th { background: var(--header-dark); color: white; padding: 10px; text-align: left; }
        .data-table td { border-bottom: 1px solid var(--border-color); padding: 10px; }
        .count-in { color: var(--fpl-green); font-weight: 800; }
        .count-out { color: var(--fpl-pink); font-weight: 800; }

        /* Shirts */
        .shirt-card { display: inline-flex; flex-direction: column; align-items: center; margin: 5px; cursor: pointer; width: 70px; }
        .shirt-img { width: 45px; height: 50px; object-fit: contain; }
        .shirt-name { background: #000; color: #fff; font-size: 0.55rem; width: 100%; padding: 2px; border-radius: 2px; margin-top: 2px; text-transform: uppercase; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .shirt-percent { color: #fff; font-size: 0.6rem; font-weight: 900; width: 100%; padding: 2px; border-radius: 2px; margin-top: 2px; }

        /* Progress Bar in Modal */
        .progress-container { width: 100%; height: 10px; background: var(--bg-color); border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 15px; padding: 25px 20px 20px; position: relative; text-align: center; color: var(--text-main); }
        .close-modal { position: absolute; right: 15px; top: 10px; font-size: 1.5rem; cursor: pointer; }
        .fav-btn { position: absolute; left: 15px; top: 10px; font-size: 1.3rem; cursor: pointer; color: var(--text-muted); }
        .fav-btn.active { color: #fbbf24; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: var(--bg-color); padding: 10px; border-radius: 8px; font-size: 0.8rem; }
        .stat-val { display: block; font-weight: 800; color: var(--primary-blue); font-size: 1.1rem; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: var(--card-bg); border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(8, 1fr); z-index: 3000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); text-decoration: none; font-size: 0.55rem; font-weight: 700; gap: 4px; }
        .nav-item.active { color: var(--primary-blue); }
        .nav-item i { font-size: 1.2rem; }
    </style>
</head>
<body class="dark-mode">

    <header class="top-nav">
        <div class="nav-icon-btn"><i class="fa-solid fa-circle-user"></i></div>
        <div class="logo-container">Kopala<span>▲</span>FPL</div>
        <div class="nav-icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-sun" id="theme-icon"></i></div>
    </header>

    <main>
        <div class="timer-banner">
            <div style="font-size: 0.7rem; margin-bottom: 5px; opacity: 0.8;">NEXT PRICE CHANGE COUNTDOWN:</div>
            <span class="countdown-display" id="price-timer">00 hr 00 min 00 sec</span>
        </div>

        <div class="summary-section">
            <div class="section-title">Price Predictions</div>
            <div class="filter-bar">
                <select id="teamFilter" onchange="render()">
                    <option value="all">All Teams</option>
                </select>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="minOwnCheck" checked onchange="render()">
                    <span>Min Own: <input type="number" id="minOwnVal" value="1" style="width:30px" oninput="render()"> %</span>
                </div>
            </div>
            <table class="summary-table">
                <thead>
                    <tr><th style="border-right: 1px solid #444;">Predicted Rises</th><th>Predicted Falls</th></tr>
                </thead>
                <tbody id="summary-grid">
                    <tr><td colspan="2" class="label-row">Ready for Price Change</td></tr>
                    <tr><td id="r-reached"></td><td id="f-reached"></td></tr>
                    <tr><td colspan="2" class="label-row">Rising / Falling Fast</td></tr>
                    <tr><td id="r-projected"></td><td id="f-projected"></td></tr>
                    <tr><td colspan="2" class="label-row">Approaching Target</td></tr>
                    <tr><td id="r-close"></td><td id="f-close"></td></tr>
                </tbody>
            </table>
        </div>

        <div class="watchlist-section">
            <div class="section-title"><i class="fa-solid fa-star" style="color:#fbbf24"></i> My Watchlist</div>
            <div class="watchlist-controls">
                <div class="search-container">
                    <input type="text" id="playerSearch" class="search-input" placeholder="Search player to add..." oninput="handleSearch(this.value)">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="sortWatchlist" onchange="render()"> 
                    <span>Auto-sort by target proximity</span>
                </div>
            </div>
            <div id="watchlist-grid" class="watchlist-container">
                <div class="empty-msg">No players added to watchlist yet.</div>
            </div>
        </div>

        <div class="history-section">
            <div class="section-title"><i class="fa-solid fa-clock-rotate-left"></i> Recent Price Changes</div>
            <table class="data-table">
                <thead>
                    <tr><th>Player</th><th>Team</th><th>Change</th><th>Price</th></tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>

        <div class="transfers-section">
            <div class="section-title"><i class="fa-solid fa-right-left"></i> Popular Transfers</div>
            <table class="data-table">
                <thead>
                    <tr><th>Player</th><th>Net (Today)</th></tr>
                </thead>
                <tbody id="transfer-body"></tbody>
            </table>
        </div>
    </main>

    <div id="playerModal" class="modal">
        <div class="modal-content">
            <i id="modal-fav" class="fa-solid fa-star fav-btn" onclick="toggleWatchlist()"></i>
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <img id="modal-shirt" src="" style="width: 80px;">
            <h2 id="modal-name" style="margin: 10px 0 5px;">Player Name</h2>
            <div id="modal-pos" style="color: var(--text-muted); font-size: 0.9rem;">MID | Team</div>
            
            <div class="progress-container">
                <div id="modal-progress" class="progress-fill"></div>
            </div>
            <div id="modal-target-text" style="font-size: 0.8rem; font-weight: 800; margin-bottom: 10px;">0% to target</div>

            <div class="stat-grid">
                <div class="stat-box">Price <span class="stat-val" id="modal-price">£0.0</span></div>
                <div class="stat-box">Owned <span class="stat-val" id="modal-own">0%</span></div>
                <div class="stat-box">In <span class="stat-val" id="modal-in" style="color:var(--fpl-green)">0</span></div>
                <div class="stat-box">Out <span class="stat-val" id="modal-out" style="color:var(--fpl-pink)">0</span></div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="leagues.html" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item active"><i class="fa-solid fa-tags"></i><span>Prices</span></a>
        <a href="games.html" class="nav-item"><i class="fa-solid fa-futbol"></i><span>Games</span></a>
        <a href="members.html" class="nav-item"><i class="fa-solid fa-user-tie"></i><span>Members</span></a>
        <a href="https://wa.me/260964836842" class="nav-item"><i class="fa-brands fa-whatsapp"></i><span>Support</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-circle-info"></i><span>About</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-ellipsis-h"></i><span>More</span></a>
    </nav>

    <script>
        const PROXY = "/.netlify/functions/fpl-proxy?endpoint=bootstrap-static/";
        let playerData = [];
        let teamMap = {};
        let watchlist = JSON.parse(localStorage.getItem('fpl_watchlist')) || [];
        let currentModalPlayerId = null;

        function toggleTheme() { 
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        async function init() {
            try {
                const res = await fetch(PROXY);
                const data = await res.json();
                
                // Build team lookup and populate filter dropdown
                data.teams.forEach(t => { 
                    teamMap[t.id] = t.name;
                    const opt = document.createElement('option');
                    opt.value = t.id; opt.innerText = t.name;
                    document.getElementById('teamFilter').appendChild(opt);
                });

                // Real-world logic factors
                const wildcardFactor = 0.88; // Simulating 12% non-scoring transfers (WC/FH)
                
                playerData = data.elements.map(p => {
                    const price = p.now_cost / 10;
                    const own = parseFloat(p.selected_by_percent);
                    const netEvent = (p.transfers_in_event - p.transfers_out_event) * wildcardFactor;
                    
                    let target = 0;
                    if (netEvent > 0) {
                        const threshold = Math.max(4000, (own * 1200) + (price * 500));
                        target = (netEvent / threshold) * 100;
                    } else {
                        const threshold = Math.max(3000, (own * 1100));
                        target = (netEvent / threshold) * 100;
                    }

                    return {
                        id: p.id,
                        name: p.web_name,
                        price: price.toFixed(1),
                        target: parseFloat(target.toFixed(2)),
                        own: own,
                        pos: ["", "GKP", "DEF", "MID", "FWD"][p.element_type],
                        teamId: p.team,
                        teamCode: p.team_code,
                        in: p.transfers_in_event,
                        out: p.transfers_out_event,
                        costChange: p.cost_change_event / 10,
                        changed: p.cost_change_event !== 0
                    };
                });
                render();
            } catch (e) { console.error("Error fetching data:", e); }
        }

        function render() {
            const selectedTeam = document.getElementById('teamFilter').value;
            const minOwn = parseFloat(document.getElementById('minOwnVal').value) || 0;
            const filterOn = document.getElementById('minOwnCheck').checked;
            
            const teamFilter = (p) => selectedTeam === "all" || p.teamId == selectedTeam;
            const fallFilter = (p) => filterOn ? p.own >= minOwn : true;

            const active = playerData.filter(p => !p.changed && teamFilter(p));

            // Summary Sorting
            document.getElementById('r-reached').innerHTML = active.filter(p => p.target >= 100).sort((a,b)=>b.target-a.target).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('r-projected').innerHTML = active.filter(p => p.target >= 90 && p.target < 100).sort((a,b)=>b.target-a.target).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('r-close').innerHTML = active.filter(p => p.target >= 75 && p.target < 90).sort((a,b)=>b.target-a.target).slice(0,3).map(p => getShirt(p)).join('');
            
            document.getElementById('f-reached').innerHTML = active.filter(p => p.target <= -100 && fallFilter(p)).sort((a,b)=>a.target-b.target).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('f-projected').innerHTML = active.filter(p => p.target <= -90 && p.target > -100 && fallFilter(p)).sort((a,b)=>a.target-b.target).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('f-close').innerHTML = active.filter(p => p.target <= -75 && p.target > -90 && fallFilter(p)).sort((a,b)=>a.target-b.target).slice(0,3).map(p => getShirt(p)).join('');

            // History Table
            const history = playerData.filter(p => p.changed).sort((a,b) => Math.abs(b.costChange) - Math.abs(a.costChange));
            document.getElementById('history-body').innerHTML = history.length ? history.map(p => `
                <tr onclick="openModal(${p.id})">
                    <td>${p.name}</td><td>${teamMap[p.teamId]}</td>
                    <td class="${p.costChange > 0 ? 'count-in' : 'count-out'}">${p.costChange > 0 ? '+' : ''}${p.costChange.toFixed(1)}</td>
                    <td>£${p.price}</td>
                </tr>`).join('') : '<tr><td colspan="4" class="empty-msg">No changes in last update</td></tr>';

            // Transfers Table
            const filteredTransfers = playerData.filter(teamFilter);
            const topIn = [...filteredTransfers].sort((a,b) => b.in - a.in).slice(0, 5);
            const topOut = [...filteredTransfers].sort((a,b) => b.out - a.out).slice(0, 5);
            let tHtml = '<tr><td colspan="2" class="label-row">Most Bought Today</td></tr>';
            topIn.forEach(p => tHtml += `<tr onclick="openModal(${p.id})"><td>${p.name} (${p.pos})</td><td class="count-in">+${p.in.toLocaleString()}</td></tr>`);
            tHtml += '<tr><td colspan="2" class="label-row">Most Sold Today</td></tr>';
            topOut.forEach(p => tHtml += `<tr onclick="openModal(${p.id})"><td>${p.name} (${p.pos})</td><td class="count-out">-${p.out.toLocaleString()}</td></tr>`);
            document.getElementById('transfer-body').innerHTML = tHtml;

            // Watchlist
            let wp = playerData.filter(p => watchlist.includes(p.id));
            if (document.getElementById('sortWatchlist').checked) wp.sort((a,b) => Math.abs(b.target) - Math.abs(a.target));
            document.getElementById('watchlist-grid').innerHTML = wp.length ? wp.map(p => getShirt(p)).join('') : '<div class="empty-msg">No players on watchlist</div>';
        }

        function getShirt(p) {
            const color = p.target > 0 ? "#10b981" : "#e90052";
            return `
                <div class="shirt-card" onclick="openModal(${p.id})">
                    <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.teamCode}-66.webp" class="shirt-img">
                    <div class="shirt-name">${p.name}</div>
                    <div class="shirt-percent" style="background:${color}">${Math.abs(p.target).toFixed(1)}%</div>
                </div>`;
        }

        function handleSearch(val) {
            const resDiv = document.getElementById('searchResults');
            if (val.length < 2) { resDiv.style.display = 'none'; return; }
            const matches = playerData.filter(p => p.name.toLowerCase().includes(val.toLowerCase())).slice(0,5);
            resDiv.innerHTML = matches.map(p => `<div class="search-item" onclick="openModal(${p.id}); document.getElementById('playerSearch').value=''; resDiv.style.display='none';"><span>${p.name}</span><span style="color:var(--text-muted)">${p.pos}</span></div>`).join('');
            resDiv.style.display = 'block';
        }

        function openModal(id) {
            currentModalPlayerId = id;
            const p = playerData.find(x => x.id === id);
            document.getElementById('modal-shirt').src = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.teamCode}-66.webp`;
            document.getElementById('modal-name').innerText = p.name;
            document.getElementById('modal-pos').innerText = `${p.pos} | ${teamMap[p.teamId]}`;
            document.getElementById('modal-price').innerText = `£${p.price}`;
            document.getElementById('modal-own').innerText = `${p.own}%`;
            document.getElementById('modal-in').innerText = p.in.toLocaleString();
            document.getElementById('modal-out').innerText = p.out.toLocaleString();
            const fill = document.getElementById('modal-progress');
            fill.style.width = Math.min(100, Math.abs(p.target)) + '%';
            fill.style.background = p.target >= 0 ? 'var(--fpl-green)' : 'var(--fpl-pink)';
            document.getElementById('modal-target-text').innerText = `${Math.abs(p.target).toFixed(1)}% to ${p.target >= 0 ? 'RISE' : 'FALL'}`;
            document.getElementById('modal-fav').className = watchlist.includes(id) ? 'fa-solid fa-star fav-btn active' : 'fa-solid fa-star fav-btn';
            document.getElementById('playerModal').style.display = 'flex';
        }

        function toggleWatchlist() {
            const idx = watchlist.indexOf(currentModalPlayerId);
            if (idx > -1) watchlist.splice(idx, 1); else watchlist.push(currentModalPlayerId);
            localStorage.setItem('fpl_watchlist', JSON.stringify(watchlist));
            openModal(currentModalPlayerId); render();
        }

        function closeModal() { document.getElementById('playerModal').style.display = 'none'; }

        // Price Change Countdown
        setInterval(() => {
            const now = new Date(), target = new Date();
            target.setUTCHours(2, 30, 0, 0); // FPL Daily update time
            if (now > target) target.setDate(target.getDate() + 1);
            const d = target - now;
            const h = Math.floor(d/3600000).toString().padStart(2,'0');
            const m = Math.floor((d%3600000)/60000).toString().padStart(2,'0');
            const s = Math.floor((d%60000)/1000).toString().padStart(2,'0');
            document.getElementById('price-timer').innerText = `${h} hr ${m} min ${s} sec`;
        }, 1000);

        init();
    </script>
</body>
</html>
