<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prices - Kopala FPL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #2563eb;
            --fpl-green: #00ff85;
            --fpl-pink: #e90052;
            --border-color: #e2e8f0;
            --header-dark: #0f172a;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, system-ui, sans-serif;
            padding-top: 70px;
            padding-bottom: 90px;
            transition: background 0.3s ease;
        }

        /* Top Navigation */
        .top-nav {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: var(--card-bg); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 3000;
        }
        .logo-container { font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; }
        .logo-container span { color: var(--fpl-green); }
        .nav-icon-btn { font-size: 1.2rem; cursor: pointer; color: var(--text-main); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; }

        /* Timer Banner */
        .timer-banner { background: var(--header-dark); color: white; margin: 8px; padding: 15px; border-radius: 12px; text-align: center; }
        .countdown-display { background: var(--fpl-green); color: #000; font-weight: 900; padding: 5px 12px; border-radius: 4px; font-family: monospace; }

        /* Sections */
        .summary-section, .watchlist-section, .transfers-section { margin: 8px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; margin-bottom: 15px; }
        .section-title { padding: 12px; text-align: center; font-weight: 700; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; gap: 8px; }
        
        .summary-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .summary-table th { background: var(--header-dark); color: white; padding: 10px; font-size: 0.7rem; }
        .summary-table td { border: 1px solid var(--border-color); padding: 10px; text-align: center; min-height: 120px; vertical-align: top; }
        .label-row { background: var(--bg-color); color: var(--text-muted); font-size: 0.65rem; font-weight: 700; padding: 5px !important; }

        /* Watchlist UI */
        .watchlist-controls { background: var(--bg-color); padding: 10px; display: flex; flex-direction: column; gap: 8px; font-size: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .search-container { position: relative; }
        .search-input { width: 100%; padding: 8px 30px 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); z-index: 100; max-height: 200px; overflow-y: auto; display: none; border-radius: 0 0 6px 6px; }
        .search-item { padding: 8px 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; }
        .watchlist-container { display: flex; flex-wrap: wrap; justify-content: center; padding: 10px; gap: 5px; min-height: 50px; }
        .empty-msg { font-size: 0.75rem; color: var(--text-muted); padding: 20px; text-align: center; width: 100%; }

        /* Transfers Table */
        .transfer-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .transfer-table th { background: var(--header-dark); color: white; padding: 10px; text-align: left; }
        .transfer-table td { border-bottom: 1px solid var(--border-color); padding: 10px; }
        .transfer-name { font-weight: 700; }
        .count-in { color: var(--fpl-green); font-weight: 800; }
        .count-out { color: var(--fpl-pink); font-weight: 800; }

        /* Shirts */
        .shirt-card { display: inline-flex; flex-direction: column; align-items: center; margin: 5px; cursor: pointer; width: 70px; }
        .shirt-img { width: 45px; height: 50px; object-fit: contain; }
        .shirt-name { background: #000; color: #fff; font-size: 0.55rem; width: 100%; padding: 2px; border-radius: 2px; margin-top: 2px; text-transform: uppercase; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .shirt-percent { color: #fff; font-size: 0.6rem; font-weight: 900; width: 100%; padding: 2px; border-radius: 2px; margin-top: 2px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 15px; padding: 25px 20px 20px; position: relative; text-align: center; color: var(--text-main); }
        .close-modal { position: absolute; right: 15px; top: 10px; font-size: 1.5rem; cursor: pointer; }
        .fav-btn { position: absolute; left: 15px; top: 10px; font-size: 1.3rem; cursor: pointer; color: var(--text-muted); }
        .fav-btn.active { color: #fbbf24; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: var(--bg-color); padding: 10px; border-radius: 8px; font-size: 0.8rem; }
        .stat-val { display: block; font-weight: 800; color: var(--primary-blue); font-size: 1.1rem; }

        /* Bottom Nav (8 Items) */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: var(--card-bg); border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(8, 1fr); z-index: 3000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); text-decoration: none; font-size: 0.55rem; font-weight: 700; gap: 4px; }
        .nav-item.active { color: var(--primary-blue); }
        .nav-item i { font-size: 1.2rem; }
    </style>
</head>
<body class="dark-mode">

    <header class="top-nav">
        <div class="nav-icon-btn"><i class="fa-solid fa-circle-user"></i></div>
        <div class="logo-container">Kopala<span>▲</span>FPL</div>
        <div class="nav-icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-sun" id="theme-icon"></i></div>
    </header>

    <main>
        <div class="timer-banner">
            <div style="font-size: 0.7rem; margin-bottom: 5px; opacity: 0.8;">NEXT PRICE CHANGE COUNTDOWN:</div>
            <span class="countdown-display" id="price-timer">00 hr 00 min 00 sec</span>
        </div>

        <div class="summary-section">
            <div class="section-title">Summary of Predictions</div>
            <div style="text-align:center; padding: 8px; font-size: 0.7rem; background: var(--bg-color);">
                <input type="checkbox" id="minOwnCheck" checked> Only show fallers > <input type="number" id="minOwnVal" value="1" style="width:30px"> %
            </div>
            <table class="summary-table">
                <thead>
                    <tr><th style="border-right: 1px solid #444;">Predicted Rises</th><th>Predicted Falls</th></tr>
                </thead>
                <tbody id="summary-grid">
                    <tr><td colspan="2" class="label-row">Already reached target</td></tr>
                    <tr><td id="r-reached"></td><td id="f-reached"></td></tr>
                    <tr><td colspan="2" class="label-row">Projected to reach target</td></tr>
                    <tr><td id="r-projected"></td><td id="f-projected"></td></tr>
                    <tr><td colspan="2" class="label-row">Others who will be close</td></tr>
                    <tr><td id="r-close"></td><td id="f-close"></td></tr>
                </tbody>
            </table>
        </div>

        <div class="watchlist-section">
            <div class="section-title"><i class="fa-solid fa-star" style="color:#fbbf24"></i> My Watchlist</div>
            <div class="watchlist-controls">
                <div class="search-container">
                    <input type="text" id="playerSearch" class="search-input" placeholder="Search player to add..." oninput="handleSearch(this.value)">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="sortWatchlist" onchange="render()"> 
                    <span>Auto-sort by target proximity</span>
                </div>
            </div>
            <div id="watchlist-grid" class="watchlist-container">
                <div class="empty-msg">No players added to watchlist yet.</div>
            </div>
        </div>

        <div class="transfers-section">
            <div class="section-title"><i class="fa-solid fa-right-left"></i> Top Daily Transfers</div>
            <table class="transfer-table">
                <thead>
                    <tr><th>Player</th><th>Net (Today)</th></tr>
                </thead>
                <tbody id="transfer-body"></tbody>
            </table>
        </div>
    </main>

    <div id="playerModal" class="modal">
        <div class="modal-content">
            <i id="modal-fav" class="fa-solid fa-star fav-btn" onclick="toggleWatchlist()"></i>
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <img id="modal-shirt" src="" style="width: 80px;">
            <h2 id="modal-name" style="margin: 10px 0 5px;">Player Name</h2>
            <div id="modal-pos" style="color: var(--text-muted); font-size: 0.9rem;">MID | Team</div>
            <div class="stat-grid">
                <div class="stat-box">Price <span class="stat-val" id="modal-price">£0.0</span></div>
                <div class="stat-box">Target <span class="stat-val" id="modal-target">0%</span></div>
                <div class="stat-box">Ownership <span class="stat-val" id="modal-own">0%</span></div>
                <div class="stat-box">Net Transfers <span class="stat-val" id="modal-net">0</span></div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="leagues.html" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item active"><i class="fa-solid fa-tags"></i><span>Prices</span></a>
        <a href="games.html" class="nav-item"><i class="fa-solid fa-futbol"></i><span>Games</span></a>
        <a href="members.html" class="nav-item"><i class="fa-solid fa-user-tie"></i><span>Members</span></a>
        <a href="https://wa.me/260964836842" class="nav-item"><i class="fa-brands fa-whatsapp"></i><span>Support</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-circle-info"></i><span>About</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-ellipsis-h"></i><span>More</span></a>
    </nav>

    <script>
        const PROXY = "/.netlify/functions/fpl-proxy?endpoint=bootstrap-static/";
        let playerData = [];
        let watchlist = JSON.parse(localStorage.getItem('fpl_watchlist')) || [];
        let currentModalPlayerId = null;

        function toggleTheme() { 
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        async function init() {
            try {
                const res = await fetch(PROXY);
                const data = await res.json();
                const currentGW = data.events.find(e => e.is_current)?.id || 1;
                const decay = Math.max(0.6, 1 - (currentGW * 0.015));

                playerData = data.elements.map(p => {
                    const net = p.transfers_in_event - p.transfers_out_event;
                    const riseThresh = ((p.selected_by_percent * 1400) + 4500) * decay;
                    const fallThresh = (p.selected_by_percent * 0.18) * 10000 * decay;
                    const target = net > 0 ? (net / riseThresh) * 100 : (net / fallThresh) * 100;

                    return {
                        id: p.id,
                        name: p.web_name,
                        price: (p.now_cost / 10).toFixed(1),
                        target: parseFloat(target.toFixed(2)),
                        own: p.selected_by_percent,
                        pos: ["", "GKP", "DEF", "MID", "FWD"][p.element_type],
                        teamCode: p.team_code,
                        net: net,
                        changed: p.cost_change_event !== 0
                    };
                });
                render();
            } catch (e) { console.error(e); }
        }

        function handleSearch(val) {
            const resultsDiv = document.getElementById('searchResults');
            if (val.length < 2) { resultsDiv.style.display = 'none'; return; }
            const filtered = playerData.filter(p => p.name.toLowerCase().includes(val.toLowerCase())).slice(0, 5);
            if (filtered.length > 0) {
                resultsDiv.innerHTML = filtered.map(p => `
                    <div class="search-item" onclick="openModal(${p.id}); document.getElementById('searchResults').style.display='none';">
                        <span>${p.name}</span><span style="color:var(--text-muted)">${p.pos}</span>
                    </div>`).join('');
                resultsDiv.style.display = 'block';
            } else { resultsDiv.style.display = 'none'; }
        }

        function openModal(id) {
            currentModalPlayerId = id;
            const p = playerData.find(x => x.id === id);
            document.getElementById('modal-shirt').src = `https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.teamCode}-66.webp`;
            document.getElementById('modal-name').innerText = p.name;
            document.getElementById('modal-pos').innerText = `${p.pos} | £${p.price}`;
            document.getElementById('modal-price').innerText = `£${p.price}`;
            document.getElementById('modal-target').innerText = `${p.target}%`;
            document.getElementById('modal-own').innerText = `${p.own}%`;
            document.getElementById('modal-net').innerText = p.net.toLocaleString();
            document.getElementById('modal-fav').className = watchlist.includes(id) ? 'fa-solid fa-star fav-btn active' : 'fa-solid fa-star fav-btn';
            document.getElementById('playerModal').style.display = 'flex';
        }

        function toggleWatchlist() {
            const idx = watchlist.indexOf(currentModalPlayerId);
            if (idx > -1) watchlist.splice(idx, 1);
            else watchlist.push(currentModalPlayerId);
            localStorage.setItem('fpl_watchlist', JSON.stringify(watchlist));
            openModal(currentModalPlayerId);
            render();
        }

        function closeModal() { document.getElementById('playerModal').style.display = 'none'; }

        function getShirt(p) {
            const color = p.target > 0 ? "#10b981" : "#e90052";
            return `
                <div class="shirt-card" onclick="openModal(${p.id})">
                    <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_${p.teamCode}-66.webp" class="shirt-img">
                    <div class="shirt-name">${p.name}</div>
                    <div class="shirt-percent" style="background:${color}">${Math.abs(p.target).toFixed(1)}%</div>
                </div>`;
        }

        function render() {
            const active = playerData.filter(p => !p.changed);
            const minOwn = parseFloat(document.getElementById('minOwnVal').value) || 0;
            const filterOn = document.getElementById('minOwnCheck').checked;
            const fFilter = (p) => filterOn ? p.own >= minOwn : true;

            // Summary
            document.getElementById('r-reached').innerHTML = active.filter(p => p.target >= 105).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('r-projected').innerHTML = active.filter(p => p.target >= 100 && p.target < 105).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('r-close').innerHTML = active.filter(p => p.target >= 95 && p.target < 100).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('f-reached').innerHTML = active.filter(p => p.target <= -105 && fFilter(p)).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('f-projected').innerHTML = active.filter(p => p.target <= -100 && p.target > -105 && fFilter(p)).slice(0,3).map(p => getShirt(p)).join('');
            document.getElementById('f-close').innerHTML = active.filter(p => p.target <= -95 && p.target > -100 && fFilter(p)).slice(0,3).map(p => getShirt(p)).join('');

            // Watchlist
            const watchGrid = document.getElementById('watchlist-grid');
            let wp = playerData.filter(p => watchlist.includes(p.id));
            if (document.getElementById('sortWatchlist').checked) wp.sort((a,b) => Math.abs(b.target) - Math.abs(a.target));
            watchGrid.innerHTML = wp.length > 0 ? wp.map(p => getShirt(p)).join('') : '<div class="empty-msg">No players added to watchlist yet.</div>';

            // Top Transfers Table
            const topIn = [...playerData].sort((a,b) => b.net - a.net).slice(0, 5);
            const topOut = [...playerData].sort((a,b) => a.net - b.net).slice(0, 5);
            let tHtml = '<tr><td colspan="2" class="label-row">Most Purchased Today</td></tr>';
            topIn.forEach(p => tHtml += `<tr onclick="openModal(${p.id})"><td><span class="transfer-name">${p.name}</span> (${p.pos})</td><td class="count-in">+${p.net.toLocaleString()}</td></tr>`);
            tHtml += '<tr><td colspan="2" class="label-row">Most Sold Today</td></tr>';
            topOut.forEach(p => tHtml += `<tr onclick="openModal(${p.id})"><td><span class="transfer-name">${p.name}</span> (${p.pos})</td><td class="count-out">${p.net.toLocaleString()}</td></tr>`);
            document.getElementById('transfer-body').innerHTML = tHtml;
        }

        setInterval(() => {
            const now = new Date();
            let target = new Date();
            target.setUTCHours(2, 30, 0, 0);
            if (now > target) target.setDate(target.getDate() + 1);
            const diff = target - now;
            const h = Math.floor(diff/3600000).toString().padStart(2,'0');
            const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
            const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
            document.getElementById('price-timer').innerText = `${h} hr ${m} min ${s} sec`;
        }, 1000);

        init();
        document.getElementById('minOwnVal').oninput = render;
        document.getElementById('minOwnCheck').onchange = render;
    </script>
</body>
</html>
