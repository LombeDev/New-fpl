<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>View Current GW points</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5323/5323982.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* SPINNER STYLES */
        :root { --md-sys-color-primary: #006a60; }
        .spinner-container { display: flex; justify-content: center; align-items: center; padding: 60px 20px; width: 100%; }
        .md-spinner {
            width: 28px; height: 28px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top: 3px solid var(--md-sys-color-primary);
            border-radius: 50%;
            animation: md-spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        @keyframes md-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Container spacing */
        .page-content { padding-top: 10px; }

        /* Manager Name Section */
        #manager-header {
            padding: 0 16px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #disp-name {
            font-weight: 900;
            font-size: 1rem;
            color: var(--text-color, #1d1b20);
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--surface-variant, #f6f3f8);
            padding: 6px 12px;
            border-radius: 20px;
        }

        /* Stats Grid - Material You Style */
        .header-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 0 16px;
            margin-bottom: 20px;
        }

        .header-stats-grid > div {
            background: var(--card-bg, #ffffff);
            padding: 10px 8px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }

        .stat-label {
            font-size: 0.55rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.5;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 0.9rem;
            font-weight: 900;
            color: var(--accent-color, #38003c);
        }

        #disp-total {
            color: #00ff87;
            text-shadow: 0 0 10px rgba(0, 255, 135, 0.2);
        }

        .player-list-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px 1px;
            justify-items: center;
        }

        .compact-player-card {
            width: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .compact-player-card img {
            width: 22px; 
            margin-bottom: 1px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
            z-index: 2;
        }

        .card-name {
            font-size: 0.45rem;
            font-weight: 800;
            color: #2d3436;
            margin-bottom: 1px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .card-points {
            background: #ffffff;
            color: #000;
            font-size: 0.6rem;
            font-weight: 900;
            padding: 0px 4px;
            border-radius: 5px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            margin-bottom: 1px;
            min-width: 20px;
            text-align: center;
        }

        .card-ownership-bar {
            background: #00ff85; 
            color: #1a1a1a;
            font-size: 0.4rem;
            padding: 0px;
            border-radius: 2px;
            font-weight: 700;
            width: 95%;
            text-align: center;
        }

        .badge {
            position: absolute;
            top: 10px;
            right: 2px;
            width: 11px;
            height: 11px;
            background: #2d3436;
            color: white;
            border-radius: 50%;
            font-size: 0.35rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            border: 1px solid white;
            z-index: 3;
        }

        .star-icon {
            position: absolute;
            top: -2px;
            left: 2px;
            font-size: 0.5rem;
            color: #f1c40f;
            z-index: 3;
        }

        .is-bench { opacity: 0.5; }
    </style>
</head>
<body class="dark-mode">

    <div id="login-screen" style="display:none;">
        <div class="login-card">
            <h2>Enter your FPL ID</h2>
            <div class="input-container">
                <input type="text" id="team-id-input" class="fpl-input" placeholder="e.g. 1234567">
                <div id="error-message" class="error-msg"></div>
            </div>
            <button id="login-btn" class="continue-btn" onclick="handleLogin()">Continue</button>
        </div>
    </div>

    <div id="nav-placeholder"></div>
    
    <main class="page-content">
        <div id="deadline-container"></div>
        
        <div id="loading-state">
            <div class="spinner-container"><div class="md-spinner"></div></div>
        </div>

        <div id="main-data-content" style="display: none;">
            <div style="padding: 0 15px 15px; display:flex; justify-content:space-between; align-items:center;">
                <div class="header-content">
                    <span id="disp-name" style="font-weight:900; font-size: 1.1rem;">-</span>
                    <div id="disp-team" style="font-size: 0.8rem; opacity: 0.7;">-</div>
                </div>
            </div>
            
            <div class="header-stats-grid">
                <div class="stat-box"><div class="stat-label">GW Rank</div><div class="stat-value" id="disp-gw-rank">-</div></div>
                <div class="stat-box"><div class="stat-label">Overall Rank</div><div class="stat-value" id="disp-rank">0</div></div>
                <div class="stat-box"><div class="stat-label">Points</div><div class="stat-value" id="disp-total">0</div></div>
                <div class="stat-box"><div class="stat-label">Overall</div><div class="stat-value" id="disp-total-pts">0</div></div>
                <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="disp-gw-avg">0</div></div>
                <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="disp-gw-high">0</div></div>
            </div>

            <div class="player-grid-container">
                <div id="squad-info-container"></div>
                <div id="player-list-grid" class="player-list-grid"></div>
                <div id="transfers-container" class="transfers-grid"></div>
            </div>
        </div>
    </main>

    <script>
    const state = {
        fplId: localStorage.getItem('kopala_id'),
        playerMap: {},
        teamMap: {},
        currentGW: 1,
        gwAverage: 0,
        gwHigh: 0
    };

    const PROXY = "/.netlify/functions/fpl-proxy?endpoint=";

    async function initData() {
        try {
            const res = await fetch(`${PROXY}bootstrap-static/`);
            const data = await res.json();
            data.teams.forEach(t => state.teamMap[t.id] = { code: t.code });
            data.elements.forEach(p => {
                state.playerMap[p.id] = { 
                    name: p.web_name, 
                    team_code: state.teamMap[p.team].code, 
                    pos: p.element_type,
                    ownership: p.selected_by_percent
                };
            });
            const currentEvent = data.events.find(e => e.is_current) || data.events[0];
            state.currentGW = currentEvent.id;
            state.gwAverage = currentEvent.average_entry_score;
            state.gwHigh = currentEvent.highest_score;
        } catch (e) { console.error("Init failed", e); }
    }

    async function fetchAndRender() {
        try {
            const [entryRes, picksRes, liveRes, transRes] = await Promise.all([
                fetch(`${PROXY}entry/${state.fplId}/`),
                fetch(`${PROXY}entry/${state.fplId}/event/${state.currentGW}/picks/`),
                fetch(`${PROXY}event/${state.currentGW}/live/`),
                fetch(`${PROXY}entry/${state.fplId}/transfers/`)
            ]);
            
            const entry = await entryRes.json();
            const picks = await picksRes.json();
            const live = await liveRes.json();
            const allTransfers = await transRes.json();

            // Update UI with data
            document.getElementById('disp-name').textContent = `${entry.player_first_name} ${entry.player_last_name}`;
            document.getElementById('disp-team').textContent = entry.name;

            const teamValue = (entry.last_deadline_value / 10).toFixed(1);
            const transferCost = picks.entry_history.event_transfers_cost;
            const ptsMap = {};
            live.elements.forEach(el => ptsMap[el.id] = el.stats.total_points);
            
            // Render Stats
            document.getElementById('disp-gw-rank').textContent = (picks.entry_history.rank || 0).toLocaleString();
            document.getElementById('disp-gw-high').textContent = state.gwHigh || 0;
            document.getElementById('disp-rank').textContent = entry.summary_overall_rank.toLocaleString();
            document.getElementById('disp-total-pts').textContent = entry.summary_overall_points.toLocaleString();
            document.getElementById('disp-gw-avg').textContent = state.gwAverage || 0;
            document.getElementById('disp-total').textContent = (picks.entry_history.points - transferCost);

            renderPlayerGrid(picks.picks, ptsMap);

            // Hide spinner and show content
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('main-data-content').style.display = 'block';

        } catch (e) { console.error("Fetch failed", e); }
    }

    function renderPlayerGrid(picks, ptsMap) {
        const grid = document.getElementById('player-list-grid');
        if (!grid) return;
        grid.innerHTML = ''; 
        picks.forEach((p, index) => {
            const meta = state.playerMap[p.element];
            if (!meta) return;
            const totalPts = (ptsMap[p.element] || 0) * (p.multiplier || 1);
            const isBench = index >= 11;
            grid.innerHTML += `
                <div class="compact-player-card ${isBench ? 'is-bench' : ''}">
                    <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${meta.team_code}${meta.pos === 1 ? '_1' : ''}-66.png">
                    ${p.is_captain ? `<div class="badge">C</div>` : ''}
                    <div class="card-data-box">
                        <div class="card-name">${meta.name}</div>
                        <div class="card-points">${totalPts}</div>
                    </div>
                </div>`;
        });
    }

    // Start App
    if (state.fplId) {
        initData().then(fetchAndRender);
    } else {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
    }
    </script>
    <script src="nav.js"></script>
    <div id="footer-placeholder"></div>
    <script src="footer.js"></script>
</body>
</html>
