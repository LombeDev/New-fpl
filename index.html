<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kopala FPL — Live Rank</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d0d0d">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kopala FPL">
  <link rel="apple-touch-icon" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- App Styles -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="nav.css">
  <link rel="stylesheet" href="footer.css">
</head>
<body>

<!-- ============================================
     LOGIN SCREEN
     ============================================ -->
<div id="login-screen">
  <div class="login-hero">
    <div class="login-hero__wordmark">KOPALA <span>FPL</span></div>
    <p class="login-hero__sub">Zambia's sharpest FPL companion</p>
  </div>

  <div class="login-card">
    <h2>Enter your FPL ID</h2>
    <p>Paste your team ID or your full FPL team URL — we'll figure it out.</p>

    <div>
      <input
        type="text"
        id="team-id-input"
        class="fpl-input"
        placeholder="e.g. 1234567 or paste link"
        autocomplete="off"
        inputmode="numeric"
      >
      <div id="error-message" class="error-msg"></div>
    </div>

    <button id="login-btn" class="continue-btn" onclick="handleLogin()">
      Continue
    </button>

    <div class="find-id-link" onclick="window.open('https://youtu.be/gZqblBRbAjw?si=IQ-hmIEES27jDaTn','_blank')">
      <i class="fa-solid fa-circle-question"></i>
      How to find my Team ID?
    </div>
  </div>
</div>

<!-- ============================================
     NAV INJECTION POINT
     ============================================ -->
<div id="nav-placeholder"></div>

<!-- ============================================
     MAIN PAGE CONTENT
     ============================================ -->
<main class="page-content" id="main-content">

  <!-- Deadline banner (injected by deadline.js) -->
  <div id="deadline-container"></div>

  <!-- Manager header -->
  <div class="manager-header">
    <div id="disp-name" class="manager-header__name">Manager Name</div>
    <div id="disp-team" class="manager-header__team">Team Name</div>
  </div>

  <!-- Scrollable stat chips -->
  <div class="stat-chips-row" id="stat-chips-row">
    <div class="stat-chip stat-chip--highlight">
      <div class="stat-chip__label">GW Points</div>
      <div class="stat-chip__value t-number" id="disp-total">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">GW Rank</div>
      <div class="stat-chip__value t-number" id="disp-gw-rank">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Overall</div>
      <div class="stat-chip__value t-number" id="disp-rank">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Total Pts</div>
      <div class="stat-chip__value t-number" id="disp-total-pts">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">GW Avg</div>
      <div class="stat-chip__value t-number" id="disp-gw-avg">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Highest</div>
      <div class="stat-chip__value t-number" id="disp-gw-high">—</div>
    </div>
  </div>

  <!-- Squad info bar (FT / TV / Played) -->
  <div id="squad-bar-container" class="squad-bar"></div>

  <!-- GW Transfers (rendered inline below squad bar) -->
  <div id="transfers-container"></div>

  <!-- Starting XI -->
  <div class="section">
    <div class="section-header">
      <span class="section-title">Starting XI</span>
      <span id="gw-label" class="t-label" style="color:var(--text-3)">GW —</span>
    </div>
    <div id="starting-grid" class="player-grid"></div>
  </div>

  <!-- Bench -->
  <div class="bench-divider">
    <div class="bench-divider__line"></div>
    <div class="bench-divider__label">Bench</div>
    <div class="bench-divider__line"></div>
  </div>

  <div class="section" style="padding-top:0;">
    <div id="bench-grid" class="player-grid"></div>
  </div>

  
  <div id="transfers-container"></div>

  <div id="footer-placeholder"></div>

</main>

<!-- ============================================
     SCRIPTS
     ============================================ -->
<script>
/* ============================================
   APP STATE
   ============================================ */
const state = {
  fplId:     localStorage.getItem('kopala_id'),
  playerMap: {},
  teamMap:   {},
  currentGW: 1,
  gwAverage: 0,
  gwHigh:    0,
};

const PROXY = '/.netlify/functions/fpl-proxy?endpoint=';

/* ============================================
   LOGIN HANDLER
   ============================================ */
async function handleLogin() {
  const input   = document.getElementById('team-id-input');
  const errorEl = document.getElementById('error-message');
  const btn     = document.getElementById('login-btn');

  // Clear previous error
  input.classList.remove('error');
  errorEl.style.display = 'none';

  let raw = input.value.trim();

  // Accept full FPL URLs
  const match = raw.match(/entry\/(\d+)/);
  if (match) raw = match[1];

  const id = parseInt(raw, 10);
  if (!id || isNaN(id)) return showErr('Please enter a valid numeric ID');

  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking…';

    const res = await fetch(`${PROXY}entry/${id}/`);
    if (!res.ok) throw new Error('Not found');

    localStorage.setItem('kopala_id', id);
    location.reload();
  } catch {
    showErr('Team ID not found. Please try again.');
    btn.disabled = false;
    btn.textContent = 'Continue';
  }

  function showErr(msg) {
    input.classList.add('error');
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
  }
}

// Allow Enter key on input
document.getElementById('team-id-input')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') handleLogin();
});

/* ============================================
   SKELETON LOADING
   ============================================ */
function showSkeletons() {
  // Text elements
  ['disp-name', 'disp-team'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('skeleton');
  });

  // Stat chips
  ['disp-total','disp-gw-rank','disp-rank','disp-total-pts','disp-gw-avg','disp-gw-high'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = '—';
      el.closest('.stat-chip')?.classList.add('skeleton');
    }
  });

  // Player grids — 11 + 4 ghost cards
  renderGhostCards('starting-grid', 11);
  renderGhostCards('bench-grid', 4);

  // Squad bar ghost pills
  const bar = document.getElementById('squad-bar-container');
  if (bar) {
    bar.innerHTML = [80, 70, 90].map(w =>
      `<div class="squad-pill skeleton" style="width:${w}px; height:32px;"></div>`
    ).join('');
  }
}

function renderGhostCards(gridId, count) {
  const grid = document.getElementById(gridId);
  if (!grid) return;
  grid.innerHTML = Array.from({ length: count }, () =>
    `<div class="player-card skeleton" style="height:120px;"></div>`
  ).join('');
}

function removeSkeletons() {
  document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));
}

/* ============================================
   BOOTSTRAP — GLOBAL DATA
   ============================================ */
async function initBootstrap() {
  const res  = await fetch(`${PROXY}bootstrap-static/`);
  const data = await res.json();

  data.teams.forEach(t => {
    state.teamMap[t.id] = { code: t.code };
  });

  data.elements.forEach(p => {
    state.playerMap[p.id] = {
      name:      p.web_name,
      teamCode:  state.teamMap[p.team].code,
      pos:       p.element_type,   // 1=GK 2=DEF 3=MID 4=FWD
      ownership: p.selected_by_percent,
    };
  });

  const live = data.events.find(e => e.is_current) || data.events.find(e => e.is_next) || data.events[0];
  state.currentGW  = live.id;
  state.gwAverage  = live.average_entry_score || 0;
  state.gwHigh     = live.highest_score || 0;
}

/* ============================================
   MAIN DATA FETCH & RENDER
   ============================================ */
async function fetchAndRender() {
  const [entryRes, picksRes, liveRes, transRes] = await Promise.all([
    fetch(`${PROXY}entry/${state.fplId}/`),
    fetch(`${PROXY}entry/${state.fplId}/event/${state.currentGW}/picks/`),
    fetch(`${PROXY}event/${state.currentGW}/live/`),
    fetch(`${PROXY}entry/${state.fplId}/transfers/`),
  ]);

  const [entry, picks, live, allTransfers] = await Promise.all([
    entryRes.json(), picksRes.json(), liveRes.json(), transRes.json(),
  ]);

  removeSkeletons();

  // ---- Manager header ----
  document.getElementById('disp-name').textContent =
    `${entry.player_first_name} ${entry.player_last_name}`;
  document.getElementById('disp-team').textContent = entry.name;

  // ---- GW label ----
  const gwLabel = document.getElementById('gw-label');
  if (gwLabel) gwLabel.textContent = `GW ${state.currentGW}`;

  // ---- Points map ----
  const ptsMap = {};
  live.elements.forEach(el => { ptsMap[el.id] = el.stats.total_points; });

  // ---- Transfer cost ----
  const transferCost = picks.entry_history.event_transfers_cost || 0;
  const netPoints    = picks.entry_history.points - transferCost;

  // ---- Stat chips ----
  setText('disp-total',     netPoints.toLocaleString());
  setText('disp-gw-rank',   (picks.entry_history.rank || 0).toLocaleString());
  setText('disp-rank',      entry.summary_overall_rank.toLocaleString());
  setText('disp-total-pts', entry.summary_overall_points.toLocaleString());
  setText('disp-gw-avg',    state.gwAverage);
  setText('disp-gw-high',   state.gwHigh);

  // ---- Squad bar ----
  const teamValue  = (entry.last_deadline_value / 10).toFixed(1);
  const freeTrans  = entry.extra_free_transfers ?? 1;
  let playedCount  = 0;
  picks.picks.forEach(p => {
    const el = live.elements.find(e => e.id === p.element);
    if (el && el.stats.minutes > 0) playedCount++;
  });

  const bar = document.getElementById('squad-bar-container');
  if (bar) {
    let pills = `
      <div class="squad-pill"><span class="squad-pill__value">${freeTrans}</span> Free transfer${freeTrans !== 1 ? 's' : ''}</div>
      <div class="squad-pill">£<span class="squad-pill__value">${teamValue}m</span> Team value</div>
      <div class="squad-pill"><span class="squad-pill__value">${playedCount}/15</span> Played</div>
    `;
    if (transferCost > 0) {
      pills += `<div class="squad-pill squad-pill--cost"><i class="fa-solid fa-arrow-down" style="font-size:0.7rem;"></i><span class="squad-pill__value">-${transferCost}pts</span> Hit</div>`;
    }
    bar.innerHTML = pills;
  }

  // ---- GW Transfers ----
  renderTransfers(allTransfers, transferCost);

  // ---- Player grids ----
  const starting = picks.picks.slice(0, 11);
  const bench    = picks.picks.slice(11);
  renderPlayerGrid('starting-grid', starting, ptsMap, false);
  renderPlayerGrid('bench-grid',    bench,    ptsMap, true);
}

/* ============================================
   TRANSFER DISPLAY
   ============================================ */
function renderTransfers(allTransfers, cost) {
  const container = document.getElementById('transfers-container');
  if (!container) return;

  const gwTransfers = allTransfers.filter(t => t.event === state.currentGW);
  if (gwTransfers.length === 0) {
    container.innerHTML = '';
    return;
  }

  const costBadge = cost > 0
    ? `<span class="transfer-card__cost">-${cost}pts</span>`
    : '<span style="font-size:0.7rem;color:var(--text-3)">Free</span>';

  const cards = gwTransfers.map((t, i) => {
    const pIn  = state.playerMap[t.element_in]?.name  || '?';
    const pOut = state.playerMap[t.element_out]?.name || '?';
    // Only show cost badge on first card to avoid repeating
    const badge = i === 0 ? costBadge : '';
    return `
      <div class="transfer-card">
        <div class="transfer-card__player-out">
          <i class="fa-solid fa-arrow-down" style="font-size:0.65rem;margin-right:4px;"></i>${pOut}
        </div>
        <i class="fa-solid fa-arrow-right transfer-card__arrow"></i>
        <div class="transfer-card__player-in">
          <i class="fa-solid fa-arrow-up" style="font-size:0.65rem;margin-right:4px;"></i>${pIn}
        </div>
        ${badge}
      </div>
    `;
  }).join('');

  container.innerHTML = `
    <div class="section" style="padding-top:12px;padding-bottom:0;">
      <div class="section-header">
        <span class="section-title">GW Transfers</span>
      </div>
      <div class="transfers-section" style="padding:0;">${cards}</div>
    </div>
  `;
}

/* ============================================
   PLAYER GRID RENDER
   ============================================ */
function renderPlayerGrid(gridId, picks, ptsMap, isBench) {
  const grid = document.getElementById(gridId);
  if (!grid) return;

  // Build all HTML in one string — single DOM write
  const html = picks.map(p => {
    const meta   = state.playerMap[p.element];
    if (!meta) return '';

    const rawPts  = ptsMap[p.element] || 0;
    const totalPts = rawPts * (p.multiplier || 1);
    const ptsClass = totalPts === 0 ? 'player-card__pts--zero' : '';

    const shirtSrc = `https://draft.premierleague.com/img/shirts/standard/shirt_${meta.teamCode}${meta.pos === 1 ? '_1' : ''}-66.png`;

    const badge = p.is_captain
      ? '<div class="player-badge player-badge--captain">C</div>'
      : p.is_vice_captain
        ? '<div class="player-badge player-badge--vice">V</div>'
        : '';

    const ownershipW = Math.min(parseFloat(meta.ownership) || 0, 100);

    return `
      <div class="player-card ${isBench ? 'is-bench' : ''}" data-pos="${meta.pos}" data-id="${p.element}">
        ${badge}
        <img
          class="player-card__shirt"
          src="${shirtSrc}"
          alt="${meta.name} shirt"
          loading="lazy"
          onerror="this.src='https://draft.premierleague.com/img/shirts/standard/shirt_1-66.png'"
        >
        <div class="player-card__name">${meta.name}</div>
        <div class="player-card__pts ${ptsClass}">${totalPts}</div>
        <div class="player-card__ownership">
          <div class="player-card__ownership-fill" style="width:${ownershipW}%"></div>
        </div>
      </div>
    `;
  }).join('');

  grid.innerHTML = html;
}

/* ============================================
   UTILITY
   ============================================ */
function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

/* ============================================
   APP ENTRY
   ============================================ */
async function startApp() {
  if (!state.fplId) {
    // Show login
    const ls = document.getElementById('login-screen');
    if (ls) ls.style.display = 'flex';
    return;
  }

  try {
    showSkeletons();
    await initBootstrap();
    await fetchAndRender();
  } catch (err) {
    console.error('App error:', err);
    // Show a friendly error in the manager header
    const nameEl = document.getElementById('disp-name');
    if (nameEl) {
      nameEl.textContent = 'Failed to load';
      nameEl.style.color = 'var(--red)';
    }
    const teamEl = document.getElementById('disp-team');
    if (teamEl) teamEl.textContent = 'Check your connection and refresh';
    removeSkeletons();
  }
}

document.addEventListener('DOMContentLoaded', startApp);
</script>

<script src="nav.js"></script>
<script src="deadline.js"></script>
<script src="footer.js"></script>
<script src="transfers.js"></script>

</body>
</html>
