<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kopala FPL — Live Rank</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d0d0d">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kopala FPL">
  <link rel="apple-touch-icon" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="nav.css">
  <link rel="stylesheet" href="footer.css">

  <style>
    /* ===== ROOT VARIABLES ===== */
    :root {
      --safe-top: max(16px, env(safe-area-inset-top));
      --safe-bottom: max(16px, env(safe-area-inset-bottom));
      --safe-left: max(16px, env(safe-area-inset-left));
      --safe-right: max(16px, env(safe-area-inset-right));
      --transition-fast: 0.15s ease-out;
      --transition-normal: 0.3s ease-out;
    }

    /* ===== BODY & SCROLL PERFORMANCE ===== */
    html {
      scroll-behavior: smooth;
    }

    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
      overscroll-behavior-y: contain;
    }

    /* ===== PAGE CONTENT PERFORMANCE ===== */
    .page-content {
      -webkit-overflow-scrolling: touch;
      contain: layout style paint;
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
      padding-bottom: var(--safe-bottom);
    }

    #nav-placeholder {
      padding-top: var(--safe-top);
    }

    /* ===== IMAGE OPTIMIZATION ===== */
    img {
      content-visibility: auto;
      will-change: contents;
      background: var(--bg-2);
      border-radius: 8px;
    }

    img[loading="lazy"] {
      aspect-ratio: 1;
    }

    /* ===== PLAYER GRID ENHANCEMENTS ===== */
    #starting-grid,
    #bench-grid {
      grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
      gap: 8px;
      padding: 12px;
      animation: fadeInUp 0.4s ease-out 0.2s both;
      contain: content;
      min-height: 120px;
    }

    #starting-grid .player-card,
    #bench-grid .player-card {
      padding: 8px 4px 6px;
      border-radius: 12px;
      gap: 5px;
      transition: transform var(--transition-fast), box-shadow var(--transition-normal);
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
      contain: layout style paint;
    }

    #starting-grid .player-card:active,
    #bench-grid .player-card:active {
      transform: scale(0.95) translateZ(0);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    #starting-grid .player-card__shirt,
    #bench-grid .player-card__shirt {
      width: 30px;
      height: auto;
      aspect-ratio: 1;
      display: block;
      object-fit: contain;
      backface-visibility: hidden;
    }

    #starting-grid .player-card__name,
    #bench-grid .player-card__name {
      font-size: 0.55rem;
      padding: 0 2px;
      line-height: 1.2;
      letter-spacing: -0.3px;
    }

    #starting-grid .player-card__pts,
    #bench-grid .player-card__pts {
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    #starting-grid .player-badge,
    #bench-grid .player-badge {
      width: 16px;
      height: 16px;
      font-size: 0.6rem;
      top: 3px;
      right: 3px;
      font-weight: 800;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
    }

    /* ===== ANIMATIONS ===== */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes shimmer {
      0%, 100% { opacity: 0.6; background: var(--bg-2); }
      50% { opacity: 1; background: var(--bg-3); }
    }

    /* ===== STAT CHIPS ===== */
    .stat-chip, .squad-pill {
      min-height: 56px;
      transition: background-color var(--transition-normal), color var(--transition-normal);
      will-change: background-color;
      contain: layout style;
    }

    .stat-chips-row {
      min-height: 70px;
      contain: layout;
    }

    .squad-bar {
      min-height: 50px;
    }

    .section {
      padding: 16px;
      contain: layout;
    }

    .section-header {
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    /* ===== SKELETON LOADING ===== */
    .skeleton {
      animation: shimmer 1.5s infinite;
    }

    /* ===== TOUCH OPTIMIZATION ===== */
    .player-card,
    .stat-chip,
    .squad-pill,
    .transfer-card,
    .continue-btn {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    button {
      transition: all var(--transition-fast);
      position: relative;
    }

    button:active {
      transform: scale(0.98);
    }

    /* ===== FOCUS STATES ===== */
    button:focus-visible,
    input:focus-visible,
    a:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* ===== ACCESSIBILITY ===== */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* ===== SHADOWS ===== */
    .player-card {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .player-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .stat-chip {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen" style="display:none;">
  <div class="login-hero">
    <div class="login-hero__wordmark">KOPALA <span>FPL</span></div>
    <p class="login-hero__sub">Zambia's sharpest FPL companion</p>
  </div>
  <div class="login-card">
    <h2>Enter your FPL ID</h2>
    <p>Paste your team ID or your full FPL team URL — we'll figure it out.</p>
    <div>
      <input type="text" id="team-id-input" class="fpl-input"
        placeholder="e.g. 1234567 or paste link"
        autocomplete="off" inputmode="numeric" spellcheck="false">
      <div id="error-message" class="error-msg"></div>
    </div>
    <button id="login-btn" class="continue-btn" onclick="handleLogin()">Continue</button>
    <div class="find-id-link" onclick="window.open('https://youtu.be/gZqblBRbAjw?si=IQ-hmIEES27jDaTn','_blank')">
      <i class="fa-solid fa-circle-question"></i> How to find my Team ID?
    </div>
  </div>
</div>

<!-- NAV -->
<div id="nav-placeholder"></div>

<!-- MAIN -->
<main class="page-content" id="main-content">

  <div id="deadline-container"></div>

  <div class="manager-header">
    <div id="disp-name" class="manager-header__name">Manager Name</div>
    <div id="disp-team" class="manager-header__team">Team Name</div>
  </div>

  <div class="stat-chips-row" id="stat-chips-row">
    <div class="stat-chip stat-chip--highlight">
      <div class="stat-chip__label">GW Points</div>
      <div class="stat-chip__value t-number" id="disp-total">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">GW Rank</div>
      <div class="stat-chip__value t-number" id="disp-gw-rank">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Overall</div>
      <div class="stat-chip__value t-number" id="disp-rank">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Total Pts</div>
      <div class="stat-chip__value t-number" id="disp-total-pts">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">GW Avg</div>
      <div class="stat-chip__value t-number" id="disp-gw-avg">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Highest</div>
      <div class="stat-chip__value t-number" id="disp-gw-high">—</div>
    </div>
  </div>

  <div id="squad-bar-container" class="squad-bar"></div>

  <div id="my-transfers-container"></div>

  <div class="section">
    <div class="section-header">
      <span class="section-title">Starting XI</span>
      <span id="gw-label" class="t-label" style="color:var(--text-3)">GW —</span>
    </div>
    <div id="starting-grid" class="player-grid"></div>
  </div>

  <div class="bench-divider">
    <div class="bench-divider__line"></div>
    <div class="bench-divider__label">Bench</div>
    <div class="bench-divider__line"></div>
  </div>

  <div class="section" style="padding-top:0;">
    <div id="bench-grid" class="player-grid"></div>
  </div>

  <div id="transfers-container"></div>
  <div id="footer-placeholder"></div>

</main>

<script>
// ===== STATE & CONFIG =====
const state = {
  fplId:     localStorage.getItem('kopala_id'),
  playerMap: {},
  teamMap:   {},
  currentGW: 1,
  gwAverage: 0,
  gwHigh:    0,
  cache:     {},
  cacheTime: {},
};

const PROXY = '/.netlify/functions/fpl-proxy?endpoint=';
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

// ===== PERFORMANCE: REQUEST DEDUPLICATION & CACHING =====
async function cachedFetch(url) {
  const now = Date.now();
  if (state.cache[url] && (now - state.cacheTime[url]) < CACHE_TTL) {
    return state.cache[url];
  }
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Failed to fetch ${url}`);
  const data = await res.json();
  state.cache[url] = data;
  state.cacheTime[url] = now;
  return data;
}

// ===== LOGIN =====
async function handleLogin() {
  const input   = document.getElementById('team-id-input');
  const errorEl = document.getElementById('error-message');
  const btn     = document.getElementById('login-btn');

  input.classList.remove('error');
  errorEl.style.display = 'none';

  let raw = input.value.trim();
  const match = raw.match(/entry\/(\d+)/);
  if (match) raw = match[1];

  const id = parseInt(raw, 10);
  if (!id || isNaN(id)) return showErr('Please enter a valid numeric ID');

  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking…';
    const res = await fetch(`${PROXY}entry/${id}/`);
    if (!res.ok) throw new Error('Not found');
    localStorage.setItem('kopala_id', id);
    location.reload();
  } catch {
    showErr('Team ID not found. Please try again.');
    btn.disabled = false;
    btn.textContent = 'Continue';
  }

  function showErr(msg) {
    input.classList.add('error');
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
  }
}

document.getElementById('team-id-input')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') handleLogin();
});

// ===== SKELETONS WITH CONTENT-VISIBILITY =====
function showSkeletons() {
  ['disp-name', 'disp-team'].forEach(id => {
    document.getElementById(id)?.classList.add('skeleton');
  });
  ['disp-total','disp-gw-rank','disp-rank','disp-total-pts','disp-gw-avg','disp-gw-high'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { 
      el.textContent = '—'; 
      el.closest('.stat-chip')?.classList.add('skeleton'); 
    }
  });
  renderGhostCards('starting-grid', 11);
  renderGhostCards('bench-grid', 4);
  const bar = document.getElementById('squad-bar-container');
  if (bar) bar.innerHTML = [80,70,90].map((w, i) =>
    `<div class="squad-pill skeleton" style="width:${w}px;height:32px;animation-delay:${i * 0.1}s;"></div>`
  ).join('');
}

function renderGhostCards(gridId, count) {
  const grid = document.getElementById(gridId);
  if (!grid) return;
  grid.innerHTML = Array.from({ length: count }, (_, i) =>
    `<div class="player-card skeleton" style="height:100px;animation-delay:${Math.min(i * 0.05, 0.3)}s;"></div>`
  ).join('');
}

function removeSkeletons() {
  document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));
}

// ===== BOOTSTRAP: PRELOAD CRITICAL DATA =====
async function initBootstrap() {
  const data = await cachedFetch(`${PROXY}bootstrap-static/`);

  // Map data in single pass
  const teamMap = {};
  const playerMap = {};
  
  data.teams.forEach(t => { 
    teamMap[t.id] = { code: t.code }; 
  });
  
  data.elements.forEach(p => {
    playerMap[p.id] = {
      name:      p.web_name,
      teamCode:  teamMap[p.team]?.code || '1',
      pos:       p.element_type,
      ownership: p.selected_by_percent || 0,
    };
  });

  Object.assign(state, { teamMap, playerMap });

  const live = data.events.find(e => e.is_current) || 
               data.events.find(e => e.is_next) || 
               data.events[data.events.length - 1];
  
  state.currentGW = live.id;
  state.gwAverage = live.average_entry_score || 0;
  state.gwHigh = live.highest_score || 0;
}

// ===== MAIN RENDER FUNCTION =====
async function fetchAndRender() {
  try {
    const urls = [
      `${PROXY}entry/${state.fplId}/`,
      `${PROXY}entry/${state.fplId}/event/${state.currentGW}/picks/`,
      `${PROXY}event/${state.currentGW}/live/`,
      `${PROXY}entry/${state.fplId}/transfers/`,
    ];

    const [entry, picks, live, allTransfers] = await Promise.all(
      urls.map(url => cachedFetch(url))
    );

    removeSkeletons();

    // Update header
    document.getElementById('disp-name').textContent = 
      `${entry.player_first_name} ${entry.player_last_name}`;
    document.getElementById('disp-team').textContent = entry.name;
    
    const gwLabel = document.getElementById('gw-label');
    if (gwLabel) gwLabel.textContent = `GW ${state.currentGW}`;

    // Build points map
    const ptsMap = {};
    live.elements.forEach(el => { 
      ptsMap[el.id] = el.stats.total_points; 
    });

    // Calculate metrics
    const transferCost = picks.entry_history.event_transfers_cost || 0;
    const netPoints = picks.entry_history.points - transferCost;
    const teamValue = (entry.last_deadline_value / 10).toFixed(1);
    const freeTrans = entry.extra_free_transfers ?? 1;
    
    let playedCount = 0;
    picks.picks.forEach(p => {
      const el = live.elements.find(e => e.id === p.element);
      if (el && el.stats.minutes > 0) playedCount++;
    });

    // Update stat chips
    setText('disp-total', netPoints.toLocaleString());
    setText('disp-gw-rank', (picks.entry_history.rank || 0).toLocaleString());
    setText('disp-rank', entry.summary_overall_rank.toLocaleString());
    setText('disp-total-pts', entry.summary_overall_points.toLocaleString());
    setText('disp-gw-avg', state.gwAverage);
    setText('disp-gw-high', state.gwHigh);

    // Update squad bar
    const bar = document.getElementById('squad-bar-container');
    if (bar) {
      let pills = `
        <div class="squad-pill"><span class="squad-pill__value">${freeTrans}</span> FT</div>
        <div class="squad-pill">£<span class="squad-pill__value">${teamValue}m</span></div>
        <div class="squad-pill"><span class="squad-pill__value">${playedCount}/15</span> played</div>
      `;
      if (transferCost > 0) {
        pills += `<div class="squad-pill squad-pill--cost"><span class="squad-pill__value">-${transferCost}pts</span> hit</div>`;
      }
      bar.innerHTML = pills;
    }

    // Render all grids
    renderMyTransfers(allTransfers, transferCost);
    renderPlayerGrid('starting-grid', picks.picks.slice(0, 11), ptsMap, false);
    renderPlayerGrid('bench-grid', picks.picks.slice(11), ptsMap, true);

  } catch (err) {
    console.error('Render error:', err);
    throw err;
  }
}

// ===== TRANSFERS SECTION =====
function renderMyTransfers(allTransfers, cost) {
  const container = document.getElementById('my-transfers-container');
  if (!container) return;

  const gwTransfers = allTransfers.filter(t => t.event === state.currentGW);
  if (gwTransfers.length === 0) { 
    container.innerHTML = ''; 
    return; 
  }

  const costBadge = cost > 0
    ? `<span class="transfer-card__cost">-${cost}pts</span>`
    : '<span style="font-size:0.7rem;color:var(--text-3)">Free</span>';

  const cards = gwTransfers.map((t, i) => {
    const pIn  = state.playerMap[t.element_in]?.name  || '?';
    const pOut = state.playerMap[t.element_out]?.name || '?';
    return `
      <div class="transfer-card">
        <div class="transfer-card__player-out">
          <i class="fa-solid fa-arrow-down" style="font-size:0.65rem;margin-right:4px;"></i>${pOut}
        </div>
        <i class="fa-solid fa-arrow-right transfer-card__arrow"></i>
        <div class="transfer-card__player-in">
          <i class="fa-solid fa-arrow-up" style="font-size:0.65rem;margin-right:4px;"></i>${pIn}
        </div>
        ${i === 0 ? costBadge : ''}
      </div>
    `;
  }).join('');

  container.innerHTML = `
    <div class="section" style="padding-top:12px;padding-bottom:0;">
      <div class="section-header"><span class="section-title">My Transfers</span></div>
      <div class="transfers-section" style="padding:0;">${cards}</div>
    </div>
  `;
}

// ===== PLAYER GRID RENDERING =====
function renderPlayerGrid(gridId, picks, ptsMap, isBench) {
  const grid = document.getElementById(gridId);
  if (!grid) return;

  grid.innerHTML = picks.map(p => {
    const meta = state.playerMap[p.element];
    if (!meta) return '';

    const totalPts = (ptsMap[p.element] || 0) * (p.multiplier || 1);
    const ptsClass = totalPts === 0 ? 'player-card__pts--zero' : '';
    const shirtSrc = `https://draft.premierleague.com/img/shirts/standard/shirt_${meta.teamCode}${meta.pos === 1 ? '_1' : ''}-66.png`;
    const ownershipW = Math.min(parseFloat(meta.ownership) || 0, 100);

    const badge = p.is_captain
      ? '<div class="player-badge player-badge--captain">C</div>'
      : p.is_vice_captain
        ? '<div class="player-badge player-badge--vice">V</div>'
        : '';

    return `
      <div class="player-card ${isBench ? 'is-bench' : ''}" data-pos="${meta.pos}">
        ${badge}
        <img class="player-card__shirt" src="${shirtSrc}" alt="${meta.name}"
          loading="lazy" decoding="async"
          onerror="this.src='https://draft.premierleague.com/img/shirts/standard/shirt_1-66.png'">
        <div class="player-card__name">${meta.name}</div>
        <div class="player-card__pts ${ptsClass}">${totalPts}</div>
        <div class="player-card__ownership">
          <div class="player-card__ownership-fill" style="width:${ownershipW}%"></div>
        </div>
      </div>
    `;
  }).join('');
}

// ===== UTILITIES =====
function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

// ===== APP INITIALIZATION =====
async function startApp() {
  if (!state.fplId) {
    const ls = document.getElementById('login-screen');
    if (ls) ls.style.display = 'flex';
    return;
  }

  try {
    showSkeletons();
    await initBootstrap();
    await fetchAndRender();
  } catch (err) {
    console.error('App error:', err);
    const nameEl = document.getElementById('disp-name');
    if (nameEl) { 
      nameEl.textContent = 'Failed to load'; 
      nameEl.style.color = 'var(--red)'; 
    }
    const teamEl = document.getElementById('disp-team');
    if (teamEl) teamEl.textContent = 'Check your connection and refresh';
    removeSkeletons();
  }
}

// Prevent layout shift by preventing double-init
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', startApp);
} else
