<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOPALA FPL - Pro Analytics</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #2563eb;
            --fpl-green: #00ff85;
            --border-color: #e2e8f0;
            --pitch-green: #2e7d32;
            --danger: #ef4444;
            --success: #10b981;
            --bench-bg: #64748b;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --bench-bg: #1e293b;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }

        .promo-card, .login-card { width: 100%; max-width: 400px; background: var(--card-bg); border: 1px solid var(--border-color); }
        .promo-card { border-radius: 24px; padding: 20px; margin-bottom: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .promo-card h3 { margin: 0; font-size: 1.1rem; font-weight: 800; }
        
        .login-card { border-radius: 28px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .login-card h2 { margin: 0 0 8px 0; font-size: 1.5rem; font-weight: 800; }

        .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .toggle-container { display: flex; background: var(--bg-color); padding: 4px; border-radius: 40px; }
        .toggle-btn { border: none; padding: 8px 18px; border-radius: 30px; font-weight: 800; cursor: pointer; font-size: 0.8rem; }
        .toggle-btn.active { background: var(--primary-blue); color: white; }
        .toggle-btn.inactive { background: transparent; color: var(--text-muted); }

        .fpl-input { 
            width: 100%; padding: 18px; border-radius: 16px; border: 1px solid var(--border-color); 
            font-size: 1rem; margin-bottom: 15px; background: var(--bg-color); color: var(--text-main);
        }
        .continue-btn { 
            width: 100%; padding: 18px; background: var(--primary-blue); color: white; 
            border: none; border-radius: 16px; font-weight: 800; font-size: 1rem; cursor: pointer; 
        }

        /* --- TOP NAVIGATION --- */
        .top-nav {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: var(--card-bg); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 3000;
        }
        .logo-container { font-weight: 900; font-size: 1.3rem; letter-spacing: -1px; }
        .logo-container span { color: var(--fpl-green); }

        .page-content { padding: 75px 12px 100px; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* --- RANK TILES --- */
        .card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border-color); overflow: hidden; }
        .rank-grid { display: grid; grid-template-columns: repeat(3, 1fr); background: var(--border-color); gap: 1px; }
        .stat-tile { background: var(--card-bg); padding: 12px 5px; text-align: center; }
        .stat-tile span { display: block; font-size: 0.6rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; }
        .stat-tile strong { font-size: 0.95rem; font-weight: 900; color: var(--text-main); }

        /* --- PITCH UI --- */
        .pitch-container { 
            background-color: var(--pitch-green);
            background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px;
            padding: 15px 5px; border-radius: 20px; display: flex; flex-direction: column; gap: 10px;
        }
        .pitch-row { display: flex; justify-content: center; gap: 4px; }
        .player-mini { width: 62px; text-align: center; }
        .name-tag { background: #000; color: #fff; font-size: 0.5rem; padding: 2px; border-radius: 3px 3px 0 0; white-space: nowrap; overflow: hidden; }
        .pts-tag { background: #fff; color: #000; font-size: 0.75rem; font-weight: 800; padding: 2px; border-radius: 0 0 3px 3px; }

        /* --- TABLES --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; color: var(--text-main); }
        th { background: var(--bg-color); color: var(--text-muted); padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color); }
        td { padding: 10px 5px; border-bottom: 1px solid var(--border-color); text-align: center; }
        .card-header { padding: 12px 15px; font-weight: 800; font-size: 0.85rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: var(--card-bg); border-top: 1px solid var(--border-color);
            display: grid; grid-template-columns: repeat(5, 1fr); z-index: 3000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); text-decoration: none; font-size: 0.6rem; font-weight: 700; gap: 4px;
        }
        .nav-item.active { color: var(--primary-blue); }
        .nav-item i { font-size: 1.2rem; }

        .hidden { display: none !important; }
    </style>
</head>
<body class="dark-mode">

    <div id="login-screen">
        <div class="promo-card">
            <h3>Used by FPL managers since 2025 ❤️</h3>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">Kopala Pro Analytics v2.1</div>
        </div>

        <div class="login-card">
            <div class="theme-row">
                <span style="font-weight: 700; color: var(--text-muted);">Theme</span>
                <div class="toggle-container">
                    <button id="btn-dark" class="toggle-btn active" onclick="setTheme('dark')">Dark</button>
                    <button id="btn-light" class="toggle-btn inactive" onclick="setTheme('light')">Light</button>
                </div>
            </div>

            <h2>Enter your FPL ID</h2>
            <p style="font-size: 0.9rem; color: var(--text-muted);">Sync your team to see pro analytics.</p>
            
            <input type="number" id="team-id-input" class="fpl-input" placeholder="e.g. 1234567">
            <button class="continue-btn" onclick="handleLogin()">Continue</button>
        </div>
    </div>

    <header class="top-nav">
        <div style="font-size: 1.2rem;"><i class="fa-solid fa-circle-user"></i></div>
        <div class="logo-container">Kopala<span>▲</span>FPL</div>
        <div onclick="toggleTheme()"><i class="fa-solid fa-moon" id="theme-icon"></i></div>
    </header>

    <main id="main-app" class="page-content hidden">
        
        <section class="card">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                <div id="disp-name" style="font-weight: 900; font-size: 1.1rem;">Manager Name</div>
                <div id="disp-gw" style="font-size: 0.75rem; color: var(--primary-blue); font-weight: 700;">GW --</div>
            </div>
            <div class="rank-grid">
                <div class="stat-tile"><span>GW Pts</span><strong id="tile-gw-pts">0</strong></div>
                <div class="stat-tile"><span>Total</span><strong id="tile-total-pts">0</strong></div>
                <div class="stat-tile"><span>Benched</span><strong id="tile-bench-pts">0</strong></div>
                <div class="stat-tile"><span>GW Rank</span><strong id="tile-gw-rank">0</strong></div>
                <div class="stat-tile"><span>Overall</span><strong id="tile-overall-rank">0</strong></div>
                <div class="stat-tile"><span>Change</span><strong id="tile-change">0%</strong></div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">LIVE SQUAD <span id="live-total" style="color: var(--primary-blue)">0 Pts</span></div>
            <div class="pitch-container">
                <div id="gk-row" class="pitch-row"></div>
                <div id="def-row" class="pitch-row"></div>
                <div id="mid-row" class="pitch-row"></div>
                <div id="fwd-row" class="pitch-row"></div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">BENCH</div>
            <div class="pitch-container" style="background: var(--bench-bg); min-height: 80px;">
                <div id="p-bench" class="pitch-row"></div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">YOUR TRANSFERS <span id="hit-val"></span></div>
            <table>
                <thead><tr><th>In</th><th>Out</th><th>Gain</th></tr></thead>
                <tbody id="user-tr-body"></tbody>
            </table>
        </section>

        <section class="card">
            <div class="card-header">NON-OWNED THREATS</div>
            <div class="pitch-container" style="background: var(--text-main);">
                <div id="p-threats" class="pitch-row"></div>
            </div>
        </section>

    </main>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-futbol"></i><span>Games</span></a>
        <a href="https://wa.me/260964836842" class="nav-item"><i class="fa-brands fa-whatsapp"></i><span>Support</span></a>
        <a href="#" class="nav-item" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i><span>Exit</span></a>
    </nav>

    <script>
        const PROXY = "https://corsproxy.io/?";
        const state = {
            fplId: localStorage.getItem('kopala_v2_id'),
            boot: null, live: {}, gw: null
        };

        function setTheme(mode) {
            const isDark = mode === 'dark';
            document.body.classList.toggle('dark-mode', isDark);
            document.getElementById('btn-dark').className = `toggle-btn ${isDark ? 'active' : 'inactive'}`;
            document.getElementById('btn-light').className = `toggle-btn ${!isDark ? 'active' : 'inactive'}`;
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        }

        function toggleTheme() {
            const isDark = document.body.classList.contains('dark-mode');
            setTheme(isDark ? 'light' : 'dark');
        }

        async function handleLogin() {
            const id = document.getElementById('team-id-input').value;
            if(!id) return;
            localStorage.setItem('kopala_v2_id', id);
            state.fplId = id;
            location.reload();
        }

        function logout() {
            localStorage.removeItem('kopala_v2_id');
            location.reload();
        }

        function createPlayerCard(id, mult = 1) {
            const p = state.boot.elements.find(x => x.id === id);
            const pts = (state.live[id]?.total_points || 0) * mult;
            return `
                <div class="player-mini">
                    <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${p.team_code}${p.element_type===1?'_1':''}-66.png" style="width:35px;">
                    <div class="name-tag">${p.web_name}</div>
                    <div class="pts-tag">${pts}</div>
                </div>`;
        }

        async function init() {
            if(!state.fplId) return;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            try {
                const bootRes = await fetch(PROXY + encodeURIComponent("https://fantasy.premierleague.com/api/bootstrap-static/"));
                state.boot = await bootRes.json();
                state.gw = state.boot.events.find(e => e.is_current).id;

                const [entry, picks, live, trans, hist] = await Promise.all([
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${state.fplId}/`)).then(r => r.json()),
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${state.fplId}/event/${state.gw}/picks/`)).then(r => r.json()),
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/event/${state.gw}/live/`)).then(r => r.json()),
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${state.fplId}/transfers/`)).then(r => r.json()),
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${state.fplId}/history/`)).then(r => r.json())
                ]);

                live.elements.forEach(el => state.live[el.id] = el.stats);

                // Render Dashboard
                document.getElementById('disp-name').innerText = `${entry.player_first_name} ${entry.player_last_name}`;
                document.getElementById('disp-gw').innerText = `GAMWEEK ${state.gw}`;
                document.getElementById('tile-total-pts').innerText = entry.summary_overall_points;
                document.getElementById('tile-overall-rank').innerText = entry.summary_overall_rank.toLocaleString();
                
                const curHist = hist.current.find(h => h.event === state.gw);
                const prevHist = hist.current.find(h => h.event === state.gw - 1);
                document.getElementById('tile-gw-rank').innerText = curHist?.rank.toLocaleString() || "-";

                if(prevHist) {
                    const diff = prevHist.overall_rank - entry.summary_overall_rank;
                    const pct = ((diff / prevHist.overall_rank) * 100).toFixed(2);
                    document.getElementById('tile-change').innerText = (diff >= 0 ? "+" : "") + pct + "%";
                    document.getElementById('tile-change').style.color = diff >= 0 ? "var(--success)" : "var(--danger)";
                }

                // Render Squad
                let livePts = 0, benchPts = 0;
                picks.picks.forEach((p, i) => {
                    const html = createPlayerCard(p.element, p.multiplier);
                    const pPts = (state.live[p.element]?.total_points || 0) * p.multiplier;
                    if(i < 11) {
                        livePts += pPts;
                        const pData = state.boot.elements.find(x => x.id === p.element);
                        const row = pData.element_type === 1 ? 'gk-row' : pData.element_type === 2 ? 'def-row' : pData.element_type === 3 ? 'mid-row' : 'fwd-row';
                        document.getElementById(row).innerHTML += html;
                    } else {
                        benchPts += (state.live[p.element]?.total_points || 0);
                        document.getElementById('p-bench').innerHTML += html;
                    }
                });
                document.getElementById('tile-gw-pts').innerText = livePts;
                document.getElementById('live-total').innerText = livePts + " Pts";
                document.getElementById('tile-bench-pts').innerText = benchPts;

                // Render Transfers
                const gwTrans = trans.filter(t => t.event === state.gw);
                gwTrans.forEach(t => {
                    const gain = (state.live[t.element_in]?.total_points || 0) - (state.live[t.element_out]?.total_points || 0);
                    document.getElementById('user-tr-body').innerHTML += `<tr><td>${createPlayerCard(t.element_in)}</td><td>${createPlayerCard(t.element_out)}</td><td style="font-weight:900">${gain}</td></tr>`;
                });

                // Render Threats
                const owned = picks.picks.map(p => p.element);
                state.boot.elements
                    .filter(e => !owned.includes(e.id))
                    .sort((a,b) => (state.live[b.id]?.total_points || 0) - (state.live[a.id]?.total_points || 0))
                    .slice(0, 5)
                    .forEach(t => document.getElementById('p-threats').innerHTML += createPlayerCard(t.id));

            } catch (err) { console.error(err); }
        }

        init();
    </script>
</body>
</html>
