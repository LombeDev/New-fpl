<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kopala FPL - Live GW</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#38003c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5323/5323982.png">
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Container Spacing & Layout */
        .player-grid-container {
            background: var(--card-bg, #eef3f7); 
            padding: 10px 0;
            border-radius: 12px;
            margin: 0 10px 20px 10px;
        }

        .player-list-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px 2px;
            justify-items: center;
            margin-bottom: 25px;
        }

        /* Compact Player Cards */
        .compact-player-card {
            width: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .compact-player-card img {
            width: 24px; 
            margin-bottom: 2px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
            z-index: 2;
        }

        .card-name {
            font-size: 0.45rem;
            font-weight: 800;
            color: var(--text-color);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .card-points {
            background: #ffffff;
            color: #000;
            font-size: 0.65rem;
            font-weight: 900;
            padding: 1px 4px;
            border-radius: 4px;
            margin: 2px 0;
            min-width: 22px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .card-ownership-bar {
            height: 4px;
            border-radius: 2px;
            width: 90%;
            background: #ddd;
            overflow: hidden;
        }

        /* Install Button Styling */
        #download-container {
            display: none;
            justify-content: center;
            margin: 10px 0;
        }
        
        .install-btn {
            background-color: #38003c !important;
            color: white !important;
            animation: pulse 2s infinite;
            cursor: pointer;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        .is-bench { opacity: 0.6; }
    </style>
</head>
<body class="dark-mode">

    <div id="login-screen" style="display:none;">
        <div class="login-card">
            <h2>Enter your FPL ID</h2>
            <input type="text" id="team-id-input" class="fpl-input" placeholder="e.g. 1234567">
            <button id="login-btn" class="continue-btn" onclick="handleLogin()">Continue</button>
            <div id="error-message" class="error-msg" style="display:none;"></div>
        </div>
    </div>

    <div id="nav-placeholder"></div>

    <div id="download-container">
        <button id="btn-install" class="info-pill install-btn">
            <i class="fa-solid fa-download"></i> DOWNLOAD KOPALA APP
        </button>
    </div>

    <main class="page-content">
        <div style="padding: 15px; display:flex; justify-content:space-between; align-items:center;">
            <span id="disp-name" style="font-weight:900; font-size: 1.2rem;">Manager Name</span>
        </div>
        
        <div class="header-stats-grid">
            <div><div class="stat-label">GW Rank</div><div class="stat-value" id="disp-gw-rank">-</div></div>
            <div><div class="stat-label">Overall Rank</div><div class="stat-value" id="disp-rank">0</div></div>
            <div><div class="stat-label">Live Pts</div><div class="stat-value" id="disp-total">0</div></div>
        </div>

        <div class="player-grid-container">
            <div class="grid-top-info">
                <span class="info-pill" id="stat-ft">FT 1</span>
                <span class="info-pill" id="stat-tv">TV Â£--</span>
                <span class="info-pill" id="stat-played">PLAYED -/-</span>
            </div>
            <div id="player-list-grid" class="player-list-grid"></div>
        </div>

        <div id="deadline-container"></div>

        <div id="transfers-container" class="transfers-grid"></div>
        
    </main>

    <div id="footer-placeholder"></div>

    <script>
        const state = {
            fplId: localStorage.getItem('kopala_id'),
            playerMap: {}, teamMap: {}, currentGW: 1
        };

        const PROXY = "/.netlify/functions/fpl-proxy?endpoint=";

        async function handleLogin() {
            const input = document.getElementById('team-id-input').value.trim();
            const id = input.match(/\d+/) ? input.match(/\d+/)[0] : null;
            if (!id) return;
            
            localStorage.setItem('kopala_id', id);
            location.reload();
        }

        async function initData() {
            const res = await fetch(`${PROXY}bootstrap-static/`);
            const data = await res.json();
            data.teams.forEach(t => state.teamMap[t.id] = { code: t.code });
            data.elements.forEach(p => state.playerMap[p.id] = { 
                name: p.web_name, 
                team_code: state.teamMap[p.team].code, 
                pos: p.element_type,
                own: p.selected_by_percent
            });
            state.currentGW = data.events.find(e => e.is_current).id;
        }

        async function fetchAndRender() {
            const [entryRes, picksRes, liveRes] = await Promise.all([
                fetch(`${PROXY}entry/${state.fplId}/`),
                fetch(`${PROXY}entry/${state.fplId}/event/${state.currentGW}/picks/`),
                fetch(`${PROXY}event/${state.currentGW}/live/`)
            ]);
            const entry = await entryRes.json();
            const picks = await picksRes.json();
            const live = await liveRes.json();

            document.getElementById('disp-name').textContent = `${entry.player_first_name} ${entry.player_last_name}`;
            document.getElementById('disp-total').textContent = picks.entry_history.points;
            document.getElementById('disp-rank').textContent = entry.summary_overall_rank.toLocaleString();
            
            const ptsMap = {};
            live.elements.forEach(el => ptsMap[el.id] = el.stats.total_points);
            renderPlayerGrid(picks.picks, ptsMap);
        }

        function renderPlayerGrid(picks, ptsMap) {
            const grid = document.getElementById('player-list-grid');
            grid.innerHTML = picks.map((p, i) => {
                const meta = state.playerMap[p.element];
                const isBench = i >= 11;
                return `
                    <div class="compact-player-card ${isBench ? 'is-bench' : ''}">
                        <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${meta.team_code}${meta.pos === 1 ? '_1' : ''}-66.png">
                        <div class="card-name">${meta.name}</div>
                        <div class="card-points">${(ptsMap[p.element] || 0) * p.multiplier}</div>
                        <div class="card-ownership-bar"><div style="width:${meta.own}%; background:#00ff85; height:100%"></div></div>
                    </div>`;
            }).join('');
        }

        if(state.fplId) {
            initData().then(fetchAndRender);
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
    </script>
    
    <script src="nav.js"></script>
    <script src="deadline.js"></script>
    <script src="transfers.js"></script>
    <script src="footer.js"></script>
    <script src="install.js"></script> </body>
</html>
