<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kopala FPL — Live Rank</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d0d0d">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kopala FPL">
  <link rel="apple-touch-icon" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="nav.css">
  <link rel="stylesheet" href="footer.css">

  <style>
    /* ===== ROOT VARIABLES ===== */
    :root {
      --safe-top: max(16px, env(safe-area-inset-top));
      --safe-bottom: max(16px, env(safe-area-inset-bottom));
      --safe-left: max(16px, env(safe-area-inset-left));
      --safe-right: max(16px, env(safe-area-inset-right));
      --transition-fast: 0.15s ease-out;
      --transition-normal: 0.3s ease-out;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
      overscroll-behavior-y: contain;
    }

    .page-content {
      -webkit-overflow-scrolling: touch;
      contain: layout style paint;
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
      padding-bottom: var(--safe-bottom);
    }

    #nav-placeholder {
      padding-top: var(--safe-top);
    }

    img {
      content-visibility: auto;
      will-change: contents;
      background: var(--bg-2);
      border-radius: 8px;
    }

    img[loading="lazy"] {
      aspect-ratio: 1;
    }

    /* ===== PITCH CONTAINER ===== */
    .pitch-container {
      width: 100%;
      max-width: 100%;
      background: linear-gradient(135deg, #1a7f3f 0%, #228f4f 50%, #1a7f3f 100%);
      border: 8px solid #fff;
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
      position: relative;
      aspect-ratio: 5/7;
      contain: layout style paint;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    /* Pitch lines */
    .pitch-container::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      height: 90%;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 20px;
    }

    .pitch-container::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 90%;
      background: rgba(255, 255, 255, 0.4);
    }

    /* Center spot */
    .pitch-container {
      background-image: 
        radial-gradient(circle 6px at 50% 50%, rgba(255, 255, 255, 0.5) 99%, transparent 100%);
      background-size: 100% 100%;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* ===== FORMATION SECTIONS ===== */
    .pitch-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      position: relative;
      z-index: 2;
    }

    .pitch-formation {
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      gap: 4px;
      padding: 8px 0;
    }

    /* ===== PLAYER CARD ON PITCH ===== */
    .pitch-player {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: transform var(--transition-fast);
      will-change: transform;
    }

    .pitch-player:active {
      transform: scale(0.95);
    }

    /* Player Jersey Circle */
    .player-jersey-wrapper {
      position: relative;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      border: 2px solid #f0f0f0;
    }

    .player-jersey-wrapper img {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      background: white;
    }

    /* Captain/VC Badge */
    .player-badge-pitch {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      background: #ff1500;
      border: 2px solid white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 900;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .player-badge-pitch.vice {
      background: #ff8f00;
    }

    /* Player Info Card Below Jersey */
    .player-info-card {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 6px;
      border-radius: 6px;
      text-align: center;
      min-width: 48px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
    }

    .player-name-pitch {
      font-size: 0.65rem;
      font-weight: 600;
      line-height: 1.1;
      letter-spacing: -0.3px;
    }

    .player-points-pitch {
      font-size: 0.8rem;
      font-weight: 700;
      color: #4ade80;
      line-height: 1;
    }

    .player-ownership-bar {
      width: 100%;
      height: 2px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 1px;
      margin-top: 2px;
      overflow: hidden;
    }

    .player-ownership-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    }

    /* ===== BENCH SECTION ===== */
    .bench-section {
      background: rgba(0, 0, 0, 0.05);
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 12px;
      margin-top: 16px;
    }

    .bench-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-2);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .bench-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
      gap: 6px;
    }

    .bench-player {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }

    .bench-player .player-jersey-wrapper {
      width: 42px;
      height: 42px;
    }

    .bench-player .player-jersey-wrapper img {
      width: 38px;
      height: 38px;
    }

    .bench-player .player-info-card {
      min-width: 42px;
      padding: 3px 4px;
      font-size: 0.6rem;
    }

    .bench-player .player-name-pitch {
      font-size: 0.6rem;
    }

    .bench-player .player-points-pitch {
      font-size: 0.7rem;
    }

    /* ===== STATS & CHIPS ===== */
    .stat-chip, .squad-pill {
      min-height: 56px;
      transition: background-color var(--transition-normal), color var(--transition-normal);
      will-change: background-color;
      contain: layout style;
    }

    .stat-chips-row {
      min-height: 70px;
      contain: layout;
    }

    .squad-bar {
      min-height: 50px;
    }

    .section {
      padding: 16px;
      contain: layout;
    }

    .section-header {
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    /* ===== SKELETON LOADING ===== */
    @keyframes shimmer {
      0%, 100% { opacity: 0.6; background: var(--bg-2); }
      50% { opacity: 1; background: var(--bg-3); }
    }

    .skeleton {
      animation: shimmer 1.5s infinite;
    }

    /* ===== TOUCH & FOCUS ===== */
    .pitch-player,
    .stat-chip,
    .squad-pill,
    .continue-btn {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    button {
      transition: all var(--transition-fast);
      position: relative;
    }

    button:active {
      transform: scale(0.98);
    }

    button:focus-visible,
    input:focus-visible,
    a:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 480px) {
      .pitch-container {
        padding: 12px;
      }

      .player-jersey-wrapper {
        width: 42px;
        height: 42px;
      }

      .player-jersey-wrapper img {
        width: 38px;
        height: 38px;
      }

      .player-info-card {
        min-width: 42px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    .pitch-player {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .pitch-player:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen" style="display:none;">
  <div class="login-hero">
    <div class="login-hero__wordmark">KOPALA <span>FPL</span></div>
    <p class="login-hero__sub">Zambia's sharpest FPL companion</p>
  </div>
  <div class="login-card">
    <h2>Enter your FPL ID</h2>
    <p>Paste your team ID or your full FPL team URL — we'll figure it out.</p>
    <div>
      <input type="text" id="team-id-input" class="fpl-input"
        placeholder="e.g. 1234567 or paste link"
        autocomplete="off" inputmode="numeric" spellcheck="false">
      <div id="error-message" class="error-msg"></div>
    </div>
    <button id="login-btn" class="continue-btn" onclick="handleLogin()">Continue</button>
    <div class="find-id-link" onclick="window.open('https://youtu.be/gZqblBRbAjw?si=IQ-hmIEES27jDaTn','_blank')">
      <i class="fa-solid fa-circle-question"></i> How to find my Team ID?
    </div>
  </div>
</div>

<!-- NAV -->
<div id="nav-placeholder"></div>

<!-- MAIN -->
<main class="page-content" id="main-content">

  <div id="deadline-container"></div>

  <div class="manager-header">
    <div id="disp-name" class="manager-header__name">Manager Name</div>
    <div id="disp-team" class="manager-header__team">Team Name</div>
  </div>

  <div class="stat-chips-row" id="stat-chips-row">
    <div class="stat-chip stat-chip--highlight">
      <div class="stat-chip__label">GW Points</div>
      <div class="stat-chip__value t-number" id="disp-total">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">GW Rank</div>
      <div class="stat-chip__value t-number" id="disp-gw-rank">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Overall</div>
      <div class="stat-chip__value t-number" id="disp-rank">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Total Pts</div>
      <div class="stat-chip__value t-number" id="disp-total-pts">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">GW Avg</div>
      <div class="stat-chip__value t-number" id="disp-gw-avg">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Highest</div>
      <div class="stat-chip__value t-number" id="disp-gw-high">—</div>
    </div>
  </div>

  <div id="squad-bar-container" class="squad-bar"></div>

  <div id="my-transfers-container"></div>

  <!-- PITCH VIEW -->
  <div class="section">
    <div class="section-header">
      <span class="section-title">Formation</span>
      <span id="gw-label" class="t-label" style="color:var(--text-3)">GW —</span>
    </div>
    <div id="pitch-container" class="pitch-container"></div>
  </div>

  <!-- BENCH SECTION -->
  <div class="bench-section" id="bench-section" style="display:none; margin: 12px;">
    <div class="bench-title">Substitutes</div>
    <div id="bench-grid" class="bench-grid"></div>
  </div>

  <div id="transfers-container"></div>
  <div id="footer-placeholder"></div>

</main>

<script>
// ===== STATE & CONFIG =====
const state = {
  fplId:     localStorage.getItem('kopala_id'),
  playerMap: {},
  teamMap:   {},
  currentGW: 1,
  gwAverage: 0,
  gwHigh:    0,
  cache:     {},
  cacheTime: {},
};

const PROXY = '/.netlify/functions/fpl-proxy?endpoint=';
const CACHE_TTL = 5 * 60 * 1000;

// ===== CACHING =====
async function cachedFetch(url) {
  const now = Date.now();
  if (state.cache[url] && (now - state.cacheTime[url]) < CACHE_TTL) {
    return state.cache[url];
  }
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Failed to fetch ${url}`);
  const data = await res.json();
  state.cache[url] = data;
  state.cacheTime[url] = now;
  return data;
}

// ===== LOGIN =====
async function handleLogin() {
  const input   = document.getElementById('team-id-input');
  const errorEl = document.getElementById('error-message');
  const btn     = document.getElementById('login-btn');

  input.classList.remove('error');
  errorEl.style.display = 'none';

  let raw = input.value.trim();
  const match = raw.match(/entry\/(\d+)/);
  if (match) raw = match[1];

  const id = parseInt(raw, 10);
  if (!id || isNaN(id)) return showErr('Please enter a valid numeric ID');

  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking…';
    const res = await fetch(`${PROXY}entry/${id}/`);
    if (!res.ok) throw new Error('Not found');
    localStorage.setItem('kopala_id', id);
    location.reload();
  } catch {
    showErr('Team ID not found. Please try again.');
    btn.disabled = false;
    btn.textContent = 'Continue';
  }

  function showErr(msg) {
    input.classList.add('error');
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
  }
}

document.getElementById('team-id-input')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') handleLogin();
});

// ===== SKELETONS =====
function showSkeletons() {
  ['disp-name', 'disp-team'].forEach(id => {
    document.getElementById(id)?.classList.add('skeleton');
  });
  ['disp-total','disp-gw-rank','disp-rank','disp-total-pts','disp-gw-avg','disp-gw-high'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { 
      el.textContent = '—'; 
      el.closest('.stat-chip')?.classList.add('skeleton'); 
    }
  });
  
  const pitchContainer = document.getElementById('pitch-container');
  if (pitchContainer) {
    pitchContainer.innerHTML = Array.from({length: 15}, () => 
      '<div style="width: 48px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 8px; animation: shimmer 1.5s infinite;"></div>'
    ).join('');
  }
  
  const bar = document.getElementById('squad-bar-container');
  if (bar) bar.innerHTML = [80,70,90].map((w, i) =>
    `<div class="squad-pill skeleton" style="width:${w}px;height:32px;animation-delay:${i * 0.1}s;"></div>`
  ).join('');
}

function removeSkeletons() {
  document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));
}

// ===== BOOTSTRAP =====
async function initBootstrap() {
  const data = await cachedFetch(`${PROXY}bootstrap-static/`);

  const teamMap = {};
  const playerMap = {};
  
  data.teams.forEach(t => { 
    teamMap[t.id] = { code: t.code }; 
  });
  
  data.elements.forEach(p => {
    playerMap[p.id] = {
      name:      p.web_name,
      teamCode:  teamMap[p.team]?.code || '1',
      pos:       p.element_type,
      ownership: p.selected_by_percent || 0,
    };
  });

  Object.assign(state, { teamMap, playerMap });

  const live = data.events.find(e => e.is_current) || 
               data.events.find(e => e.is_next) || 
               data.events[data.events.length - 1];
  
  state.currentGW = live.id;
  state.gwAverage = live.average_entry_score || 0;
  state.gwHigh = live.highest_score || 0;
}

// ===== FORMATION DETECTION =====
function detectFormation(picks) {
  const startingXI = picks.slice(0, 11);
  let gk = 0, def = 0, mid = 0, fwd = 0;
  
  startingXI.forEach(p => {
    const pos = state.playerMap[p.element]?.pos;
    if (pos === 1) gk++;
    else if (pos === 2) def++;
    else if (pos === 3) mid++;
    else if (pos === 4) fwd++;
  });
  
  return { gk, def, mid, fwd };
}

// ===== RENDER PITCH =====
function renderPitch(picks, ptsMap) {
  const startingXI = picks.slice(0, 11);
  const formation = detectFormation(picks);
  const { def, mid, fwd } = formation;
  
  const pitchContainer = document.getElementById('pitch-container');
  if (!pitchContainer) return;
  
  let html = '';
  
  // Goalkeeper
  const gkPicks = startingXI.filter(p => state.playerMap[p.element]?.pos === 1);
  html += `<div class="pitch-section">
    <div class="pitch-formation">
      ${gkPicks.map(p => createPitchPlayer(p, ptsMap)).join('')}
    </div>
  </div>`;
  
  // Defenders
  const defPicks = startingXI.filter(p => state.playerMap[p.element]?.pos === 2);
  html += `<div class="pitch-section">
    <div class="pitch-formation">
      ${defPicks.map(p => createPitchPlayer(p, ptsMap)).join('')}
    </div>
  </div>`;
  
  // Midfielders
  const midPicks = startingXI.filter(p => state.playerMap[p.element]?.pos === 3);
  html += `<div class="pitch-section">
    <div class="pitch-formation">
      ${midPicks.map(p => createPitchPlayer(p, ptsMap)).join('')}
    </div>
  </div>`;
  
  // Forwards
  const fwdPicks = startingXI.filter(p => state.playerMap[p.element]?.pos === 4);
  html += `<div class="pitch-section">
    <div class="pitch-formation">
      ${fwdPicks.map(p => createPitchPlayer(p, ptsMap)).join('')}
    </div>
  </div>`;
  
  pitchContainer.innerHTML = html;
}

// ===== CREATE PITCH PLAYER ELEMENT =====
function createPitchPlayer(pick, ptsMap) {
  const meta = state.playerMap[pick.element];
  if (!meta) return '';
  
  const totalPts = (ptsMap[pick.element] || 0) * (pick.multiplier || 1);
  const shirtSrc = `https://draft.premierleague.com/img/shirts/standard/shirt_${meta.teamCode}${meta.pos === 1 ? '_1' : ''}-66.png`;
  const ownershipW = Math.min(parseFloat(meta.ownership) || 0, 100);
  
  let badgeHtml = '';
  if (pick.is_captain) {
    badgeHtml = '<div class="player-badge-pitch">C</div>';
  } else if (pick.is_vice_captain) {
    badgeHtml = '<div class="player-badge-pitch vice">V</div>';
  }
  
  return `
    <div class="pitch-player">
      <div class="player-jersey-wrapper">
        <img src="${shirtSrc}" alt="${meta.name}" loading="lazy" decoding="async"
          onerror="this.src='https://draft.premierleague.com/img/shirts/standard/shirt_1-66.png'">
        ${badgeHtml}
      </div>
      <div class="player-info-card">
        <div class="player-name-pitch">${meta.name}</div>
        <div class="player-points-pitch">${totalPts}</div>
        <div class="player-ownership-bar">
          <div class="player-ownership-fill" style="width:${ownershipW}%"></div>
        </div>
      </div>
    </div>
  `;
}

// ===== RENDER BENCH =====
function renderBench(picks, ptsMap) {
  const bench = picks.slice(11);
  const benchSection = document.getElementById('bench-section');
  const benchGrid = document.getElementById('bench-grid');
  
  if (!benchSection || !benchGrid) return;
  
  if (bench.length === 0) {
    benchSection.style.display = 'none';
    return;
  }
  
  benchSection.style.display = 'block';
  benchGrid.innerHTML = bench.map(p => {
    const meta = state.playerMap[p.element];
    if (!meta) return '';
    
    const totalPts = (ptsMap[p.element] || 0) * (p.multiplier || 1);
    const shirtSrc = `https://draft.premierleague.com/img/shirts/standard/shirt_${meta.teamCode}${meta.pos === 1 ? '_1' : ''}-66.png`;
    const ownershipW = Math.min(parseFloat(meta.ownership) || 0, 100);
    
    return `
      <div class="bench-player">
        <div class="player-jersey-wrapper">
          <img src="${shirtSrc}" alt="${meta.name}" loading="lazy" decoding="async"
            onerror="this.src='https://draft.premierleague.com/img/shirts/standard/shirt_1-66.png'">
        </div>
        <div class="player-info-card">
          <div class="player-name-pitch">${meta.name}</div>
          <div class="player-points-pitch">${totalPts}</div>
          <div class="player-ownership-bar">
            <div class="player-ownership-fill" style="width:${ownershipW}%"></div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ===== MAIN RENDER =====
async function fetchAndRender() {
  try {
    const urls = [
      `${PROXY}entry/${state.fplId}/`,
      `${PROXY}entry/${state.fplId}/event/${state.currentGW}/picks/`,
      `${PROXY}event/${state.currentGW}/live/`,
      `${PROXY}entry/${state.fplId}/transfers/`,
    ];

    const [entry, picks, live, allTransfers] = await Promise.all(
      urls.map(url => cachedFetch(url))
    );

    removeSkeletons();

    document.getElementById('disp-name').textContent = 
      `${entry.player_first_name} ${entry.player_last_name}`;
    document.getElementById('disp-team').textContent = entry.name;
    
    const gwLabel = document.getElementById('gw-label');
    if (gwLabel) gwLabel.textContent = `GW ${state.currentGW}`;

    const ptsMap = {};
    live.elements.forEach(el => { 
      ptsMap[el.id] = el.stats.total_points; 
    });

    const transferCost = picks.entry_history.event_transfers_cost || 0;
    const netPoints = picks.entry_history.points - transferCost;
    const teamValue = (entry.last_deadline_value / 10).toFixed(1);
    const freeTrans = entry.extra_free_transfers ?? 1;
    
    let playedCount = 0;
    picks.picks.forEach(p => {
      const el = live.elements.find(e => e.id === p.element);
      if (el && el.stats.minutes > 0) playedCount++;
    });

    setText('disp-total', netPoints.toLocaleString());
    setText('disp-gw-rank', (picks.entry_history.rank || 0).toLocaleString());
    setText('disp-rank', entry.summary_overall_rank.toLocaleString());
    setText('disp-total-pts', entry.summary_overall_points.toLocaleString());
    setText('disp-gw-avg', state.gwAverage);
    setText('disp-gw-high', state.gwHigh);

    const bar = document.getElementById('squad-bar-container');
    if (bar) {
      let pills = `
        <div class="squad-pill"><span class="squad-pill__value">${freeTrans}</span> FT</div>
        <div class="squad-pill">£<span class="squad-pill__value">${teamValue}m</span></div>
        <div class="squad-pill"><span class="squad-pill__value">${playedCount}/15</span> played</div>
      `;
      if (transferCost > 0) {
        pills += `<div class="squad-pill squad-pill--cost"><span class="squad-pill__value">-${transferCost}pts</span> hit</div>`;
      }
      bar.innerHTML = pills;
    }

    renderMyTransfers(allTransfers, transferCost);
    renderPitch(picks.picks, ptsMap);
    renderBench(picks.picks, ptsMap);

  } catch (err) {
    console.error('Render error:', err);
    throw err;
  }
}

// ===== TRANSFERS =====
function renderMyTransfers(allTransfers, cost) {
  const container = document.getElementById('my-transfers-container');
  if (!container) return;

  const gwTransfers = allTransfers.filter(t => t.event === state.currentGW);
  if (gwTransfers.length === 0) { 
    container.innerHTML = ''; 
    return; 
  }

  const costBadge = cost > 0
    ? `<span class="transfer-card__cost">-${cost}pts</span>`
    : '<span style="font-size:0.7rem;color:var(--text-3)">Free</span>';

  const cards = gwTransfers.map((t, i) => {
    const pIn  = state.playerMap[t.element_in]?.name  || '?';
    const pOut = state.playerMap[t.element_out]?.name || '?';
    return `
      <div class="transfer-card">
        <div class="transfer-card__player-out">
          <i class="fa-solid fa-arrow-down" style="font-size:0.65rem;margin-right:4px;"></i>${pOut}
        </div>
        <i class="fa-solid fa-arrow-right transfer-card__arrow"></i>
        <div class="transfer-card__player-in">
          <i class="fa-solid fa-arrow-up" style="font-size:0.65rem;margin-right:4px;"></i>${pIn}
        </div>
        ${i === 0 ? costBadge : ''}
      </div>
    `;
  }).join('');

  container.innerHTML = `
    <div class="section" style="padding-top:12px;padding-bottom:0;">
      <div class="section-header"><span class="section-title">My Transfers</span></div>
      <div class="transfers-section" style="padding:0;">${cards}</div>
    </div>
  `;
}

// ===== UTILITIES =====
function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

// ===== APP INITIALIZATION =====
async function startApp() {
  if (!state.fplId) {
    const ls = document.getElementById('login-screen');
    if (ls) ls.style.display = 'flex';
    return;
  }

  try {
    showSkeletons();
    await initBootstrap();
    await fetchAndRender();
  } catch (err) {
    console.error('App error:', err);
    const nameEl = document.getElementById('disp-name');
    if (nameEl) { 
      nameEl.textContent = 'Failed to load'; 
      nameEl.style.color = 'var(--red)'; 
    }
    const teamEl = document.getElementById('disp-team');
    if (teamEl) teamEl.textContent = 'Check your connection and refresh';
    removeSkeletons();
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', startApp);
} else {
  startApp();
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>

<script src="nav.js" async></script>
<script src="deadline.js" async></script>
<script src="transfers.js" async></script>
<script src="footer.js" async></script>

</body>
</html>
