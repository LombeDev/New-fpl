<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kopala FPL — Live Rank</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d0d0d">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kopala FPL">
  <link rel="apple-touch-icon" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="nav.css">
  <link rel="stylesheet" href="footer.css">

  <style>
    /* =============================================
       PITCH VIEW
       ============================================= */

    .pitch-wrap {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      margin: 0 12px 8px;
      /* Alternating grass stripes */
      background:
        repeating-linear-gradient(
          180deg,
          rgba(255,255,255,0.025) 0px, rgba(255,255,255,0.025) 1px,
          transparent 1px, transparent 44px
        ),
        linear-gradient(
          180deg,
          #1b4d1b 0%, #1b4d1b 12.5%,
          #1f5620 12.5%, #1f5620 25%,
          #1b4d1b 25%, #1b4d1b 37.5%,
          #1f5620 37.5%, #1f5620 50%,
          #1b4d1b 50%, #1b4d1b 62.5%,
          #1f5620 62.5%, #1f5620 75%,
          #1b4d1b 75%, #1b4d1b 87.5%,
          #1f5620 87.5%, #1f5620 100%
        );
      box-shadow:
        inset 0 0 80px rgba(0,0,0,0.5),
        0 4px 24px rgba(0,0,0,0.4);
    }

    /* Blurry overlay — just enough to feel like real grass depth */
    .pitch-wrap::before {
      content: '';
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.15);
      backdrop-filter: blur(0.5px);
      -webkit-backdrop-filter: blur(0.5px);
      pointer-events: none; z-index: 0;
    }

    /* SVG pitch markings */
    .pitch-markings {
      position: absolute; inset: 0;
      pointer-events: none; z-index: 1;
    }
    .pitch-markings svg { width:100%; height:100%; opacity:0.1; }

    /* Player rows sit above everything */
    .pitch-field {
      position: relative; z-index: 2;
      padding: 12px 8px 8px;
      display: flex; flex-direction: column; gap: 4px;
    }

    .pitch-row {
      display: flex; justify-content: center; gap: 4px;
    }

    /* ---- Pitch player card ---- */
    .ppc {
      display: flex; flex-direction: column; align-items: center;
      width: 60px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .ppc__shirt-wrap {
      position: relative;
      width: 44px; height: 48px;
      display: flex; align-items: center; justify-content: center;
    }

    .ppc__shirt {
      width: 42px; height: auto;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.7));
      transition: transform 0.15s ease;
    }
    .ppc:active .ppc__shirt { transform: scale(0.9); }

    /* Captain / VC */
    .ppc__badge {
      position: absolute; top: 1px; right: -1px;
      width: 16px; height: 16px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.58rem; font-weight: 900;
      box-shadow: 0 1px 5px rgba(0,0,0,0.6);
    }
    .badge-c  { background: #00e87a; color: #000; }
    .badge-vc { background: rgba(0,0,0,0.8); color: #bbb; border: 1px solid rgba(255,255,255,0.18); }

    /* Live playing dot */
    .ppc__live {
      display: none;
      width: 6px; height: 6px; border-radius: 50%;
      background: #00e87a;
      position: absolute; bottom: 1px; left: 0;
      box-shadow: 0 0 5px #00e87a;
      animation: livep 1.4s ease-in-out infinite;
    }
    .ppc.playing .ppc__live { display: block; }
    @keyframes livep { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.65)} }

    /* Points pill */
    .ppc__pts {
      background: rgba(0,0,0,0.85);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 5px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.9rem; font-weight: 900; color: #fff;
      padding: 1px 7px; min-width: 24px; text-align: center;
      line-height: 1.35; margin-top: 2px; margin-bottom: 2px;
    }
    .ppc__pts.pts-zero  { color: #555; background: rgba(0,0,0,0.7); }
    .ppc__pts.pts-high  { background: rgba(0,232,122,0.88); color: #000; border-color: transparent; }
    .ppc__pts.pts-great { background: rgba(0,232,122,1); color: #000; border-color: transparent; }

    /* Name tag */
    .ppc__name {
      background: rgba(0,0,0,0.82);
      border-radius: 4px;
      font-size: 0.5rem; font-weight: 700; color: #f2f2f2;
      padding: 2px 5px; text-align: center;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 60px; width: 100%;
    }

    /* Bench section */
    .bench-stripe {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 10px; position: relative; z-index: 2;
    }
    .bench-stripe__line { flex:1; height:1px; background: rgba(255,255,255,0.1); }
    .bench-stripe__txt {
      font-size: 0.54rem; font-weight: 700; letter-spacing: 1.2px;
      text-transform: uppercase; color: rgba(255,255,255,0.3);
    }

    .pitch-bench {
      position: relative; z-index: 2;
      display: flex; justify-content: center; gap: 4px;
      padding: 0 8px 14px;
    }
    .pitch-bench .ppc { opacity: 0.65; }
    .pitch-bench .ppc__shirt { width: 34px; }
    .pitch-bench .ppc__shirt-wrap { width: 38px; height: 40px; }
    .pitch-bench .ppc__pts { font-size: 0.82rem; }

    /* =============================================
       PITCH / LIST TOGGLE
       ============================================= */
    .view-toggle {
      display: flex; gap: 3px;
      background: #1a1a1a;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px; padding: 3px;
      margin: 0 12px 10px;
    }
    .vtb {
      flex: 1; padding: 7px 4px; border: none; border-radius: 7px;
      background: transparent; cursor: pointer;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.82rem; font-weight: 800; color: #555;
      display: flex; align-items: center; justify-content: center; gap: 5px;
      transition: all 0.18s; -webkit-tap-highlight-color: transparent;
    }
    .vtb i { font-size: 0.72rem; }
    .vtb.on { background: #272727; color: #fff; }

    /* =============================================
       LIST VIEW
       ============================================= */
    .lv-wrap { padding: 0 12px; }

    .lv-section { margin-bottom: 14px; }
    .lv-pos-head {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 0 5px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 3px;
    }
    .lv-pos-badge {
      font-size: 0.57rem; font-weight: 800; letter-spacing: 0.8px;
      text-transform: uppercase; padding: 2px 7px; border-radius: 4px;
    }
    .pos-b-gkp { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .pos-b-def  { background: rgba(34,197,94,0.15);  color: #22c55e; }
    .pos-b-mid  { background: rgba(59,130,246,0.15);  color: #3b82f6; }
    .pos-b-fwd  { background: rgba(239,68,68,0.15);   color: #ef4444; }
    .pos-b-bnc  { background: rgba(255,255,255,0.06); color: #555; }
    .lv-pos-total {
      margin-left: auto;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.78rem; font-weight: 900; color: #444;
    }

    .lv-row {
      display: grid;
      grid-template-columns: 32px 1fr 32px;
      align-items: center; gap: 10px;
      padding: 9px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .lv-row:last-child { border-bottom: none; }
    .lv-row.bench { opacity: 0.5; }

    .lv-shirt { width: 28px; height: auto; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.4)); }

    .lv-info { min-width: 0; }
    .lv-name {
      font-size: 0.84rem; font-weight: 700; color: #eee;
      display: flex; align-items: center; gap: 5px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .lv-cap-badge {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.54rem; font-weight: 900;
      padding: 1px 4px; border-radius: 3px; flex-shrink: 0;
    }
    .cap-c  { background: #00e87a; color: #000; }
    .cap-vc { background: #222; color: #777; border: 1px solid rgba(255,255,255,0.1); }

    .lv-meta {
      font-size: 0.6rem; color: #555; margin-top: 2px;
      display: flex; align-items: center; gap: 5px;
    }
    .lv-own-bar { width: 38px; height: 3px; background: #222; border-radius: 100px; overflow: hidden; }
    .lv-own-fill { height: 100%; background: #00e87a; border-radius: 100px; }

    .lv-pts {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.15rem; font-weight: 900; color: #fff;
      text-align: right;
    }
    .lv-pts.pts-zero  { color: #444; }
    .lv-pts.pts-high  { color: #00e87a; }

    /* =============================================
       SKELETONS
       ============================================= */
    .pitch-skel {
      height: 420px; border-radius: 16px; margin: 0 12px 8px;
      background: #171717; position: relative; overflow: hidden;
    }
    .pitch-skel::after {
      content: ''; position: absolute; top:0; left:-150%; width:100%; height:100%;
      background: linear-gradient(110deg,transparent 20%,rgba(255,255,255,0.03) 50%,transparent 80%);
      animation: shim 1.6s infinite ease-in-out;
    }
    @keyframes shim { from{left:-150%} to{left:150%} }

    .list-skel { padding: 0 12px; }
    .list-skel-row {
      height: 50px; border-radius: 10px; margin-bottom: 6px;
      background: #171717; position: relative; overflow: hidden;
    }
    .list-skel-row::after {
      content:''; position:absolute; top:0; left:-150%; width:100%; height:100%;
      background:linear-gradient(110deg,transparent 20%,rgba(255,255,255,0.03) 50%,transparent 80%);
      animation:shim 1.6s infinite;
    }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-hero">
    <div class="login-hero__wordmark">KOPALA <span>FPL</span></div>
    <p class="login-hero__sub">Zambia's sharpest FPL companion</p>
  </div>
  <div class="login-card">
    <h2>Enter your FPL ID</h2>
    <p>Paste your team ID or your full FPL team URL — we'll figure it out.</p>
    <div>
      <input type="text" id="team-id-input" class="fpl-input"
        placeholder="e.g. 1234567 or paste link"
        autocomplete="off" inputmode="numeric">
      <div id="error-message" class="error-msg"></div>
    </div>
    <button id="login-btn" class="continue-btn" onclick="handleLogin()">Continue</button>
    <div class="find-id-link" onclick="window.open('https://youtu.be/gZqblBRbAjw?si=IQ-hmIEES27jDaTn','_blank')">
      <i class="fa-solid fa-circle-question"></i> How to find my Team ID?
    </div>
  </div>
</div>

<div id="nav-placeholder"></div>

<main class="page-content" id="main-content">

  <div id="deadline-container"></div>

  <!-- Manager header -->
  <div class="manager-header">
    <div id="disp-name" class="manager-header__name">Manager Name</div>
    <div id="disp-team" class="manager-header__team">Team Name</div>
  </div>

  <!-- Stat chips -->
  <div class="stat-chips-row" id="stat-chips-row">
    <div class="stat-chip stat-chip--highlight">
      <div class="stat-chip__label">GW Points</div>
      <div class="stat-chip__value t-number" id="disp-total">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">GW Rank</div>
      <div class="stat-chip__value t-number" id="disp-gw-rank">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Overall</div>
      <div class="stat-chip__value t-number" id="disp-rank">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Total Pts</div>
      <div class="stat-chip__value t-number" id="disp-total-pts">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">GW Avg</div>
      <div class="stat-chip__value t-number" id="disp-gw-avg">—</div>
    </div>
    <div class="stat-chip">
      <div class="stat-chip__label">Highest</div>
      <div class="stat-chip__value t-number" id="disp-gw-high">—</div>
    </div>
  </div>

  <!-- Squad bar pills -->
  <div id="squad-bar-container" class="squad-bar"></div>

  <!-- My transfers -->
  <div id="my-transfers-container"></div>

  <!-- Pitch / List toggle -->
  <div class="view-toggle">
    <button class="vtb on" id="btn-pitch" onclick="setView('pitch')">
      <i class="fa-solid fa-table-cells-large"></i> Pitch View
    </button>
    <button class="vtb" id="btn-list" onclick="setView('list')">
      <i class="fa-solid fa-list"></i> List View
    </button>
  </div>

  <!-- PITCH VIEW -->
  <div id="view-pitch">
    <!-- Skeleton -->
    <div class="pitch-skel" id="pitch-skel"></div>
    <!-- Real pitch (hidden until data loads) -->
    <div id="pitch-real" style="display:none">
      <div class="pitch-wrap">
        <!-- Pitch markings -->
        <div class="pitch-markings">
          <svg viewBox="0 0 320 460" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="0" y1="230" x2="320" y2="230" stroke="white" stroke-width="2"/>
            <circle cx="160" cy="230" r="42" fill="none" stroke="white" stroke-width="2"/>
            <circle cx="160" cy="230" r="3" fill="white"/>
            <rect x="68" y="0"   width="184" height="76"  fill="none" stroke="white" stroke-width="2"/>
            <rect x="68" y="384" width="184" height="76"  fill="none" stroke="white" stroke-width="2"/>
            <rect x="108" y="0"  width="104" height="32"  fill="none" stroke="white" stroke-width="2"/>
            <rect x="108" y="428" width="104" height="32" fill="none" stroke="white" stroke-width="2"/>
            <circle cx="160" cy="57"  r="2.5" fill="white"/>
            <circle cx="160" cy="403" r="2.5" fill="white"/>
            <path d="M0 0 Q12 0 12 12"     fill="none" stroke="white" stroke-width="1.5"/>
            <path d="M320 0 Q308 0 308 12" fill="none" stroke="white" stroke-width="1.5"/>
            <path d="M0 460 Q12 460 12 448"   fill="none" stroke="white" stroke-width="1.5"/>
            <path d="M320 460 Q308 460 308 448" fill="none" stroke="white" stroke-width="1.5"/>
          </svg>
        </div>
        <!-- Rows -->
        <div class="pitch-field" id="pitch-field"></div>
        <!-- Bench divider -->
        <div class="bench-stripe">
          <div class="bench-stripe__line"></div>
          <div class="bench-stripe__txt">Bench</div>
          <div class="bench-stripe__line"></div>
        </div>
        <!-- Bench row -->
        <div class="pitch-bench" id="pitch-bench"></div>
        <div style="height:12px;position:relative;z-index:2"></div>
      </div>
    </div>
  </div>

  <!-- LIST VIEW -->
  <div id="view-list" style="display:none">
    <div class="list-skel" id="list-skel">
      <div class="list-skel-row"></div>
      <div class="list-skel-row"></div>
      <div class="list-skel-row"></div>
      <div class="list-skel-row"></div>
      <div class="list-skel-row"></div>
      <div class="list-skel-row"></div>
      <div class="list-skel-row"></div>
    </div>
    <div class="lv-wrap" id="list-real" style="display:none"></div>
  </div>

  <!-- Top GW transfers -->
  <div id="transfers-container"></div>

  <div id="footer-placeholder"></div>
</main>

<script>
const state = {
  fplId:    localStorage.getItem('kopala_id'),
  playerMap:{},
  teamMap:  {},
  ptsMap:   {},
  currentGW:1,
  gwAverage:0,
  gwHigh:   0,
  view:     localStorage.getItem('kopala_view') || 'pitch',
};
const PROXY = '/.netlify/functions/fpl-proxy?endpoint=';
const POS_LBL = ['','GKP','DEF','MID','FWD'];

/* ---- VIEW TOGGLE ---- */
function setView(v) {
  state.view = v;
  localStorage.setItem('kopala_view', v);
  document.getElementById('btn-pitch').classList.toggle('on', v==='pitch');
  document.getElementById('btn-list').classList.toggle('on',  v==='list');
  document.getElementById('view-pitch').style.display = v==='pitch' ? '' : 'none';
  document.getElementById('view-list').style.display  = v==='list'  ? '' : 'none';
}

/* ---- LOGIN ---- */
async function handleLogin() {
  const input = document.getElementById('team-id-input');
  const errEl = document.getElementById('error-message');
  const btn   = document.getElementById('login-btn');
  input.classList.remove('error'); errEl.style.display='none';
  let raw = input.value.trim();
  const m = raw.match(/entry\/(\d+)/); if(m) raw=m[1];
  const id = parseInt(raw,10);
  if(!id||isNaN(id)) return showErr('Please enter a valid numeric ID');
  try {
    btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Checking…';
    const r = await fetch(`${PROXY}entry/${id}/`);
    if(!r.ok) throw 0;
    localStorage.setItem('kopala_id',id); location.reload();
  } catch { showErr('Team ID not found. Please try again.'); btn.disabled=false; btn.textContent='Continue'; }
  function showErr(msg){input.classList.add('error');errEl.textContent=msg;errEl.style.display='block';}
}
document.getElementById('team-id-input')?.addEventListener('keydown',e=>{if(e.key==='Enter')handleLogin();});

/* ---- SKELETONS ---- */
function showSkeletons() {
  ['disp-name','disp-team'].forEach(id=>document.getElementById(id)?.classList.add('skeleton'));
  ['disp-total','disp-gw-rank','disp-rank','disp-total-pts','disp-gw-avg','disp-gw-high'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.textContent='—';el.closest('.stat-chip')?.classList.add('skeleton');}
  });
  const bar=document.getElementById('squad-bar-container');
  if(bar) bar.innerHTML=[80,70,90].map(w=>`<div class="squad-pill skeleton" style="width:${w}px;height:32px"></div>`).join('');
}

function revealData() {
  document.querySelectorAll('.skeleton').forEach(el=>el.classList.remove('skeleton'));
  document.getElementById('pitch-skel').style.display='none';
  document.getElementById('pitch-real').style.display='';
  document.getElementById('list-skel').style.display='none';
  document.getElementById('list-real').style.display='';
}

/* ---- BOOTSTRAP ---- */
async function initBoot() {
  const r    = await fetch(`${PROXY}bootstrap-static/`);
  const data = await r.json();
  data.teams.forEach(t=>{ state.teamMap[t.id]={code:t.code,name:t.short_name}; });
  data.elements.forEach(p=>{
    state.playerMap[p.id]={
      name:     p.web_name,
      teamCode: state.teamMap[p.team]?.code,
      teamName: state.teamMap[p.team]?.name,
      pos:      p.element_type,
      own:      parseFloat(p.selected_by_percent)||0,
    };
  });
  const ev = data.events.find(e=>e.is_current)||data.events.find(e=>e.is_next)||data.events[0];
  state.currentGW = ev.id;
  state.gwAverage = ev.average_entry_score||0;
  state.gwHigh    = ev.highest_score||0;
}

/* ---- MAIN RENDER ---- */
async function fetchAndRender() {
  const [eR,pR,lR,tR] = await Promise.all([
    fetch(`${PROXY}entry/${state.fplId}/`),
    fetch(`${PROXY}entry/${state.fplId}/event/${state.currentGW}/picks/`),
    fetch(`${PROXY}event/${state.currentGW}/live/`),
    fetch(`${PROXY}entry/${state.fplId}/transfers/`),
  ]);
  const [entry,picks,live,trans] = await Promise.all([eR.json(),pR.json(),lR.json(),tR.json()]);

  live.elements.forEach(e
