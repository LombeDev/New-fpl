<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOPALA FPL - Mini Leagues</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1a1a1b;
            --text-muted: #5f6368;
            --fpl-green: #00ff85;
            --fpl-pink: #e90052;
            --border-color: #dbdee1;
            --live-fpl-blue: #3876f2;
            --pitch-bg: #008040; /* Official Green */
        }

        body.dark-mode {
            --bg-color: #0b141b;
            --card-bg: #1c2730;
            --text-main: #f5f6f7;
            --text-muted: #94a3b8;
            --border-color: #2d3b48;
            --pitch-bg: #121a21;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, system-ui, sans-serif;
            padding-bottom: 100px;
        }

        /* BRAND BAR */
        .top-brand-bar { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .live-logo { background: #000; color: #fff; padding: 6px 18px; border-radius: 50px; font-weight: 900; font-size: 1.1rem; display: flex; align-items: center; gap: 4px; }
        .live-logo span { color: var(--fpl-green); }

        /* CONTROLS */
        .league-controls { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        #league-select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); font-weight: 600; outline: none; }

        /* MANAGER CARDS */
        .manager-card { background: var(--card-bg); margin: 8px 12px; border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; }
        .card-main-row { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        
        .rank-box { width: 35px; text-align: center; font-weight: 900; }
        .rank-arrow { font-size: 0.7rem; display: block; }
        .up { color: var(--fpl-green); }
        .down { color: var(--fpl-pink); }

        .mgr-info { flex-grow: 1; }
        .team-name { font-weight: 800; font-size: 0.9rem; display: block; margin-bottom: 2px; }
        .mgr-name { font-size: 0.75rem; color: var(--text-muted); }

        .pts-box { text-align: right; min-width: 60px; }
        .gw-pts { font-weight: 800; font-size: 0.95rem; color: var(--text-main); }
        .total-pts { font-weight: 900; font-size: 1rem; color: var(--live-fpl-blue); display: block; }

        /* EXPANDED PITCH SECTION */
        .detail-pane { display: none; background: #fff; padding-bottom: 15px; }
        .detail-pane.active { display: block; }

        .pitch-container { 
            background: var(--pitch-bg); 
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 100% 30px;
            margin: 10px; border-radius: 12px; padding: 20px 5px; 
            display: flex; flex-direction: column; gap: 15px;
        }
        .pitch-row { display: flex; justify-content: center; gap: 5px; }

        /* PLAYER CARDS */
        .pitch-player { width: 65px; text-align: center; position: relative; }
        .jersey-wrapper { position: relative; display: inline-block; }
        .p-jersey { width: 38px; height: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        
        .p-labels { background: #fff; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); margin-top: -5px; position: relative; z-index: 2; overflow: hidden; }
        .p-name { background: #1e293b; color: #fff; font-size: 0.55rem; padding: 2px 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-pts { font-size: 0.8rem; font-weight: 800; color: #000; padding: 2px 0; }
        .p-pts.high { background: var(--fpl-green); }

        /* AUTO-SUB STYLES */
        .subbed-off { opacity: 0.45; filter: grayscale(0.8); }
        .sub-icon { position: absolute; top: -5px; right: -8px; width: 16px; height: 16px; border-radius: 50%; font-size: 0.6rem; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .sub-in { color: var(--fpl-green); }
        .sub-off { color: var(--fpl-pink); }

        .bench-divider { border-top: 1px dashed rgba(255,255,255,0.3); margin: 10px 15px; position: relative; }
        .bench-divider::after { content: 'BENCH'; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: var(--pitch-bg); padding: 0 10px; font-size: 0.6rem; color: rgba(255,255,255,0.6); font-weight: 800; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--card-bg); border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(4, 1fr); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text-muted); font-size: 0.65rem; font-weight: 600; text-decoration: none; }
        .nav-item.active { color: var(--live-fpl-blue); }
        .nav-item i { font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="top-brand-bar">
        <div class="live-logo">KOPALA<span>â–²</span>FPL</div>
        <i class="fa-solid fa-moon" onclick="toggleTheme()"></i>
    </div>

    <div class="league-controls">
        <select id="league-select" onchange="loadStandings(this.value)"></select>
    </div>

    <div id="standings-list"></div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="leagues.html" class="nav-item active"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item"><i class="fa-solid fa-tags"></i><span>Prices</span></a>
        <a href="games.html" class="nav-item"><i class="fa-solid fa-soccer-ball"></i><span>Games</span></a>
    </nav>

    <script>
        const state = {
            fplId: localStorage.getItem('kopala_id') || '532432',
            currentGW: 1,
            playerMap: {},
            PROXY: "/.netlify/functions/fpl-proxy?endpoint="
        };

        async function init() {
            try {
                const res = await fetch(`${state.PROXY}bootstrap-static/`);
                const data = await res.json();
                
                // Map elements for jerseys and positions
                data.elements.forEach(p => {
                    state.playerMap[p.id] = { 
                        name: p.web_name, 
                        team_code: p.team_code, 
                        pos: p.element_type,
                        own: p.selected_by_percent
                    };
                });

                state.currentGW = data.events.find(e => e.is_current).id;
                fetchUserLeagues();
            } catch (err) { console.error("Init Error:", err); }
        }

        async function fetchUserLeagues() {
            const res = await fetch(`${state.PROXY}entry/${state.fplId}/`);
            const data = await res.json();
            const select = document.getElementById('league-select');
            
            select.innerHTML = data.leagues.classic
                .filter(l => l.league_type === 'x') // Private leagues
                .map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            
            if (select.options.length > 0) loadStandings(select.value);
        }

        async function loadStandings(leagueId) {
            const container = document.getElementById('standings-list');
            container.innerHTML = '<p style="text-align:center; padding:20px;">Loading League Standings...</p>';

            const res = await fetch(`${state.PROXY}leagues-classic/${leagueId}/standings/`);
            const data = await res.json();

            container.innerHTML = data.standings.results.map(r => `
                <div class="manager-card">
                    <div class="card-main-row" onclick="toggleDetails(${r.entry}, this)">
                        <div class="rank-box">
                            <span>${r.rank}</span>
                            <i class="fa-solid fa-caret-${r.last_rank > r.rank ? 'up up' : 'down down'} rank-arrow"></i>
                        </div>
                        <div class="mgr-info">
                            <span class="team-name">${r.entry_name}</span>
                            <span class="mgr-name">${r.player_name}</span>
                        </div>
                        <div class="pts-box">
                            <span class="gw-pts">${r.event_total} pts</span>
                            <span class="total-pts">${r.total}</span>
                        </div>
                    </div>
                    <div class="detail-pane" id="pane-${r.entry}"></div>
                </div>
            `).join('');
        }

        async function toggleDetails(entryId, row) {
            const pane = document.getElementById(`pane-${entryId}`);
            const isActive = pane.classList.contains('active');
            
            // Close all others
            document.querySelectorAll('.detail-pane').forEach(p => p.classList.remove('active'));
            
            if (!isActive) {
                pane.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fa-solid fa-spinner fa-spin"></i> Loading Pitch...</div>';
                pane.classList.add('active');
                
                const [picksRes, liveRes] = await Promise.all([
                    fetch(`${state.PROXY}entry/${entryId}/event/${state.currentGW}/picks/`),
                    fetch(`${state.PROXY}event/${state.currentGW}/live/`)
                ]);
                const pData = await picksRes.json();
                const lData = await liveRes.json();

                renderManagerPitch(pane, pData, lData);
            }
        }

        function renderManagerPitch(pane, pData, lData) {
            const picks = pData.picks;
            const subs = pData.automatic_subs || [];

            const getPlayerData = (id) => lData.elements.find(el => el.id === id);

            const renderPlayer = (pick) => {
                const meta = state.playerMap[pick.element];
                const live = getPlayerData(pick.element);
                const points = live.stats.total_points * pick.multiplier;
                
                // Auto-Sub Logic
                const isSubOut = subs.some(s => s.element_out === pick.element) || (live.stats.minutes === 0 && pick.position <= 11);
                const isSubIn = subs.some(s => s.element_in === pick.element);
                
                let subIcon = '';
                if (isSubOut && pick.position <= 11) subIcon = '<div class="sub-icon sub-off"><i class="fa-solid fa-arrow-down"></i></div>';
                if (isSubIn) subIcon = '<div class="sub-icon sub-in"><i class="fa-solid fa-arrow-up"></i></div>';

                return `
                    <div class="pitch-player ${isSubOut && pick.position <= 11 ? 'subbed-off' : ''}">
                        <div class="jersey-wrapper">
                            <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/s_${meta.team_code}-66.png" class="p-jersey">
                            ${pick.is_captain ? '<div class="c-badge" style="position:absolute; bottom:-2px; right:-5px; background:#000; color:#fff; font-size:0.6rem; width:15px; height:15px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:1px solid #fff;">C</div>' : ''}
                            ${subIcon}
                        </div>
                        <div class="p-labels">
                            <div class="p-name">${meta.name}</div>
                            <div class="p-pts ${points >= 5 ? 'high' : ''}">${points}</div>
                        </div>
                    </div>
                `;
            };

            const gkp = picks.filter(p => p.position === 1).map(renderPlayer).join('');
            const def = picks.filter(p => p.position > 1 && p.position <= 11 && state.playerMap[p.element].pos === 2).map(renderPlayer).join('');
            const mid = picks.filter(p => p.position > 1 && p.position <= 11 && state.playerMap[p.element].pos === 3).map(renderPlayer).join('');
            const fwd = picks.filter(p => p.position > 1 && p.position <= 11 && state.playerMap[p.element].pos === 4).map(renderPlayer).join('');
            const bench = picks.filter(p => p.position > 11).map(renderPlayer).join('');

            pane.innerHTML = `
                <div class="pitch-container">
                    <div class="pitch-row">${gkp}</div>
                    <div class="pitch-row">${def}</div>
                    <div class="pitch-row">${mid}</div>
                    <div class="pitch-row">${fwd}</div>
                    <div class="bench-divider"></div>
                    <div class="pitch-row" style="background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;">${bench}</div>
                </div>
            `;
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }

        init();
    </script>
</body>
</html>