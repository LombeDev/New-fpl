<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>View Current GW points</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#37003c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* --- DYNAMIC THEME VARIABLES --- */
        :root {
            --shimmer-base: #f0edf4;
            --shimmer-shine: rgba(56, 0, 60, 0.08);
            --md-sys-color-primary-container: #eaddff;
            --md-sys-color-surface-container: #f3edf7;
            --accent-color: #38003c;
        }

        body.dark-mode {
            --shimmer-base: #2b2633;
            --shimmer-shine: rgba(208, 188, 255, 0.1);
            --md-sys-color-primary-container: #4f378b;
            --md-sys-color-surface-container: #1d1b20;
            --accent-color: #d0bcff;
        }

        .page-content { padding-top: 10px; }

        /* Header & Stats styling as per previous turn */
        .header-content { padding: 24px 16px 16px; margin-bottom: 16px; }
        #disp-name { display: block; font-size: 2rem !important; font-weight: 900; color: var(--accent-color); min-height: 2.2rem; }
        .header-stats-grid { display: flex; flex-direction: column; padding: 0 16px; gap: 2px; }
        .stat-box { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .stat-value { font-size: 1.1rem; font-weight: 900; min-width: 50px; text-align: right; }

        /* Player Grid */
        .player-list-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px 2px; padding: 4px; }
        .compact-player-card { width: 44px; display: flex; flex-direction: column; align-items: center; min-height: 65px; border-radius: 8px; }
        
        /* Transfers Section */
        .transfers-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 15px; padding: 0 16px; }

        /* --- LOADING SHIMMER ANIMATION --- */
        .skeleton {
            background-color: var(--shimmer-base) !important;
            color: transparent !important;
            position: relative;
            overflow: hidden;
        }

        .skeleton::after {
            content: "";
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, var(--shimmer-shine) 40%, var(--shimmer-shine) 60%, rgba(255, 255, 255, 0) 100%);
            animation: shimmer 1.8s infinite cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* Specific Shimmer Shapes */
        .skeleton-card { width: 44px; height: 65px; border-radius: 12px; }
        .skeleton-pill { height: 22px; width: 70px; border-radius: 100px; }
        
        .skeleton-transfer-card {
            flex: 1; min-width: 280px; height: 160px; 
            border-radius: 20px; padding: 14px;
            background: var(--shimmer-base);
        }

        .skeleton-transfer-row {
            height: 30px; width: 100%; border-radius: 10px; margin-top: 8px;
        }
    </style>
</head>
<body class="dark-mode">

    <div id="nav-placeholder"></div>
    
    <main class="page-content">
        <div id="deadline-container"></div>
        
        <div class="header-content">
            <span id="disp-name">Manager Name</span>
            <div id="disp-team" style="opacity:0.6;">Team Name</div>
        </div>
        
        <div class="header-stats-grid" id="stats-grid">
            <div class="stat-box"><div class="stat-label">GW Rank</div><div class="stat-value" id="disp-gw-rank">0</div></div>
            <div class="stat-box"><div class="stat-label">Overall Rank</div><div class="stat-value" id="disp-rank">0</div></div>
            <div class="stat-box"><div class="stat-label">Net Points</div><div class="stat-value" id="disp-total" style="color:var(--accent-color)">0</div></div>
        </div>

        <div class="player-grid-container">
            <div id="squad-info-container" style="padding: 10px 16px;"></div>
            <div id="player-list-grid" class="player-list-grid"></div>
            
            <div style="padding: 20px 16px 5px;"><h3 style="font-size:0.9rem; font-weight:900;">TRANSFER HISTORY</h3></div>
            <div id="transfers-container" class="transfers-grid"></div>
        </div>
    </main>

    <script>
    const state = {
        fplId: localStorage.getItem('kopala_id'),
        playerMap: {},
        currentGW: 1
    };

    const PROXY = "/.netlify/functions/fpl-proxy?endpoint=";

    function showLoadingState() {
        // Text Shimmers
        ['disp-name', 'disp-gw-rank', 'disp-rank', 'disp-total'].forEach(id => {
            document.getElementById(id).classList.add('skeleton');
        });

        // Squad Grid Shimmers
        document.getElementById('player-list-grid').innerHTML = 
            Array(15).fill('<div class="skeleton skeleton-card"></div>').join('');

        // Transfer History Shimmers
        document.getElementById('transfers-container').innerHTML = 
            Array(2).fill(`
                <div class="skeleton-transfer-card">
                    <div class="skeleton" style="height:15px; width:40%; border-radius:4px;"></div>
                    <div class="skeleton skeleton-transfer-row"></div>
                    <div class="skeleton skeleton-transfer-row"></div>
                    <div class="skeleton skeleton-transfer-row"></div>
                </div>
            `).join('');
    }

    function hideLoadingState() {
        ['disp-name', 'disp-gw-rank', 'disp-rank', 'disp-total'].forEach(id => {
            document.getElementById(id).classList.remove('skeleton');
        });
    }

    async function initData() {
        try {
            const res = await fetch(`${PROXY}bootstrap-static/`);
            const data = await res.json();
            data.elements.forEach(p => {
                state.playerMap[p.id] = { name: p.web_name, team: p.team };
            });
            state.currentGW = data.events.find(e => e.is_current)?.id || 1;
        } catch (e) { console.error(e); }
    }

    async function fetchAndRender() {
        if (!state.fplId) return;
        try {
            const [entryRes, picksRes, transRes] = await Promise.all([
                fetch(`${PROXY}entry/${state.fplId}/`),
                fetch(`${PROXY}entry/${state.fplId}/event/${state.currentGW}/picks/`),
                fetch(`${PROXY}entry/${state.fplId}/transfers/`)
            ]);
            
            const entry = await entryRes.json();
            const picks = await picksRes.json();
            const transfers = await transRes.json();

            hideLoadingState();

            // Populate Text
            document.getElementById('disp-name').textContent = `${entry.player_first_name} ${entry.player_last_name}`;
            document.getElementById('disp-rank').textContent = entry.summary_overall_rank.toLocaleString();
            document.getElementById('disp-gw-rank').textContent = picks.entry_history.rank?.toLocaleString() || '-';
            document.getElementById('disp-total').textContent = picks.entry_history.points;

            // Render Transfer Cards (grouped by GW)
            renderTransfers(transfers);
            
        } catch (e) { console.error(e); }
    }

    function renderTransfers(allTransfers) {
        const container = document.getElementById('transfers-container');
        if (!allTransfers.length) {
            container.innerHTML = "<p style='opacity:0.5; font-size:0.8rem;'>No transfers made yet.</p>";
            return;
        }

        // Grouping logic (simplified)
        const latestGW = allTransfers[0].event;
        const gwTransfers = allTransfers.filter(t => t.event === latestGW);

        container.innerHTML = `
            <div class="transfer-card-wrapper" style="background:var(--md-sys-color-surface-container); padding:14px; border-radius:20px; width:100%;">
                <h4 style="font-size:0.7rem; opacity:0.6; margin-bottom:10px;">GW${latestGW} TRANSFERS</h4>
                ${gwTransfers.map(t => `
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:8px;">
                        <span style="color:#ff4d4d;">OUT: ${state.playerMap[t.element_out]?.name}</span>
                        <span style="color:#00ff85;">IN: ${state.playerMap[t.element_in]?.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // STARTUP
    if (state.fplId) {
        showLoadingState();
        initData().then(fetchAndRender);
    }
    
</script>
    <script src="nav.js"></script>
    <script src="deadline.js"></script>
    <script src="transfers.js"></script>
    <div id="footer-placeholder"></div>
<script src="footer.js"></script>
</body>
</html>
