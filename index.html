<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOPALA FPL - Pro Analytics</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #2563eb;
            --fpl-green: #00ff85;
            --border-color: #e2e8f0;
            --pitch-green: #2e7d32;
            --danger: #ef4444;
            --success: #10b981;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }

        .promo-card, .login-card { width: 100%; max-width: 400px; background: var(--card-bg); border: 1px solid var(--border-color); }
        .promo-card { border-radius: 24px; padding: 20px; margin-bottom: 16px; text-align: center; }
        .promo-card h3 { margin: 0; font-size: 1.1rem; font-weight: 800; }
        
        .login-card { border-radius: 28px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .login-card h2 { margin: 0 0 8px 0; font-size: 1.5rem; font-weight: 800; }

        .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .toggle-container { display: flex; background: var(--bg-color); padding: 4px; border-radius: 40px; }
        .toggle-btn { border: none; padding: 8px 18px; border-radius: 30px; font-weight: 800; cursor: pointer; font-size: 0.8rem; }
        .toggle-btn.active { background: var(--primary-blue); color: white; }
        .toggle-btn.inactive { background: transparent; color: var(--text-muted); }

        .fpl-input { 
            width: 100%; padding: 18px; border-radius: 16px; border: 1px solid var(--border-color); 
            font-size: 1rem; margin-bottom: 15px; background: var(--bg-color); color: var(--text-main);
        }
        .continue-btn { 
            width: 100%; padding: 18px; background: var(--primary-blue); color: white; 
            border: none; border-radius: 16px; font-weight: 800; font-size: 1rem; cursor: pointer; 
        }

        /* --- NAV & CONTENT --- */
        .top-nav {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: var(--card-bg); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 3000;
        }
        .logo-container { font-weight: 900; font-size: 1.3rem; letter-spacing: -1px; }
        .logo-container span { color: var(--fpl-green); }

        .page-content { padding: 75px 12px 100px; max-width: 500px; margin: 0 auto; }

        /* --- RANK DASHBOARD TILES --- */
        .rank-card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border-color); overflow: hidden; margin-bottom: 20px; }
        .rank-header { padding: 15px; background: linear-gradient(135deg, rgba(37,99,235,0.1), transparent); }
        .rank-grid { display: grid; grid-template-columns: repeat(3, 1fr); background: var(--border-color); gap: 1px; }
        .stat-tile { background: var(--card-bg); padding: 15px 5px; text-align: center; }
        .stat-tile span { display: block; font-size: 0.6rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .stat-tile strong { font-size: 0.95rem; font-weight: 900; }

        /* --- PITCH --- */
        .pitch-container { 
            background-color: var(--pitch-green);
            background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px;
            padding: 20px 0; border-radius: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .pitch-row { display: flex; justify-content: center; gap: 8px; }
        .player-card { width: 65px; text-align: center; }
        .p-info { background: #fff; border-radius: 4px; margin-top: -5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); overflow: hidden; }
        .p-name { background: #000; color: #fff; font-size: 0.55rem; padding: 2px; font-weight: 700; }
        .p-pts { color: #000; font-size: 0.8rem; font-weight: 800; padding: 2px; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: var(--card-bg); border-top: 1px solid var(--border-color);
            display: grid; grid-template-columns: repeat(5, 1fr); z-index: 3000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); text-decoration: none; font-size: 0.6rem; font-weight: 700; gap: 4px;
        }
        .nav-item.active { color: var(--primary-blue); }
        .nav-item i { font-size: 1.2rem; }

        .hidden { display: none !important; }
    </style>
</head>
<body class="dark-mode">

    <div id="login-screen">
        <div class="promo-card">
            <h3>Used by FPL managers since 2025 ❤️</h3>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">Kopala Pro Analytics v2.0</div>
        </div>

        <div class="login-card">
            <div class="theme-row">
                <span style="font-weight: 700; color: var(--text-muted);">Theme</span>
                <div class="toggle-container">
                    <button id="btn-dark" class="toggle-btn active" onclick="setTheme('dark')">Dark</button>
                    <button id="btn-light" class="toggle-btn inactive" onclick="setTheme('light')">Light</button>
                </div>
            </div>

            <h2>Enter your FPL ID</h2>
            <p style="font-size: 0.9rem; color: var(--text-muted);">Sync your team to see pro analytics.</p>
            
            <input type="number" id="team-id-input" class="fpl-input" placeholder="e.g. 1234567">
            <button class="continue-btn" onclick="handleLogin()">Continue</button>

            <div style="margin-top: 20px; text-align: center; font-size: 0.85rem; color: var(--text-muted); font-weight: 600; cursor: pointer;" onclick="window.open('https://fantasy.premierleague.com/entry/1/history', '_blank')">
                <i class="fa-solid fa-question-circle"></i> Where is my ID?
            </div>
        </div>
    </div>

    <header class="top-nav">
        <div style="font-size: 1.2rem;"><i class="fa-solid fa-circle-user"></i></div>
        <div class="logo-container">Kopala<span>▲</span>FPL</div>
        <div onclick="toggleTheme()"><i class="fa-solid fa-moon" id="theme-icon"></i></div>
    </header>

    <main class="page-content">
        <section class="rank-card">
            <div class="rank-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="disp-name" style="margin:0; font-size: 1.1rem; font-weight: 900;">Manager Name</h2>
                    <span id="disp-gw" style="font-size: 0.75rem; font-weight: 800; color: var(--primary-blue);">GW --</span>
                </div>
            </div>
            <div class="rank-grid">
                <div class="stat-tile"><span>GW Live</span><strong id="tile-gw-pts">0</strong></div>
                <div class="stat-tile"><span>Total</span><strong id="tile-total-pts">0</strong></div>
                <div class="stat-tile"><span>Benched</span><strong id="tile-bench-pts">0</strong></div>
                <div class="stat-tile"><span>GW Rank</span><strong id="tile-gw-rank">0</strong></div>
                <div class="stat-tile"><span>Overall</span><strong id="tile-overall-rank">0</strong></div>
                <div class="stat-tile"><span>Change %</span><strong id="tile-change">0%</strong></div>
            </div>
        </section>

        <div class="pitch-container">
            <div id="gk-row" class="pitch-row"></div>
            <div id="def-row" class="pitch-row"></div>
            <div id="mid-row" class="pitch-row"></div>
            <div id="fwd-row" class="pitch-row"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-futbol"></i><span>Games</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-tags"></i><span>Prices</span></a>
        <a href="#" class="nav-item" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i><span>Exit</span></a>
    </nav>

    <script>
        const PROXY = "https://corsproxy.io/?";
        const state = {
            fplId: localStorage.getItem('kopala_user_id'),
            boot: null,
            live: {},
            gw: null
        };

        // Theme Logic
        function setTheme(mode) {
            const isDark = mode === 'dark';
            document.body.classList.toggle('dark-mode', isDark);
            document.getElementById('btn-dark').className = `toggle-btn ${isDark ? 'active' : 'inactive'}`;
            document.getElementById('btn-light').className = `toggle-btn ${!isDark ? 'active' : 'inactive'}`;
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        }

        function toggleTheme() {
            const current = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            setTheme(current);
        }

        function logout() {
            localStorage.removeItem('kopala_user_id');
            location.reload();
        }

        async function handleLogin() {
            const id = document.getElementById('team-id-input').value;
            if(!id) return alert("Please enter an ID");
            localStorage.setItem('kopala_user_id', id);
            state.fplId = id;
            document.getElementById('login-screen').classList.add('hidden');
            init();
        }

        async function init() {
            try {
                // 1. Load Bootstrap
                const bootRes = await fetch(PROXY + encodeURIComponent("https://fantasy.premierleague.com/api/bootstrap-static/"));
                state.boot = await bootRes.json();
                state.gw = state.boot.events.find(e => e.is_current).id;

                // 2. Load Entry & History
                const [entryRes, histRes, picksRes, liveRes] = await Promise.all([
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${state.fplId}/`)),
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${state.fplId}/history/`)),
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${state.fplId}/event/${state.gw}/picks/`)),
                    fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/event/${state.gw}/live/`))
                ]);

                const entry = await entryRes.json();
                const history = await histRes.json();
                const picks = await picksRes.json();
                const liveData = await liveRes.json();

                // Map Live Points
                liveData.elements.forEach(el => state.live[el.id] = el.stats.total_points);

                renderDashboard(entry, history, picks);
            } catch (err) {
                alert("Error loading data. Check your ID.");
                logout();
            }
        }

        function renderDashboard(entry, history, picks) {
            const currentHist = history.current.find(h => h.event === state.gw);
            const prevHist = history.current.find(h => h.event === state.gw - 1);

            // Text Elements
            document.getElementById('disp-name').innerText = `${entry.player_first_name} ${entry.player_last_name}`;
            document.getElementById('disp-gw').innerText = `GW ${state.gw}`;
            document.getElementById('tile-total-pts').innerText = entry.summary_overall_points;
            document.getElementById('tile-overall-rank').innerText = entry.summary_overall_rank.toLocaleString();
            document.getElementById('tile-gw-rank').innerText = (currentHist?.rank || 0).toLocaleString();

            // Calculate Change %
            if(prevHist) {
                const diff = prevHist.overall_rank - entry.summary_overall_rank;
                const pct = ((diff / prevHist.overall_rank) * 100).toFixed(2);
                const el = document.getElementById('tile-change');
                el.innerText = (diff >= 0 ? "+" : "") + pct + "%";
                el.style.color = diff >= 0 ? "var(--success)" : "var(--danger)";
            }

            // Pitch & Points
            ['gk-row', 'def-row', 'mid-row', 'fwd-row'].forEach(id => document.getElementById(id).innerHTML = '');
            let liveTotal = 0;
            let benchTotal = 0;

            picks.picks.forEach((pick, index) => {
                const pData = state.boot.elements.find(e => e.id === pick.element);
                const pts = (state.live[pick.element] || 0) * pick.multiplier;
                
                const html = `
                    <div class="player-card">
                        <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${pData.team_code}${pData.element_type === 1 ? '_1' : ''}-66.png" style="width:38px;">
                        <div class="p-info">
                            <div class="p-name">${pData.web_name}</div>
                            <div class="p-pts">${pts}</div>
                        </div>
                    </div>`;

                if (index < 11) {
                    liveTotal += pts;
                    const rowId = pData.element_type === 1 ? 'gk-row' : pData.element_type === 2 ? 'def-row' : pData.element_type === 3 ? 'mid-row' : 'fwd-row';
                    document.getElementById(rowId).innerHTML += html;
                } else {
                    benchTotal += pts;
                }
            });

            document.getElementById('tile-gw-pts').innerText = liveTotal;
            document.getElementById('tile-bench-pts').innerText = benchTotal;
        }

        // Start Logic
        if(state.fplId) {
            document.getElementById('login-screen').classList.add('hidden');
            init();
        }
    </script>
</body>
</html>
