<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VS Top 10k - Kopala FPL</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
    :root {
        --md-sys-color-primary: #6750a4;
        --md-sys-color-on-primary: #ffffff;
        --md-sys-color-primary-container: #eaddff;
        --md-sys-color-secondary-container: #e8def8;
        --md-sys-color-surface: #fdf7ff;
        --md-sys-color-surface-variant: #e7e0eb;
        --md-sys-color-outline: #79747e;
        --live-green: #00ff87;
        --live-red: #ff285e;
        --live-up: #10b981;
    }

    body { font-family: 'Inter', sans-serif; background: var(--md-sys-color-surface); margin: 0; padding-bottom: 100px; color: #1c1b1f; }
    .pro-header { background: var(--md-sys-color-surface); padding: 60px 24px 80px; text-align: left; }
    .pro-header h2 { font-size: 2rem; font-weight: 800; margin:0; }
    .pro-header p { background: var(--md-sys-color-primary-container); display: inline-block; padding: 6px 16px; border-radius: 20px; color: var(--md-sys-color-primary); font-weight: 700; margin-top: 10px; }

    .stats-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: -60px 16px 24px; }
    .stat-card { background: white; padding: 24px 16px; border-radius: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid var(--md-sys-color-surface-variant); text-align: center; }
    .stat-val { font-size: 1.8rem; font-weight: 900; color: var(--md-sys-color-primary); }
    .stat-lbl { font-size: 0.7rem; font-weight: 700; color: var(--md-sys-color-outline); text-transform: uppercase; }

    .outlook-card { background: var(--md-sys-color-secondary-container); margin: 0 16px 24px; padding: 24px; border-radius: 28px; color: #1d192b; }
    .outlook-grid { display: flex; justify-content: space-around; margin-top: 15px; }
    .outlook-num { font-size: 1.5rem; font-weight: 900; color: var(--md-sys-color-primary); }

    .rec-card { background: white; margin: 0 16px 24px; padding: 20px; border-radius: 24px; border: 1px solid var(--md-sys-color-surface-variant); }
    .rec-out b { color: var(--live-red); font-size: 1.2rem; }
    .rec-in b { color: var(--live-up); font-size: 1.2rem; }
    .rec-reason { margin-top: 10px; font-size: 0.75rem; opacity: 0.7; font-style: italic; text-align: center; }

    .captain-card { background: #1c1b1f; margin: 0 16px 24px; border-radius: 28px; overflow: hidden; color: white; }
    .cap-highlight { padding: 24px; display: flex; align-items: center; justify-content: space-between; }
    .cap-score { font-size: 2rem; font-weight: 900; color: var(--live-green); }

    .section-title { font-size: 0.9rem; font-weight: 700; margin: 32px 24px 12px; color: var(--md-sys-color-primary); }
    .player-row { background: white; margin: 0 16px 4px; padding: 16px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f0f0f0; }
    .eo-bar { width: 80px; height: 8px; background: #eee; border-radius: 4px; margin-top: 6px; overflow: hidden; }
    .eo-fill { height: 100%; background: var(--md-sys-color-primary); }
    .badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 20px; font-weight: 800; margin-left: 5px; }
    .bg-shield { background: #d1e9ff; color: #004881; }
    .bg-sword { background: #ffe08d; color: #725c00; }

    .chart-container { background: white; margin: 0 16px; padding: 24px; border-radius: 28px; border: 1px solid var(--md-sys-color-surface-variant); height: 200px; }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>

    <div class="pro-header">
        <h2>Your Team vs Top 10k</h2>
        <p>Manager ID: <span id="display-id">...</span></p>
    </div>

    <div class="stats-dashboard">
        <div class="stat-card">
            <span class="stat-lbl">GW Points</span>
            <span class="stat-val" id="safety-val">--</span>
        </div>
        <div class="stat-card">
            <span class="stat-lbl">Top 10k Avg</span>
            <span class="stat-val" id="live-avg">--</span>
        </div>
    </div>

    <div class="outlook-card">
        <div style="font-size: 0.7rem; font-weight: 800; opacity: 0.9; text-transform: uppercase;">Predicted Points (Next 3)</div>
        <div class="outlook-grid">
            <div class="outlook-item"><span class="outlook-gw" id="gw-label-1">GW--</span><span class="outlook-num" id="f-gw24">--</span></div>
            <div class="outlook-item"><span class="outlook-num" style="opacity:0.2;">+</span></div>
            <div class="outlook-item"><span class="outlook-gw" id="gw-label-2">GW--</span><span class="outlook-num" id="f-gw25">--</span></div>
            <div class="outlook-item"><span class="outlook-num" style="opacity:0.2;">+</span></div>
            <div class="outlook-item"><span class="outlook-gw" id="gw-label-3">GW--</span><span class="outlook-num" id="f-gw26">--</span></div>
        </div>
    </div>

    <div class="section-title"><i class="fa-solid fa-wand-magic-sparkles"></i> Transfer Suggestion</div>
    <div class="rec-card">
        <div style="display:flex; justify-content: space-around; align-items: center;">
            <div class="rec-out"><small style="display:block; font-size:0.6rem; color:#999;">SELL</small><b id="rec-sell">--</b></div>
            <i class="fa-solid fa-arrow-right" style="color:#ddd;"></i>
            <div class="rec-in"><small style="display:block; font-size:0.6rem; color:#999;">BUY</small><b id="rec-buy">--</b></div>
        </div>
        <div id="rec-reason" class="rec-reason">Calculating best move...</div>
    </div>

    <div class="section-title"><i class="fa-solid fa-crown"></i> Captaincy Metric</div>
    <div class="captain-card">
        <div class="cap-highlight">
            <div>
                <b id="cap-name" style="font-size:1.2rem;">--</b>
                <div style="font-size:0.65rem; opacity:0.7; margin-top:4px;" id="cap-reason">--</div>
            </div>
            <div class="cap-score" id="cap-metric">--</div>
        </div>
    </div>

    <div class="section-title"><i class="fa-solid fa-chart-line"></i> Rank Trend</div>
    <div class="chart-container">
        <canvas id="rankChart"></canvas>
    </div>

    <div class="section-title"><i class="fa-solid fa-shield-halved"></i> Rank Protection</div>
    <div id="squad-list"></div>

    <script>
        const PROXY = "/.netlify/functions/fpl-proxy?endpoint=";
        const state = {
            id: localStorage.getItem('kopala_id'),
            playerMap: {},
            currentGW: 24,
            bank: 0,
            eliteData: {
                "Haaland": { eo: 173.9, xPts: [7.2, 6.8, 6.5] },
                "Palmer": { eo: 92.1, xPts: [7.5, 7.0, 6.8] },
                "Saka": { eo: 88.4, xPts: [6.5, 6.2, 6.0] },
                "Gabriel": { eo: 80.2, xPts: [5.2, 5.0, 5.2] },
                "Salah": { eo: 45.5, xPts: [8.0, 7.5, 7.8] }
            }
        };

        async function init() {
            if (!state.id) { alert("Enter FPL ID on home page!"); return; }
            document.getElementById('display-id').innerText = state.id;

            try {
                const boot = await fetch(`${PROXY}bootstrap-static/`).then(r => r.json());
                boot.elements.forEach(p => {
                    state.playerMap[p.id] = { name: p.web_name, pos: p.element_type, ict: parseFloat(p.ict_index), price: p.now_cost, team: p.team };
                });

                const currentEvent = boot.events.find(e => e.is_current) || boot.events[0];
                state.currentGW = currentEvent.id;
                document.getElementById('live-avg').innerText = currentEvent.average_entry_score;

                const [picksData, historyData, fixtures] = await Promise.all([
                    fetch(`${PROXY}entry/${state.id}/event/${state.currentGW}/picks/`).then(r => r.json()),
                    fetch(`${PROXY}entry/${state.id}/history/`).then(r => r.json()),
                    fetch(`${PROXY}fixtures/?event=${state.currentGW + 1}`).then(r => r.json())
                ]);

                state.bank = picksData.entry_history.bank;
                processData(picksData.picks, historyData, boot.elements, fixtures);
            } catch (e) { console.error("Error:", e); }
        }

        function processData(picks, history, allPlayers, fixtures) {
            const mySquad = picks.map(p => ({
                ...state.playerMap[p.element],
                id: p.element
            }));

            // GW Points
            const latest = history.current[history.current.length - 1];
            document.getElementById('safety-val').innerText = latest ? latest.points : 0;

            // Forecast Labels
            document.getElementById('gw-label-1').innerText = `GW${state.currentGW}`;
            document.getElementById('gw-label-2').innerText = `GW${state.currentGW+1}`;
            document.getElementById('gw-label-3').innerText = `GW${state.currentGW+2}`;

            // Squad List
            document.getElementById('squad-list').innerHTML = mySquad.map(p => {
                const data = state.eliteData[p.name] || { eo: 15.2 };
                const isShield = data.eo > 50;
                return `<div class="player-row">
                    <div><b>${p.name}</b> <span class="badge ${isShield?'bg-shield':'bg-sword'}">${isShield?'SHIELD':'SWORD'}</span>
                    <div class="eo-bar"><div class="eo-fill" style="width:${data.eo}%"></div></div></div>
                    <div style="text-align:right;"><b>${data.eo}%</b><div style="font-size:0.5rem; opacity:0.5;">TOP 10K EO</div></div>
                </div>`;
            }).join('');

            // Dynamic Captain
            const cap = [...mySquad].sort((a,b) => (state.eliteData[b.name]?.xPts[0] || 0) - (state.eliteData[a.name]?.xPts[0] || 0))[0];
            const metric = Math.min(Math.round(((state.eliteData[cap.name]?.xPts[0] || 4) * 10) + (cap.ict / 2)), 99);
            document.getElementById('cap-name').innerText = cap.name;
            document.getElementById('cap-metric').innerText = metric;
            document.getElementById('cap-reason').innerText = `High xPts and ICT index of ${cap.ict}`;

            // Transfer Suggestion
            const weak = mySquad.sort((a,b) => a.ict - b.ict)[0];
            document.getElementById('rec-sell').innerText = weak.name;
            document.getElementById('rec-buy').innerText = "Palmer"; 
            document.getElementById('rec-reason').innerText = `${weak.name} has low attacking threat lately.`;

            renderChart(history.current.slice(-6));
        }

        function renderChart(history) {
            const ctx = document.getElementById('rankChart').getContext('2d');
            if (window.myRankChart) window.myRankChart.destroy();
            window.myRankChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => 'GW' + h.event),
                    datasets: [{
                        data: history.map(h => h.overall_rank),
                        borderColor: '#6750a4',
                        backgroundColor: 'rgba(103, 80, 164, 0.1)',
                        fill: true, tension: 0.4, borderWidth: 4, pointRadius: 4
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { reverse: true, display: false }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        init();
    </script>
    <div id="footer-placeholder"></div>
    <script src="nav.js"></script>
    <script src="footer.js"></script>
</body>
</html>
