<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Team vs Top 10k - Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5323/5323982.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="nav.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --fpl-green: #00ff87;
            --fpl-pink: #e90052;
            --m3-surface: #f8f9fa;
            --m3-card: #ffffff;
            --m3-text: #1d1b20;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--m3-surface);
            color: var(--m3-text);
            margin: 0;
            padding-bottom: 80px;
        }

        /* VS Header */
        .vs-header-card {
            background: #0b1120;
            color: white;
            padding: 24px 20px;
            border-radius: 0 0 32px 32px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .vs-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.6;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .vs-title {
            font-size: 1.4rem;
            font-weight: 900;
        }

        .vs-icon {
            color: var(--fpl-green);
            margin: 0 8px;
            font-style: italic;
        }

        /* Risk Meter Section */
        .risk-meter-container {
            background: var(--m3-card);
            margin: 0 12px 15px 12px;
            padding: 16px;
            border-radius: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .risk-meter-labels {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        #risk-status {
            font-size: 0.75rem;
            font-weight: 900;
            letter-spacing: 0.5px;
        }

        #risk-percent {
            font-size: 1.2rem;
            font-weight: 900;
        }

        .risk-track {
            width: 100%;
            height: 12px;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .risk-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--fpl-green), #2563eb, var(--fpl-pink));
            background-size: 300% 100%;
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .risk-description {
            font-size: 0.65rem;
            font-weight: 600;
            color: #666;
            line-height: 1.4;
        }

        /* Comparison Cards */
        #comparison-container {
            padding: 0 12px;
        }

        .vs-card {
            background: var(--m3-card);
            margin-bottom: 8px;
            padding: 12px 16px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.03);
        }

        .vs-player-info b {
            display: block;
            font-size: 0.85rem;
            font-weight: 800;
        }

        .vs-player-info small {
            font-size: 0.65rem;
            color: #777;
            font-weight: 500;
        }

        .chip {
            font-size: 0.55rem;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 900;
            text-transform: uppercase;
            margin-left: 4px;
        }

        .chip.shield { background: #eaddff; color: #21005d; }
        .chip.sword { background: var(--fpl-green); color: #0b1120; }

        .vs-score-zone { text-align: right; }
        .vs-diff-value { font-size: 1rem; font-weight: 900; color: #2563eb; }
        .vs-diff-label { font-size: 0.5rem; font-weight: 800; opacity: 0.4; }

        /* Shimmer Loading */
        .loading-skeleton {
            background: linear-gradient(90deg, #eee 25%, #f5f5f5 50%, #eee 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: 20px;
            height: 80px;
            margin-bottom: 10px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>

    <main style="margin-top: 60px;">
        <div class="vs-header-card">
            <div class="vs-label">Effective Ownership Analysis</div>
            <div class="vs-title">My Team <span class="vs-icon">VS</span> Top 10k</div>
        </div>

        <div class="risk-meter-container">
            <div class="risk-meter-labels">
                <span id="risk-status">SQUAD ANALYSIS</span>
                <span id="risk-percent">--%</span>
            </div>
            <div class="risk-track">
                <div id="risk-fill" class="risk-fill"></div>
            </div>
            <div id="risk-desc" class="risk-description">Loading your team data from FPL servers...</div>
        </div>

        <div id="comparison-container">
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        const state = {
            fplId: localStorage.getItem('kopala_id'),
            PROXY: "/.netlify/functions/fpl-proxy?endpoint=",
            playerMap: {},
            CACHE_TIME: 15 * 60 * 1000 // 15 Minute Cache
        };

        // Simulated Top 10k Benchmarks (In a real app, this could be a dynamic fetch)
        const top10kEO = {
            "Haaland": 94.2, "Salah": 72.5, "Palmer": 81.0, "Saka": 65.4, 
            "Gabriel": 52.1, "Raya": 38.5, "Watkins": 28.2, "Gordon": 12.4, 
            "Foden": 18.1, "Alexander-Arnold": 44.2, "Pickford": 6.3
        };

        async function fetchWithCache(key, endpoint) {
            const cached = localStorage.getItem(key);
            const now = Date.now();
            if (cached) {
                const parsed = JSON.parse(cached);
                if (now - parsed.timestamp < state.CACHE_TIME) return parsed.data;
            }
            const res = await fetch(`${state.PROXY}${endpoint}`);
            const data = await res.json();
            localStorage.setItem(key, JSON.stringify({ timestamp: now, data: data }));
            return data;
        }

        async function init() {
            if (!state.fplId) {
                alert("Please set your FPL ID on the Home page first.");
                window.location.href = "index.html";
                return;
            }

            try {
                const [bootData, entryData] = await Promise.all([
                    fetchWithCache('fpl_bootstrap', 'bootstrap-static/'),
                    fetchWithCache(`fpl_picks_${state.fplId}`, `entry/${state.fplId}/event/current/picks/`)
                ]);

                bootData.elements.forEach(p => {
                    state.playerMap[p.id] = { name: p.web_name };
                });

                render(entryData.picks);
            } catch (e) {
                document.getElementById('risk-desc').innerText = "Rate limit hit. Please wait 1 minute.";
            }
        }

        function render(picks) {
            const container = document.getElementById('comparison-container');
            let totalDiffPower = 0;
            let swordCount = 0;

            const results = picks.map(p => {
                const pInfo = state.playerMap[p.element];
                const name = pInfo ? pInfo.name : "Unknown";
                const eo = top10kEO[name] || 8.5; // Fallback EO
                const isSword = eo < 40;
                if (isSword) swordCount++;
                
                const power = (100 - eo).toFixed(1);
                totalDiffPower += parseFloat(power);

                return `
                    <div class="vs-card">
                        <div class="vs-player-info">
                            <div style="display:flex; align-items:center;">
                                <b>${name}</b>
                                <span class="chip ${isSword ? 'sword' : 'shield'}">${isSword ? 'Sword' : 'Shield'}</span>
                            </div>
                            <small>Top 10k EO: ${eo}%</small>
                        </div>
                        <div class="vs-score-zone">
                            <div class="vs-diff-value">${power}%</div>
                            <div class="vs-diff-label">POWER</div>
                        </div>
                    </div>`;
            }).join('');

            // Update Risk Meter
            const riskScore = Math.round((swordCount / picks.length) * 100);
            const fill = document.getElementById('risk-fill');
            fill.style.width = riskScore + '%';
            document.getElementById('risk-percent').innerText = riskScore + '%';
            
            const status = document.getElementById('risk-status');
            const desc = document.getElementById('risk-desc');
            
            if (riskScore > 60) {
                status.innerText = "HIGH RISK / AGGRESSIVE";
                status.style.color = "var(--fpl-pink)";
                desc.innerText = "You have many differentials. Huge rank gains (or losses) possible!";
            } else if (riskScore > 30) {
                status.innerText = "BALANCED STRATEGY";
                status.style.color = "#2563eb";
                desc.innerText = "You are following the template but keeping a few key weapons.";
            } else {
                status.innerText = "CONSERVATIVE / SAFE";
                status.style.color = "var(--fpl-green)";
                desc.innerText = "Your team is very similar to the Top 10k. Steady rank protection.";
            }

            container.innerHTML = results;
        }

        init();
    </script>
    <script src="nav.js"></script>
    <script src="footer.js"></script>
</body>
</html>
