<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kopala FPL </title>

    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kopala FPL">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5323/5323982.png">
    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    
</head>
<body>

<header>
    <header class="top-nav">
        <div class="nav-icon-btn" onclick="resetTeamID()" style="cursor: pointer;">
    <i class="fa-solid fa-circle-user"></i>
</div>
        <div class="logo-container">Kopala<span>▲</span>FPL</div>
        <div class="nav-icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-sun" id="theme-icon"></i></div>
    </header>
</header>

<div class="sync-container" style="background: white; border-radius: 16px; margin: 20px 10px; border: 1px solid #e2e8f0;">
    <div style="flex: 1; display: flex; flex-direction: column;">
        <input type="text" id="team-id" placeholder="Paste FPL ID here...">
        <span id="id-error" class="error-text">ID not found. Please try again.</span>
    </div>
    <button id="sync-btn" onclick="fetchFPLData()">Sync</button>
</div>
  
       

    <div id="main-content" class="container hidden">
        
        <section class="card">
            <div class="rank-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h2 id="disp-name" style="margin:0; font-size: 1.3rem;">Manager Name</h2>
                        <span id="disp-gw" style="font-size: 0.8rem; color: #64748b; font-weight: bold;">GW --</span>
                    </div>
                    <div style="text-align: right;">
                        <div id="disp-overall-rank" style="font-size: 1.1rem; font-weight: 800; color: var(--primary);"># 0</div>
                        <span style="font-size: 0.6rem; text-transform: uppercase; color: #94a3b8;">Current Rank</span>
                    </div>
                </div>
            </div>
            <div class="rank-grid">
                <div class="stat-tile"><span>GW Live</span><strong id="tile-gw-pts">0</strong></div>
                <div class="stat-tile"><span>Total</span><strong id="tile-total-pts">0</strong></div>
                <div class="stat-tile"><span>Benched</span><strong id="tile-bench-pts">0</strong></div>
                <div class="stat-tile"><span>GW Rank</span><strong id="tile-gw-rank">0</strong></div>
                <div class="stat-tile"><span>Old Rank</span><strong id="tile-old-rank">0</strong></div>
                <div class="stat-tile"><span>Change %</span><strong id="tile-change">0%</strong></div>
            </div>
        </section>

        <section class="card">
            <div class="card-header"><h3>Your team</h3> <span id="live-total" style="font-weight:bold; color:var(--primary)">0 Pts</span></div>
            <div class="pitch" id="pitch-main">
                <div id="p-gk" class="pitch-row"></div>
                <div id="p-def" class="pitch-row"></div>
                <div id="p-mid" class="pitch-row"></div>
                <div id="p-fwd" class="pitch-row"></div>
            </div>
        </section>

        <section class="card">
            <div class="card-header"><h3>Your bench</h3></div>
            <div class="pitch" style="background: var(--bench); min-height: 80px;">
                <div id="p-bench" class="pitch-row"></div>
            </div>
        </section>

        <section class="card">
            <div class="card-header header-blue"><h3>Your Transfers</h3> <span id="hit-val"></span></div>
            <table>
                <thead><tr><th>No</th><th>In</th><th>Out</th><th>Gain</th></tr></thead>
                <tbody id="user-tr-body"></tbody>
                <tr style="background:#f8fafc; font-weight:bold">
                    <td colspan="3" style="text-align:left; padding-left:10px;">Net GW Gain</td>
                    <td id="user-net-total">0</td>
                </tr>
            </table>
        </section>

        <section class="card">
            <div class="card-header header-pop"><h3>Popular Transfers (Top 10k)</h3></div>
            <table>
                <thead><tr><th>% / Vol</th><th>Player In</th><th>Player Out</th><th>Gain</th></tr></thead>
                <tbody id="top-tr-body"></tbody>
            </table>
        </section>

        <section class="card">
            <div class="card-header header-dark"><h3>Threats to your rank</h3></div>
            <div class="pitch" style="background:#334155">
                <div id="p-threats" class="pitch-row"></div>
            </div>
        </section>

    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item active"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="leagues.html" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item"><i class="fa-solid fa-tags"></i><span>Prices</span></a>
        <a href="games.html" class="nav-item"><i class="fa-solid fa-futbol"></i><span>Games</span></a>
        <a href="10k.html" class="nav-item"><i class="fa fa-bar-chart"></i><span>You vs 10k</span></a>
        <a href="#" class="nav-item"><i class="fa fa-question-circle"></i><span>About</span></a>
        <a href="https://wa.me/260964836842" class="nav-item"><i class="fa fa-comments"></i><span>Support</span></a>
        <a href="#" class="nav-item"><i class="fa fa-ellipsis-h"></i><span>More</span></a>
    </nav>

    <script>
    const PROXY = "https://corsproxy.io/?";
    let state = { live: {}, boot: null, gw: null };

    async function fetchFPLData() {
        const inputEl = document.getElementById('team-id');
        const errorEl = document.getElementById('id-error');
        const syncBtn = document.getElementById('sync-btn');
        let rawValue = inputEl.value.trim();

        // 1. Reset visual states
        inputEl.classList.remove('input-error', 'shake');
        errorEl.style.display = 'none';

        // 2. Smart Extraction (Handles full URLs)
        if (rawValue.includes('entry/')) {
            const match = rawValue.match(/entry\/(\d+)/);
            if (match) rawValue = match[1];
        }

        const id = parseInt(rawValue);

        // 3. Basic Validation
        if (!id || isNaN(id)) {
            triggerError("Please enter a valid Team ID");
            return;
        }

        try {
            // Loading State
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Loading...';

            // 4. Fetch Base Data (Bootstrap & Live)
            const bootRes = await fetch(PROXY + encodeURIComponent("https://fantasy.premierleague.com/api/bootstrap-static/"));
            state.boot = await bootRes.json();
            state.gw = state.boot.events.find(e => e.is_current).id;

            const liveRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/event/${state.gw}/live/`));
            const liveData = await liveRes.json();
            liveData.elements.forEach(el => state.live[el.id] = el.stats);

            // 5. Fetch Manager Specific Data
            const entryRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${id}/`));
            if (!entryRes.ok) throw new Error("ID not found");
            const entryData = await entryRes.json();

            const picksRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${id}/event/${state.gw}/picks/`));
            const picksData = await picksRes.json();
            
            const transRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${id}/transfers/`));
            const transData = await transRes.json();

            const histRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${id}/history/`));
            const histData = await histRes.json();

            // 6. Render the UI
            renderUI(picksData.picks, transData.filter(t => t.event === state.gw), histData, entryData);
            document.getElementById('main-content').classList.remove('hidden');

        } catch (err) {
            console.error(err);
            triggerError(err.message === "ID not found" ? "Team ID doesn't exist" : "Connection Error - Try again");
        } finally {
            syncBtn.disabled = false;
            syncBtn.innerText = "SYNC DATA";
        }

        function triggerError(msg) {
            inputEl.classList.add('input-error', 'shake');
            errorEl.innerText = msg;
            errorEl.style.display = 'block';
        }
    }

    function createPlayerCard(id, mult = 1, isOut = false) {
        const p = state.boot.elements.find(x => x.id === id);
        const pts = (state.live[id]?.total_points || 0) * mult;
        const willRise = p.transfers_in_event > 200000;

        return `
            <div class="player-mini">
                <img class="jersey" src="https://draft.premierleague.com/img/shirts/standard/shirt_${p.team_code}${p.element_type===1?'_1':''}-66.png">
                <div class="name-tag">${p.web_name}${willRise && !isOut ? '<span class="rise-alert">↑</span>' : ''}</div>
                <div class="pts-tag ${isOut ? 'pts-out' : 'pts-in'}">${pts}</div>
            </div>`;
    }

    function renderUI(picks, userTransfers, histData, entryData) {
        ['p-gk','p-def','p-mid','p-fwd','p-bench','p-threats','user-tr-body','top-tr-body'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = '';
        });

        const currentHist = histData.current.find(h => h.event === state.gw);
        const prevHist = histData.current.find(h => h.event === state.gw - 1);
        const hits = currentHist?.event_transfers_cost || 0;

        document.getElementById('disp-name').innerText = `${entryData.player_first_name} ${entryData.player_last_name}`;
        document.getElementById('disp-gw').innerText = `GW ${state.gw}`;
        document.getElementById('disp-overall-rank').innerText = `# ${currentHist.overall_rank.toLocaleString()}`;
        document.getElementById('tile-total-pts').innerText = currentHist.total_points;
        document.getElementById('tile-gw-rank').innerText = currentHist.rank.toLocaleString();
        document.getElementById('tile-old-rank').innerText = prevHist ? prevHist.overall_rank.toLocaleString() : 'N/A';
        
        if(prevHist) {
            const diff = prevHist.overall_rank - currentHist.overall_rank;
            const percent = ((diff / prevHist.overall_rank) * 100).toFixed(2);
            const el = document.getElementById('tile-change');
            el.innerText = (diff >= 0 ? "+" : "") + percent + "%";
            el.style.color = diff >= 0 ? "var(--success)" : "var(--danger)";
        }

        let squadTotal = 0;
        let benchPts = 0;
        picks.forEach(pick => {
            const p = state.boot.elements.find(x => x.id === pick.element);
            const html = createPlayerCard(pick.element, pick.multiplier);
            const playerPts = (state.live[pick.element]?.total_points || 0) * pick.multiplier;

            if(pick.position <= 11) {
                const row = {1:'p-gk', 2:'p-def', 3:'p-mid', 4:'p-fwd'}[p.element_type];
                document.getElementById(row).innerHTML += html;
                squadTotal += playerPts;
            } else {
                document.getElementById('p-bench').innerHTML += html;
                benchPts += (state.live[pick.element]?.total_points || 0);
            }
        });

        document.getElementById('live-total').innerText = squadTotal + " Pts";
        document.getElementById('tile-gw-pts').innerText = squadTotal;
        document.getElementById('tile-bench-pts').innerText = benchPts;

        let rawGain = 0;
        userTransfers.forEach((t, i) => {
            const gain = (state.live[t.element_in]?.total_points || 0) - (state.live[t.element_out]?.total_points || 0);
            rawGain += gain;
            document.getElementById('user-tr-body').innerHTML += `<tr><td>${i+1}</td><td>${createPlayerCard(t.element_in)}</td><td>${createPlayerCard(t.element_out, 1, true)}</td><td style="font-weight:bold">${gain}</td></tr>`;
        });
        document.getElementById('hit-val').innerHTML = hits > 0 ? `<span class="hit-badge">-${hits} HIT</span>` : '';
        document.getElementById('user-net-total').innerText = (rawGain - hits);

        const trends = [{ p: "9.5%", in: 233, out: 355 }, { p: "4.2%", in: 91, out: 355 }];
        trends.forEach(t => {
            const pIn = state.boot.elements.find(e => e.id === t.in);
            if(!pIn) return;
            const gain = (state.live[t.in]?.total_points || 0) - (state.live[t.out]?.total_points || 0);
            const vol = (pIn.transfers_in_event - pIn.transfers_out_event).toLocaleString();
            document.getElementById('top-tr-body').innerHTML += `
                <tr>
                    <td>${t.p}<br><span class="vol-badge">${vol} vol</span></td>
                    <td>${createPlayerCard(t.in)}</td>
                    <td>${createPlayerCard(t.out, 1, true)}</td>
                    <td style="font-weight:bold">${gain}</td>
                </tr>`;
        });

        const owned = picks.map(p => p.element);
        state.boot.elements
            .filter(e => !owned.includes(e.id))
            .sort((a,b) => (state.live[b.id]?.total_points || 0) - (state.live[a.id]?.total_points || 0))
            .slice(0, 5)
            .forEach(t => document.getElementById('p-threats').innerHTML += createPlayerCard(t.id));
    }
</script>
</body>
</html>
