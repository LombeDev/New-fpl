<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Members Area</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1a1a1b;
            --text-muted: #5f6368;
            --fpl-green: #00ff85;
            --fpl-pink: #e90052;
            --border-color: #dbdee1;
            --live-fpl-blue: #3876f2;
            --gold: #f39c12;
            --success-green: #155724;
            --success-bg: #d4edda;
            --warning-yellow: #856404;
            --warning-bg: #fff3cd;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, system-ui, sans-serif;
            padding-bottom: 90px;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        /* HEADER */
        .top-nav {
            background: #fff; padding: 8px 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .no-ads-pill {
            background: #f1f3f5; border: 1px solid #dee2e6;
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.65rem; font-weight: 800; display: flex; align-items: center; gap: 4px;
        }
        .logo { font-size: 1.2rem; font-weight: 900; letter-spacing: -1px; }
        .logo span { color: var(--fpl-green); }

        /* CONTROLS */
        .controls-wrapper {
            background: #fff; padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .member-header h2 { margin: 0; font-size: 1rem; color: var(--live-fpl-blue); text-align: center;}
        .member-header p { margin: 3px 0 10px; font-size: 0.65rem; color: var(--text-muted); font-weight: 700; text-align: center;}
        
        .stats-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .stat-badge { font-size: 0.6rem; font-weight: 800; padding: 3px 6px; border-radius: 4px; background: #eee; }

        .select-row { display: grid; grid-template-columns: 1fr 80px; gap: 6px; margin-bottom: 10px; }
        select { padding: 6px; border-radius: 6px; border: 1px solid #ced4da; font-weight: 600; font-size: 0.75rem; }
        .sort-btn { background:#fff; border:1px solid #ced4da; border-radius:6px; font-weight:800; font-size: 0.75rem; cursor:pointer; }

        .icon-grid { display: flex; justify-content: space-around; margin-bottom: 5px; }
        .icon-box {
            width: 36px; height: 36px; border: 1px solid #dee2e6; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1rem; color: #495057; cursor: pointer;
        }
        .icon-box.active-filter { background-color: var(--live-fpl-blue); color: white; border-color: var(--live-fpl-blue); }

        #search-area { display: none; margin-bottom: 10px; }
        #search-input {
            width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--live-fpl-blue); outline: none; box-sizing: border-box; font-size: 0.8rem;
        }

        /* TABLE */
        .table-header {
            background: #0b141b; color: #94a3b8; padding: 8px 5px;
            display: grid; grid-template-columns: 25px 1fr 45px 50px 30px 45px;
            font-size: 0.55rem; font-weight: 800; text-transform: uppercase;
            align-items: center;
        }

        .manager-row { background: #fff; border-bottom: 1px solid #eee; width: 100%; }
        .row-summary {
            display: grid; grid-template-columns: 25px 1fr 45px 50px 30px 45px;
            padding: 10px 5px; align-items: center; cursor: pointer;
        }
        
        .pos-cell { font-weight: 900; color: #6c757d; font-size: 0.75rem; }
        .name-cell { overflow: hidden; }
        .name-cell b { font-weight: 800; font-size: 0.7rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .name-cell small { font-size: 0.6rem; color: #6c757d; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .status-badge { font-size: 0.5rem; padding: 2px 3px; border-radius: 3px; font-weight: 800; text-align: center; }
        .status-paid { background: var(--success-bg); color: var(--success-green); }
        .status-pending { background: var(--warning-bg); color: var(--warning-yellow); }

        .capt-cell { text-align: center; font-size: 0.6rem; line-height: 1; overflow: hidden; }
        .capt-name { font-weight: 700; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .gw-pts-cell { font-weight: 700; font-size: 0.75rem; text-align: center; }
        .total-pts-cell { font-weight: 900; font-size: 0.8rem; text-align: right; }

        /* SQUAD EXPANSION */
        .row-expansion {
            max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #f8f9fa;
        }
        .manager-row.active .row-expansion { max-height: 1200px; padding: 10px 5px; border-top: 1px solid #eee; }

        .expansion-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .chip { background: #fff; border: 1px solid #dee2e6; padding: 2px 6px; border-radius: 10px; font-size: 0.55rem; font-weight: 700; }

        .squad-scroller { display: flex; overflow-x: auto; gap: 5px; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
        .player-card { min-width: 70px; text-align: center; background: #fff; border: 1px solid #eee; border-radius: 4px; overflow: hidden; }
        .player-shirt { height: 32px; margin: 4px 0; }
        .player-label { background: #1a1a1b; color: #fff; font-size: 0.55rem; padding: 3px 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-ownership { background: var(--fpl-green); font-size: 0.55rem; font-weight: 700; }
        .player-points { font-size: 0.8rem; font-weight: 900; padding: 4px 0; }

        #scrollTopBtn {
            display: none; position: fixed; bottom: 80px; right: 20px; z-index: 99;
            border: none; background-color: var(--live-fpl-blue); color: white; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* NAVIGATION */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 60px;
            background: #fff; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; z-index: 1000;
        }
        .nav-item { text-decoration: none; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
        .nav-item.active { color: var(--live-fpl-blue); }
        .nav-item i { font-size: 0.9rem; }
        .nav-item span { font-size: 0.55rem; font-weight: 700; }
    </style>
</head>
<body>

    <button onclick="topFunction()" id="scrollTopBtn"><i class="fa-solid fa-chevron-up"></i></button>

    <header class="top-nav">
        <div class="no-ads-pill"><i class="fa-solid fa-crown"></i> No Ads</div>
        <div class="logo">Kopala<span>▲</span>FPL</div>
        <div style="display:flex; gap:12px; font-size: 1rem; color: #555;">
            <i class="fa-solid fa-circle-user"></i>
            <i class="fa-solid fa-sun"></i>
        </div>
    </header>

    <div class="controls-wrapper">
        <div class="member-header">
            <h2>Kopala EPL Members</h2>
            <p>Season 25/26</p>
        </div>
        <div class="stats-bar">
            <span class="stat-badge">Total: <span id="count-total">0</span></span>
            <span class="stat-badge">Paid: <span id="count-paid">0</span></span>
        </div>
        <div class="select-row">
            <select id="sort-criteria" onchange="applySort()">
                <option value="total">Total Points</option>
                <option value="event">GW Points</option>
            </select>
            <button class="sort-btn" onclick="applySort()">Sort ▼</button>
        </div>
        <div class="icon-grid">
            <div class="icon-box" onclick="toggleSearch()"><i class="fa-solid fa-magnifying-glass"></i></div>
            <div class="icon-box" onclick="togglePaidOnly()" id="filter-paid-btn"><i class="fa-solid fa-filter"></i></div>
            <div class="icon-box" onclick="location.reload()"><i class="fa-solid fa-rotate"></i></div>
        </div>
        <div id="search-area">
            <input type="text" id="search-input" placeholder="Search..." onkeyup="runFilter()">
        </div>
    </div>

    <div class="table-header">
        <span>#</span><span>Manager</span><span>Status</span><span>(C)</span><span>GW</span><span style="text-align:right">Tot</span>
    </div>

    <div id="manager-list-container"></div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa fa-line-chart"></i><span>Rank</span></a>
        <a href="leagues.html" class="nav-item"><i class="fa fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item"><i class="fa fa-usdy"></i><span>Prices</span></a>
        <a href="games.html" class="nav-item"><i class="fa fa-gamepad"></i><span>Games</span></a>
        <a href="members.html" class="nav-item active"><i class="fa fa-handshake-o"></i><span>Members</span></a>
        <a href="https://wa.me/260964836842" class="nav-item" target="_blank"><i class="fa-brands fa-whatsapp"></i><span>Support</span></a>
    </nav>

    <script>
        const state = {
            leagueId: '101712',
            currentGW: 1,
            playerMap: {},
            elements: [],
            PROXY: "/.netlify/functions/fpl-proxy?endpoint=",
            showingPaidOnly: false,
            paidNames: ["Benson Mwelwa", "Cosmas Mwenya", "Dee Dinga", "Gerard Kabaso", "Kambikambi Kangwa", "Kennedy Chibuye", "Lombe Simakando", "Maurice Mwale", "Mwamba Mubanga", "Nelson Mumbi", "Philip Mapulanga", "Sheila Chomba", "Armari25", "cosmas randie mwenya", "The Hollows", "Gerhard kabaso"]
        };

        // Scroll Logic
        window.onscroll = function() {
            const btn = document.getElementById("scrollTopBtn");
            btn.style.display = (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) ? "block" : "none";
        };
        function topFunction() { window.scrollTo({top: 0, behavior: 'smooth'}); }

        async function init() {
            try {
                const staticRes = await fetch(`${state.PROXY}bootstrap-static/`);
                const staticData = await staticRes.json();
                state.elements = staticData.elements;
                state.currentGW = staticData.events.find(e => e.is_current).id;
                staticData.elements.forEach(p => {
                    state.playerMap[p.id] = { name: p.web_name, team: p.team_code, own: p.selected_by_percent };
                });
                loadStandings(state.leagueId);
            } catch (err) { console.error("Load Error", err); }
        }

        async function loadStandings(id) {
            const container = document.getElementById('manager-list-container');
            const res = await fetch(`${state.PROXY}leagues-classic/${id}/standings/`);
            const data = await res.json();
            let paidCount = 0;

            container.innerHTML = data.standings.results.map((r, i) => {
                const isSub = state.paidNames.some(name => r.player_name.toLowerCase().includes(name.toLowerCase()) || r.entry_name.toLowerCase().includes(name.toLowerCase()));
                if (isSub) paidCount++;
                return `
                    <div class="manager-row" id="row-${r.entry}">
                        <div class="row-summary" onclick="expandManager(${r.entry})">
                            <span class="pos-cell">${i+1}</span>
                            <div class="name-cell">
                                <b>${r.entry_name} ${isSub ? '<i class="fa-solid fa-circle-check" style="color:var(--fpl-pink); font-size:0.7rem;"></i>' : ''}</b>
                                <small>${r.player_name}</small>
                            </div>
                            <div><span class="status-badge ${isSub ? 'status-paid' : 'status-pending'}">${isSub ? 'PAID' : 'PEND'}</span></div>
                            <div class="capt-cell" id="cap-${r.entry}"><span class="capt-name">---</span></div>
                            <span class="gw-pts-cell">${r.event_total}</span>
                            <span class="total-pts-cell">${r.total.toLocaleString()}</span>
                        </div>
                        <div class="row-expansion" id="exp-${r.entry}">
                            <div class="expansion-meta" id="meta-${r.entry}"><span class="chip">Fetching Team...</span></div>
                            <div class="squad-scroller" id="squad-${r.entry}"></div>
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('count-total').innerText = data.standings.results.length;
            document.getElementById('count-paid').innerText = paidCount;
        }

        async function expandManager(entryId) {
            const row = document.getElementById(`row-${entryId}`);
            const squadBox = document.getElementById(`squad-${entryId}`);
            const metaBox = document.getElementById(`meta-${entryId}`);
            row.classList.toggle('active');

            if (row.classList.contains('active') && squadBox.innerHTML === "") {
                const res = await fetch(`${state.PROXY}entry/${entryId}/event/${state.currentGW}/picks/`);
                const data = await res.json();
                
                squadBox.innerHTML = data.picks.map(pick => {
                    const p = state.playerMap[pick.element];
                    const live = state.elements.find(el => el.id === pick.element);
                    const pts = (live ? live.event_points : 0) * pick.multiplier;
                    if (pick.is_captain) document.getElementById(`cap-${entryId}`).innerHTML = `<span class="capt-name">${p.name}</span>`;
                    return `
                        <div class="player-card">
                            <img src="https://fantasy.premierleague.com/dist/img/shirts/standard/s_${p.team}-66.png" class="player-shirt">
                            <div class="player-label">${p.name}</div>
                            <div class="player-ownership">${p.own}%</div>
                            <div class="player-points">${pts}</div>
                        </div>`;
                }).join('');

                metaBox.innerHTML = `
                    <span class="chip">TV: £${(data.entry_history.value/10).toFixed(1)}</span>
                    <span class="chip">Bank: £${(data.entry_history.bank/10).toFixed(1)}</span>
                    <span class="chip">Chip: ${data.active_chip || 'None'}</span>
                `;
            }
        }

        function toggleSearch() { const s = document.getElementById('search-area'); s.style.display = (s.style.display === 'block') ? 'none' : 'block'; }
        function togglePaidOnly() { state.showingPaidOnly = !state.showingPaidOnly; document.getElementById('filter-paid-btn').classList.toggle('active-filter'); runFilter(); }
        
        function runFilter() {
            const val = document.getElementById('search-input').value.toLowerCase();
            document.querySelectorAll('.manager-row').forEach(row => {
                const isPaid = row.querySelector('.status-badge').innerText === 'PAID';
                row.style.display = (row.innerText.toLowerCase().includes(val) && (!state.showingPaidOnly || isPaid)) ? 'block' : 'none';
            });
        }

        function applySort() {
            const list = document.getElementById('manager-list-container');
            const crit = document.getElementById('sort-criteria').value;
            Array.from(list.children).sort((a, b) => {
                const valA = parseInt(a.querySelector(crit === 'total' ? '.total-pts-cell' : '.gw-pts-cell').innerText.replace(/,/g, ''));
                const valB = parseInt(b.querySelector(crit === 'total' ? '.total-pts-cell' : '.gw-pts-cell').innerText.replace(/,/g, ''));
                return valB - valA;
            }).forEach(c => list.appendChild(c));
        }

        init();
    </script>
</body>
</html>
