<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Members Area</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1a1a1b;
            --text-muted: #5f6368;
            --fpl-green: #00ff85;
            --fpl-pink: #e90052;
            --border-color: #dbdee1;
            --live-fpl-blue: #3876f2;
            --gold: #f39c12;
            --success-green: #155724;
            --success-bg: #d4edda;
            --warning-yellow: #856404;
            --warning-bg: #fff3cd;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, system-ui, sans-serif;
            padding-bottom: 90px;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        /* HEADER DESIGN */
        .top-nav {
            background: #fff; padding: 8px 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .no-ads-pill {
            background: #f1f3f5; border: 1px solid #dee2e6;
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.65rem; font-weight: 800; display: flex; align-items: center; gap: 4px;
        }
        .no-ads-pill i { color: var(--gold); }
        .logo { font-size: 1.2rem; font-weight: 900; letter-spacing: -1px; }
        .logo span { color: var(--fpl-green); }

        /* MEMBERS CONTROLS */
        .controls-wrapper {
            background: #fff; padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .member-header h2 { margin: 0; font-size: 1rem; color: var(--live-fpl-blue); text-align: center;}
        .member-header p { margin: 3px 0 10px; font-size: 0.65rem; color: var(--text-muted); font-weight: 700; text-align: center;}
        
        .stats-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .stat-badge { font-size: 0.6rem; font-weight: 800; padding: 3px 6px; border-radius: 4px; background: #eee; }

        .select-row { display: grid; grid-template-columns: 1fr 80px; gap: 6px; margin-bottom: 10px; }
        select { padding: 6px; border-radius: 6px; border: 1px solid #ced4da; font-weight: 600; font-size: 0.75rem; }
        .sort-btn { background:#fff; border:1px solid #ced4da; border-radius:6px; font-weight:800; font-size: 0.75rem; cursor:pointer; }

        .icon-grid { display: flex; justify-content: space-around; margin-bottom: 5px; }
        .icon-box {
            width: 36px; height: 36px; border: 1px solid #dee2e6; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1rem; color: #495057; cursor: pointer;
        }
        .icon-box.active-filter { background-color: var(--live-fpl-blue); color: white; border-color: var(--live-fpl-blue); }

        #search-area { display: none; margin-bottom: 10px; }
        #search-input {
            width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--live-fpl-blue); outline: none; box-sizing: border-box; font-size: 0.8rem;
        }

        /* MOBILE OPTIMIZED TABLE */
        .table-header {
            background: #0b141b; color: #94a3b8; padding: 8px 5px;
            display: grid; 
            grid-template-columns: 25px 1fr 45px 50px 30px 45px;
            font-size: 0.55rem; font-weight: 800; text-transform: uppercase;
            align-items: center;
        }

        .manager-row { background: #fff; border-bottom: 1px solid #eee; width: 100%; }
        .row-summary {
            display: grid; 
            grid-template-columns: 25px 1fr 45px 50px 30px 45px;
            padding: 10px 5px; align-items: center; cursor: pointer;
            width: 100%; box-sizing: border-box;
        }
        
        .pos-cell { font-weight: 900; color: #6c757d; font-size: 0.75rem; }
        .name-cell { overflow: hidden; }
        .name-cell b { font-weight: 800; font-size: 0.7rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .name-cell small { font-size: 0.6rem; color: #6c757d; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .status-badge { font-size: 0.5rem; padding: 2px 3px; border-radius: 3px; font-weight: 800; text-align: center; }
        .status-paid { background: var(--success-bg); color: var(--success-green); }
        .status-pending { background: var(--warning-bg); color: var(--warning-yellow); }

        .capt-cell { text-align: center; font-size: 0.6rem; line-height: 1; overflow: hidden; }
        .capt-name { font-weight: 700; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .gw-pts-cell { font-weight: 700; font-size: 0.75rem; text-align: center; }
        .total-pts-cell { font-weight: 900; font-size: 0.8rem; text-align: right; }

        /* JUMP TO TOP BUTTON */
        #scrollTopBtn {
            display: none; position: fixed; bottom: 80px; right: 20px; z-index: 99;
            border: none; outline: none; background-color: var(--live-fpl-blue);
            color: white; cursor: pointer; width: 40px; height: 40px;
            border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); font-size: 1.2rem;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 60px;
            background: #fff; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; z-index: 1000;
        }
        .nav-item { text-decoration: none; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
        .nav-item.active { color: var(--live-fpl-blue); }
        .nav-item i { font-size: 0.9rem; }
        .nav-item span { font-size: 0.55rem; font-weight: 700; }
    </style>
</head>
<body>

    <button onclick="topFunction()" id="scrollTopBtn" title="Go to top"><i class="fa-solid fa-chevron-up"></i></button>

    <header class="top-nav">
        <div class="no-ads-pill"><i class="fa-solid fa-crown"></i> No Ads</div>
        <div class="logo">Kopala<span>▲</span>FPL</div>
        <div style="display:flex; gap:12px; font-size: 1rem; color: #555;">
            <i class="fa-solid fa-circle-user"></i>
            <i class="fa-solid fa-sun"></i>
        </div>
    </header>

    <div class="controls-wrapper">
        <div class="member-header">
            <h2>Kopala EPL Members</h2>
            <p>Season 25/26</p>
        </div>

        <div class="stats-bar">
            <span class="stat-badge">Total: <span id="count-total">0</span></span>
            <span class="stat-badge">Paid: <span id="count-paid">0</span></span>
        </div>
        
        <div class="select-row">
            <select id="sort-criteria" onchange="applySort()">
                <option value="total">Total Points</option>
                <option value="event">GW Points</option>
            </select>
            <button class="sort-btn" onclick="applySort()">Sort ▼</button>
        </div>

        <div class="icon-grid">
            <div class="icon-box" onclick="toggleSearch()"><i class="fa-solid fa-magnifying-glass"></i></div>
            <div class="icon-box" onclick="togglePaidOnly()" id="filter-paid-btn"><i class="fa-solid fa-filter"></i></div>
            <div class="icon-box" onclick="location.reload()"><i class="fa-solid fa-rotate"></i></div>
        </div>

        <div id="search-area">
            <input type="text" id="search-input" placeholder="Search name or team..." onkeyup="runFilter()">
        </div>
    </div>

    <div class="table-header">
        <span>#</span>
        <span>Manager</span>
        <span>Status</span>
        <span>(C)</span>
        <span>GW</span>
        <span style="text-align:right">Tot</span>
    </div>

    <div id="manager-list-container"></div>

    <nav class="bottom-nav">
        <a href="#" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="#" class="nav-item active"><i class="fa fa-user-secret"></i><span>Members</span></a>
        <a href="https://wa.me/260964836842" class="nav-item" target="_blank">
            <i class="fa-brands fa-whatsapp"></i>
            <span>Support</span>
        </a>
    </nav>

    <script>
        const state = {
            leagueId: '101712',
            currentGW: 1,
            playerMap: {},
            elements: [],
            PROXY: "/.netlify/functions/fpl-proxy?endpoint=",
            showingPaidOnly: false,
            // List of paid entries for verification
            paidNames: [
                "Benson Mwelwa", "Cosmas Mwenya", "Dee Dinga", "Gerard Kabaso", 
                "Kambikambi Kangwa", "Kennedy Chibuye", "Lombe Simakando", 
                "Maurice Mwale", "Mwamba Mubanga", "Nelson Mumbi", 
                "Philip Mapulanga", "Sheila Chomba", "Armari25", 
                "cosmas randie mwenya", "The Hollows", "Gerhard kabaso"
            ]
        };

        // Scroll to top logic
        window.onscroll = function() { scrollFunction() };
        function scrollFunction() {
            const btn = document.getElementById("scrollTopBtn");
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        }
        function topFunction() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        async function init() {
            try {
                const staticRes = await fetch(`${state.PROXY}bootstrap-static/`);
                const staticData = await staticRes.json();
                state.elements = staticData.elements;
                state.currentGW = staticData.events.find(e => e.is_current).id;
                
                staticData.elements.forEach(p => {
                    state.playerMap[p.id] = { name: p.web_name, team: p.team_code };
                });

                loadStandings(state.leagueId);
            } catch (err) { 
                console.error("Initialization failed", err);
                document.getElementById('manager-list-container').innerHTML = '<p style="text-align:center; padding:20px;">Error loading data. Please refresh.</p>';
            }
        }

        async function loadStandings(id) {
            const container = document.getElementById('manager-list-container');
            container.innerHTML = '<p style="text-align:center; padding:30px; font-weight:700;">Syncing EPL Data...</p>';
            
            const res = await fetch(`${state.PROXY}leagues-classic/${id}/standings/`);
            const data = await res.json();
            
            let paidCount = 0;

            container.innerHTML = data.standings.results.map((r, i) => {
                const isSub = state.paidNames.some(name => {
                    const n = name.toLowerCase().trim();
                    return r.player_name.toLowerCase().includes(n) || r.entry_name.toLowerCase().includes(n);
                });
                
                if (isSub) paidCount++;

                return `
                    <div class="manager-row">
                        <div class="row-summary">
                            <span class="pos-cell">${i+1}</span>
                            <div class="name-cell">
                                <b>${r.entry_name} ${isSub ? '<i class="fa-solid fa-circle-check" style="color:var(--fpl-pink); font-size:0.75rem; margin-left:3px;"></i>' : ''}</b>
                                <small>${r.player_name}</small>
                            </div>

                            <div>
                                <span class="status-badge ${isSub ? 'status-paid' : 'status-pending'}">
                                    ${isSub ? 'PAID' : 'PEND'}
                                </span>
                            </div>

                            <div class="capt-cell" id="cap-${r.entry}">
                                <span class="capt-name">---</span>
                            </div>
                            
                            <span class="gw-pts-cell">${r.event_total}</span>
                            <span class="total-pts-cell">${r.total.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('count-total').innerText = data.standings.results.length;
            document.getElementById('count-paid').innerText = paidCount;
            
            // Fetch captains for all visible entries
            data.standings.results.forEach(r => fetchCaptain(r.entry));
        }

        async function fetchCaptain(entryId) {
            try {
                const res = await fetch(`${state.PROXY}entry/${entryId}/event/${state.currentGW}/picks/`);
                const data = await res.json();
                const captPick = data.picks.find(p => p.is_captain);
                const p = state.playerMap[captPick.element];
                document.getElementById(`cap-${entryId}`).innerHTML = `<span class="capt-name">${p.name}</span>`;
            } catch (e) {}
        }

        function toggleSearch() {
            const el = document.getElementById('search-area');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
            if(el.style.display === 'block') document.getElementById('search-input').focus();
        }

        function togglePaidOnly() {
            state.showingPaidOnly = !state.showingPaidOnly;
            document.getElementById('filter-paid-btn').classList.toggle('active-filter', state.showingPaidOnly);
            runFilter();
        }

        function runFilter() {
            const val = document.getElementById('search-input').value.toLowerCase().trim();
            const rows = document.querySelectorAll('.manager-row');

            rows.forEach(row => {
                const nameText = row.innerText.toLowerCase();
                const isPaid = row.querySelector('.status-badge').innerText.includes('PAID');
                const matchesSearch = nameText.includes(val);
                const matchesPaidFilter = !state.showingPaidOnly || isPaid;

                row.style.display = (matchesSearch && matchesPaidFilter) ? 'block' : 'none';
            });
        }

        function applySort() {
            const list = document.getElementById('manager-list-container');
            const cards = Array.from(list.querySelectorAll('.manager-row'));
            const criteria = document.getElementById('sort-criteria').value;

            cards.sort((a, b) => {
                const valA = parseInt(a.querySelector(criteria === 'total' ? '.total-pts-cell' : '.gw-pts-cell').innerText.replace(/,/g, ''));
                const valB = parseInt(b.querySelector(criteria === 'total' ? '.total-pts-cell' : '.gw-pts-cell').innerText.replace(/,/g, ''));
                return valB - valA;
            });

            cards.forEach(c => list.appendChild(c));
            document.querySelectorAll('.pos-cell').forEach((p, idx) => p.innerText = idx + 1);
        }

        init();
    </script>
</body>
</html>
