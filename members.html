<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Members - Kopala FPL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary-blue: #2563eb;
            --fpl-green: #00ff85;
            --fpl-pink: #e90052;
            --border-color: #e2e8f0;
            --success-bg: #dcfce7;
            --success-text: #15803d;
            --warning-bg: #fef9c3;
            --warning-text: #a16207;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main); font-family: -apple-system, system-ui, sans-serif; padding-bottom: 90px; }

        /* --- TOP NAV --- */
        .top-nav { position: fixed; top: 0; width: 100%; height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 3000; }
        .logo-container { font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; }
        .logo-container span { color: var(--fpl-green); }

        /* --- CONTROLS --- */
        .controls-wrapper { margin-top: 60px; background: var(--card-bg); padding: 15px; border-bottom: 1px solid var(--border-color); }
        .member-header h2 { margin: 0; font-size: 1.1rem; color: var(--primary-blue); text-align: center; }
        .stats-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .stat-badge { font-size: 0.65rem; font-weight: 800; padding: 4px 10px; border-radius: 6px; background: var(--bg-color); border: 1px solid var(--border-color); }
        .select-row { display: grid; grid-template-columns: 1fr 80px; gap: 8px; margin-bottom: 12px; }
        select { padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); font-weight: 600; }

        /* --- TABLE --- */
        .table-header { background: #0b141b; color: #94a3b8; padding: 10px 8px; display: grid; grid-template-columns: 25px 1fr 50px 50px 40px 50px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; }
        .manager-row { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }
        .row-summary { display: grid; grid-template-columns: 25px 1fr 50px 50px 40px 50px; padding: 12px 8px; align-items: center; cursor: pointer; }
        .pos-cell { font-weight: 900; color: var(--text-muted); font-size: 0.75rem; }
        .name-cell b { font-weight: 800; font-size: 0.75rem; display: block; color: var(--text-main); }
        .status-badge { font-size: 0.55rem; padding: 2px 4px; border-radius: 4px; font-weight: 900; text-align: center; }
        .status-paid { background: var(--success-bg); color: var(--success-text); }
        .status-pending { background: var(--warning-bg); color: var(--warning-text); }

        /* --- SQUAD PITCH EXPANSION --- */
        .row-expansion { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; background-image: url('https://fantasy.premierleague.com/static/media/pitch-default.7937318e.svg'); background-size: cover; background-position: center; position: relative; }
        .manager-row.active .row-expansion { max-height: 450px; border-top: 1px solid var(--border-color); }
        
        .squad-scroller { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px 4px; padding: 15px 5px; backdrop-filter: blur(1px); }
        .player-card { width: 45px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .player-shirt { width: 26px; height: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .player-label { color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); font-size: 0.5rem; font-weight: 700; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px;}
        .player-pts { background: #ffffff; color: #1a1a1b; font-size: 0.65rem; font-weight: 900; border-radius: 4px; width: 28px; text-align: center; margin-top: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        /* --- STATS PILLS & TRANSFERS --- */
        .squad-stats-bar { display: flex; justify-content: center; gap: 6px; padding: 10px 5px 0; flex-wrap: wrap; }
        .stat-pill { background: rgba(255, 255, 255, 0.9); border-radius: 20px; padding: 3px 10px; font-size: 0.6rem; font-weight: 700; color: #334155; border: 1px solid #cbd5e1; }
        .transfer-row { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 4px 12px; font-size: 0.6rem; font-weight: 700; margin: 8px auto; width: fit-content; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .t-out { text-decoration: line-through; color: #64748b; }
        .t-in { color: #1e293b; font-weight: 800; }

        /* --- BOTTOM NAV --- */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: var(--card-bg); border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(8, 1fr); padding: 5px 0; z-index: 3000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); text-decoration: none; font-size: 0.55rem; font-weight: 700; gap: 4px; }
        .nav-item.active { color: var(--primary-blue); }
        #scrollTopBtn { display: none; position: fixed; bottom: 90px; right: 20px; z-index: 99; border: none; background: var(--primary-blue); color: white; width: 45px; height: 45px; border-radius: 50%; }
    </style>
</head>
<body class="dark-mode">

    <header class="top-nav">
        <div class="nav-icon-btn"><i class="fa-solid fa-circle-user"></i></div>
        <div class="logo-container">Kopala<span>▲</span>FPL</div>
        <div class="nav-icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-sun" id="theme-icon"></i></div>
    </header>

    <div class="controls-wrapper">
        <div class="member-header">
            <h2>Kopala EPL Members</h2>
            <p>Season 25/26 Official Standings</p>
        </div>
        <div class="stats-bar">
            <span class="stat-badge">Total: <span id="count-total">0</span></span>
            <span class="stat-badge">Paid: <span id="count-paid">0</span></span>
        </div>
        <div class="select-row">
            <select id="sort-criteria" onchange="applySort()">
                <option value="total">Total Points</option>
                <option value="event">GW Points</option>
            </select>
            <button class="icon-box" style="background:var(--primary-blue); color:white; border:none; border-radius:8px; width:100%" onclick="applySort()">Sort ▼</button>
        </div>
        <div class="icon-grid" style="display:flex; justify-content: center; gap:15px;">
            <div class="icon-box" style="width:40px; height:40px; border:1px solid var(--border-color); border-radius:10px; display:flex; align-items:center; justify-content:center;" onclick="toggleSearch()"><i class="fa-solid fa-magnifying-glass"></i></div>
            <div class="icon-box" style="width:40px; height:40px; border:1px solid var(--border-color); border-radius:10px; display:flex; align-items:center; justify-content:center;" onclick="togglePaidOnly()" id="filter-paid-btn"><i class="fa-solid fa-filter-circle-check"></i></div>
        </div>
        <div id="search-area" style="display:none; margin-top:10px;">
            <input type="text" id="search-input" placeholder="Search..." onkeyup="runFilter()" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--primary-blue);">
        </div>
    </div>

    <div class="table-header">
        <span>#</span><span>Manager</span><span>Status</span><span>(C)</span><span>GW</span><span style="text-align:right">Tot</span>
    </div>

    <div id="manager-list-container"></div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>Rank</span></a>
        <a href="leagues.html" class="nav-item"><i class="fa-solid fa-trophy"></i><span>Leagues</span></a>
        <a href="prices.html" class="nav-item"><i class="fa-solid fa-tags"></i><span>Prices</span></a>
        <a href="games.html" class="nav-item"><i class="fa-solid fa-futbol"></i><span>Games</span></a>
        <a href="members.html" class="nav-item active"><i class="fa-solid fa-user-tie"></i><span>Members</span></a>
        <a href="https://wa.me/260964836842" class="nav-item"><i class="fa fa-comments"></i><span>Support</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-circle-info"></i><span>About</span></a>
        <a href="#" class="nav-item"><i class="fa fa-ellipsis-h"></i><span>More</span></a>
    </nav>

    <script>
        const state = {
            leagueId: '101712',
            currentGW: 1,
            playerMap: {},
            liveData: {},
            PROXY: "/.netlify/functions/fpl-proxy?endpoint=",
            showingPaidOnly: false,
            paidNames: ["Benson Mwelwa", "Cosmas Mwenya", "Dee Dinga", "Gerard Kabaso", "Kambikambi Kangwa", "Kennedy Chibuye", "Lombe Simakando", "Maurice Mwale", "Mwamba Mubanga", "Nelson Mumbi", "Philip Mapulanga", "Sheila Chomba", "Armari25", "cosmas randie mwenya", "The Hollows", "Gerhard kabaso"]
        };

        function preloadJerseys() {
            for (let i = 1; i <= 20; i++) {
                new Image().src = `https://draft.premierleague.com/img/shirts/standard/shirt_${i}-66.png`;
                new Image().src = `https://draft.premierleague.com/img/shirts/standard/shirt_${i}_1-66.png`;
            }
        }

        async function init() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(() => preloadJerseys());
            }

            try {
                const staticRes = await fetch(`${state.PROXY}bootstrap-static/`);
                const staticData = await staticRes.json();
                state.currentGW = staticData.events.find(e => e.is_current).id;

                staticData.elements.forEach(p => {
                    state.playerMap[p.id] = { 
                        name: p.web_name, 
                        team: p.team_code, 
                        pos: p.element_type 
                    };
                });

                const liveRes = await fetch(`${state.PROXY}event/${state.currentGW}/live/`);
                const liveData = await liveRes.json();
                liveData.elements.forEach(el => {
                    state.liveData[el.id] = el.stats.total_points;
                });

                loadStandings(state.leagueId);
            } catch (err) { console.error(err); }
        }

        async function loadStandings(id) {
            const container = document.getElementById('manager-list-container');
            const res = await fetch(`${state.PROXY}leagues-classic/${id}/standings/`);
            const data = await res.json();
            let paidCount = 0;

            container.innerHTML = data.standings.results.map((r, i) => {
                const isSub = state.paidNames.some(name => r.player_name.toLowerCase().includes(name.toLowerCase()) || r.entry_name.toLowerCase().includes(name.toLowerCase()));
                if (isSub) paidCount++;
                return `
                    <div class="manager-row" id="row-${r.entry}">
                        <div class="row-summary" onclick="expandManager(${r.entry})">
                            <span class="pos-cell">${i+1}</span>
                            <div class="name-cell">
                                <b>${r.entry_name} ${isSub ? '<i class="fa-solid fa-circle-check" style="color:var(--fpl-pink); font-size:0.7rem;"></i>' : ''}</b>
                                <small>${r.player_name}</small>
                            </div>
                            <div><span class="status-badge ${isSub ? 'status-paid' : 'status-pending'}">${isSub ? 'PAID' : 'PEND'}</span></div>
                            <div class="capt-cell" id="cap-${r.entry}" style="font-size:0.55rem;">-</div>
                            <span class="gw-pts-cell">${r.event_total}</span>
                            <span class="total-pts-cell">${r.total.toLocaleString()}</span>
                        </div>
                        <div class="row-expansion" id="exp-${r.entry}">
                            <div id="squad-${r.entry}"></div>
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('count-total').innerText = data.standings.results.length;
            document.getElementById('count-paid').innerText = paidCount;
        }

        async function expandManager(entryId) {
            const row = document.getElementById(`row-${entryId}`);
            const squadBox = document.getElementById(`squad-${entryId}`);
            const isActive = row.classList.toggle('active');

            if (isActive && squadBox.dataset.loaded !== "true") {
                try {
                    const [picksRes, entryRes, transRes] = await Promise.all([
                        fetch(`${state.PROXY}entry/${entryId}/event/${state.currentGW}/picks/`),
                        fetch(`${state.PROXY}entry/${entryId}/`),
                        fetch(`${state.PROXY}entry/${entryId}/transfers/`)
                    ]);
                    
                    const picksData = await picksRes.json();
                    const entryData = await entryRes.json();
                    const allTrans = await transRes.json();
                    const gwTrans = allTrans.filter(t => t.event === state.currentGW);

                    let html = `
                        <div class="squad-stats-bar">
                            <div class="stat-pill">FT: ${entryData.extra_free_transfers || 1}</div>
                            <div class="stat-pill">TV: £${(entryData.last_deadline_value/10).toFixed(1)}</div>
                        </div>`;

                    gwTrans.forEach(t => {
                        html += `
                            <div class="transfer-row">
                                <span class="t-out">${state.playerMap[t.element_out]?.name}</span>
                                <i class="fa-solid fa-arrow-right" style="font-size:0.5rem; color:var(--primary-blue)"></i>
                                <span class="t-in">${state.playerMap[t.element_in]?.name}</span>
                            </div>`;
                    });

                    html += `<div class="squad-scroller">`;
                    html += picksData.picks.map(p => {
                        const player = state.playerMap[p.element];
                        const pts = (state.liveData[p.element] || 0) * p.multiplier;
                        if(p.is_captain) document.getElementById(`cap-${entryId}`).textContent = player.name;
                        return `
                            <div class="player-card">
                                <img src="https://draft.premierleague.com/img/shirts/standard/shirt_${player.team}${player.pos === 1 ? '_1' : ''}-66.png" class="player-shirt">
                                <div class="player-label">${player.name}${p.is_captain ? ' (C)' : ''}</div>
                                <div class="player-pts">${pts}</div>
                            </div>`;
                    }).join('') + `</div>`;

                    squadBox.innerHTML = html;
                    squadBox.dataset.loaded = "true";
                } catch (e) { squadBox.innerHTML = "Error loading squad."; }
            }
        }

        function toggleSearch() { 
            const s = document.getElementById('search-area'); 
            s.style.display = (s.style.display === 'block') ? 'none' : 'block'; 
        }
        function togglePaidOnly() { 
            state.showingPaidOnly = !state.showingPaidOnly; 
            document.getElementById('filter-paid-btn').classList.toggle('active-filter'); 
            runFilter(); 
        }
        function runFilter() {
            const val = document.getElementById('search-input').value.toLowerCase();
            document.querySelectorAll('.manager-row').forEach(row => {
                const isPaid = row.querySelector('.status-badge').innerText === 'PAID';
                row.style.display = (row.innerText.toLowerCase().includes(val) && (!state.showingPaidOnly || isPaid)) ? 'block' : 'none';
            });
        }
        function applySort() {
            const list = document.getElementById('manager-list-container');
            const crit = document.getElementById('sort-criteria').value;
            Array.from(list.children).sort((a, b) => {
                const valA = parseInt(a.querySelector(crit === 'total' ? '.total-pts-cell' : '.gw-pts-cell').innerText.replace(/,/g, ''));
                const valB = parseInt(b.querySelector(crit === 'total' ? '.total-pts-cell' : '.gw-pts-cell').innerText.replace(/,/g, ''));
                return valB - valA;
            }).forEach(c => list.appendChild(c));
        }
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        init();
    </script>
</body>
</html>
